(()=>{var M=Object.defineProperty,U=Object.defineProperties;var O=Object.getOwnPropertyDescriptors;var q=Object.getOwnPropertySymbols;var B=Object.prototype.hasOwnProperty,Y=Object.prototype.propertyIsEnumerable;var z=(r,e,t)=>e in r?M(r,e,{enumerable:!0,configurable:!0,writable:!0,value:t}):r[e]=t,T=(r,e)=>{for(var t in e||(e={}))B.call(e,t)&&z(r,t,e[t]);if(q)for(var t of q(e))Y.call(e,t)&&z(r,t,e[t]);return r},P=(r,e)=>U(r,O(e));frappe.templates.address_list=`<div class="clearfix"></div>
{% for (const addr of addr_list) { %}
	<div class="address-box">
		<a
			href="{%= frappe.utils.get_form_link('Address', addr.name) %}"
			class="btn btn-xs btn-default edit-btn"
			title="{%= __('Edit') %}"
		>
			<svg class="icon icon-xs">
				<use href="#icon-edit"></use>
			</svg>
		</a>
		<p class="h6 flex flex-wrap">
			<span>{%= addr.address_title %}</span>
			{% if (addr.address_type !== "Other") { %}
				&nbsp;&#183;&nbsp;
				<span class="text-muted">{%= __(addr.address_type) %}</span>
			{% } %}
			{% if (addr.is_primary_address) { %}
				&nbsp;&#183;&nbsp;
				<span class="text-muted">{%= __("Primary Address") %}</span>
			{% } %}
			{% if (addr.is_shipping_address) { %}
				&nbsp;&#183;&nbsp;
				<span class="text-muted">{%= __("Shipping Address") %}</span>
			{% } %}
			{% if (addr.disabled) { %}
				&nbsp;&#183;&nbsp;
				<span class="text-muted">{%= __("Disabled") %}</span>
			{% } %}
		</p>
		<p>{%= addr.display %}</p>
	</div>
{% } %}

{% if (!addr_list.length) { %}
	<p class="text-muted small">{%= __("No address added yet.") %}</p>
{% } %}

<p>
	<button class="btn btn-xs btn-default btn-address">
		{{ __("New Address") }}
	</button>
</p>
`;frappe.templates.contact_list=`<div class="clearfix"></div>
{% for (const contact of contact_list) { %}
	<div class="address-box">
		<a
			href="{%= frappe.utils.get_form_link('Contact', contact.name) %}"
			class="btn btn-xs btn-default edit-btn"
			title="{%= __('Edit') %}"
		>
			<svg class="icon icon-xs">
				<use href="#icon-edit"></use>
			</svg>
		</a>
		<p class="h6 flex flex-wrap">
			<span>{%= contact.first_name %} {%= contact.last_name %}</span>
			{% if (contact.is_primary_contact) { %}
				&nbsp;&#183;&nbsp;
				<span class="text-muted">{%= __("Primary Contact") %}</span>
			{% } %}
			{% if (contact.is_billing_contact) { %}
				&nbsp;&#183;&nbsp;
				<span class="text-muted">{%= __("Billing Contact") %}</span>
			{% } %}
			{% if (contact.designation){ %}
				&nbsp;&#183;&nbsp;
				<span class="text-muted"> {%= contact.designation %}</span>
			{% } %}
		</p>
		{% if (contact.phone || contact.mobile_no || contact.phone_nos.length > 0) { %}
		<p>
			{% if (contact.phone) { %}
				<a href="tel:{%= frappe.utils.escape_html(contact.phone) %}">
					{%= frappe.utils.escape_html(contact.phone) %}
				</a>
				&#183;
				<span class="text-muted">{%= __("Primary Phone") %}</span>
				<br>
			{% endif %}
			{% if (contact.mobile_no) { %}
				<a href="tel:{%= frappe.utils.escape_html(contact.mobile_no) %}">
					{%= frappe.utils.escape_html(contact.mobile_no) %}
				</a>
				&#183;
				<span class="text-muted">{%= __("Primary Mobile") %}</span>
				<br>
			{% endif %}
			{% if (contact.phone_nos) { %}
				{% for (const phone_no of contact.phone_nos) { %}
					<a href="tel:{%= frappe.utils.escape_html(phone_no.phone) %}">
						{%= frappe.utils.escape_html(phone_no.phone) %}
					</a>
					<br>
				{% } %}
			{% endif %}
		</p>
		{% endif %}
		{% if (contact.email_id || contact.email_ids.length > 0) { %}
		<p>
			{% if (contact.email_id) { %}
				<a href="mailto:{%= frappe.utils.escape_html(contact.email_id) %}">
					{%= frappe.utils.escape_html(contact.email_id) %}
				</a>
				&#183;
				<span class="text-muted">{%= __("Primary Email") %}</span>
				<br>
			{% endif %}
			{% if (contact.email_ids) { %}
				{% for (const email_id of contact.email_ids) { %}
					<a href="mailto:{%= frappe.utils.escape_html(email_id.email_id) %}">
						{%= frappe.utils.escape_html(email_id.email_id) %}
					</a>
					<br>
				{% } %}
			{% endif %}
		</p>
		{% endif %}
		{% if (contact.address) { %}
		<p>
			{%= contact.address %}
		</p>
		{% endif %}
	</div>
{% } %}

{% if (!contact_list.length) { %}
	<p class="text-muted small">{%= __("No contacts added yet.") %}</p>
{% } %}

<p>
	<button class="btn btn-xs btn-default btn-contact">
		{{ __("New Contact") }}
	</button>
</p>
`;frappe.templates.form_dashboard=`<div class="form-dashboard-wrapper">
	<div class="progress-area hidden form-dashboard-section">
	</div>
	<div class="form-heatmap hidden form-dashboard-section">
		<div class="section-head">{{ __("Overview") }}</div>
		<div id="heatmap-{{ frappe.model.scrub(frm.doctype) }}" class="heatmap"></div>
		<div class="text-muted small heatmap-message hidden"></div>
	</div>
	<div class="form-graph form-dashboard-section hidden">
		<div class="section-head">{{ __("Graph") }}</div>
	</div>
	<div class="form-stats form-dashboard-section hidden">
		<div class="section-head">{{ __("Stats") }}</div>
		<div class="row"></div>
	</div>
	<div class="form-links form-dashboard-section hidden">
		<div class="section-head">{{ __("Documents") }}</div>
		<div class="transactions"></div>
	</div>
</div>`;frappe.templates.form_footer=`<div class="form-footer">
	<div class="after-save">
		<div class="comment-box"></div>
		<div class="timeline"></div>
	</div>
	<button class="scroll-to-top btn btn-default icon-btn" onclick="frappe.utils.scroll_to(0)">
		<svg class="icon icon-xs"><use href="#icon-up-line"></use></svg>
	</button>
</div>
`;frappe.templates.form_links=`<div class="form-documents">
	{% for (let i=0; i < transactions.length; i++) { %}
		{% if (i % 3 === 0) { %}
		<div class="row">
		{% } %}
			<div class="col-md-4">
				<div class="form-link-title">
					<span>{{ __(transactions[i].label) }}</span>
				</div>
				{% for (let j=0; j < transactions[i].items.length; j++) { %}
					{% let doctype = transactions[i].items[j]; %}
					<div class="document-link" data-doctype="{{ doctype }}">
						<div class="document-link-badge" data-doctype="{{ doctype }}">
							<span class="count hidden"></span>
							<a class="badge-link">{{ __(doctype) }}</a>
						</div>
						<span class="open-notification hidden"
							title="{{ __("Open {0}", [__(doctype)])}}">
						</span>
						{% if !internal_links[doctype] %}
							<button class="btn btn-new btn-secondary btn-xs icon-btn hidden"
								data-doctype="{{ doctype }}">
								<svg class="icon icon-sm"><use href="#icon-add"></use></svg>
							</button>
						{% endif %}
					</div>
				{% } %}
			</div>
		{% if (i % 3 === 2 || i === (transactions.length - 1)) { %}
		</div>
		{% } %}
	{% } %}
</div>
`;frappe.templates.form_sidebar=`<ul class="list-unstyled sidebar-menu user-actions hidden"></ul>
<ul class="list-unstyled sidebar-menu sidebar-image-section hide">
	<li class="sidebar-image-wrapper">
		<img class="sidebar-image">
		<div class="sidebar-standard-image">
			<div class="standard-image"></div>
		</div>
		{% if can_write %}
		<div class="sidebar-image-actions">
			<div class="dropdown">
				<a href="#" class="dropdown-toggle" data-toggle="dropdown">{{ __("Change") }}</a>
				<div class="dropdown-menu" role="menu">
					<a class="dropdown-item sidebar-image-change">{{ __("Upload") }}</a>
					<a class="dropdown-item sidebar-image-remove">{{ __("Remove") }}</a>
				</div>
			</div>
		</div>
		{% endif %}
	</li>
</ul>
{% if frm.meta.beta %}
<div class="sidebar-menu">
	<p><label class="indicator-pill yellow" title="{{ __("This feature is brand new and still experimental") }}">{{ __("Experimental") }}</label></p>
	<p><a class="small text-muted" href="https://github.com/frappe/{{ frappe.boot.module_app[frappe.scrub(frm.meta.module)] }}/issues/new"
			target="_blank">
		{{ __("Click here to post bugs and suggestions") }}</a></p>

</div>
{% endif %}
<ul class="list-unstyled sidebar-menu sidebar-rating hide">
	<li style="position: relative;">
		<a class="strong badge-hover">
			<span>{%= __("Feedback") %}</span>
		</a>
	</li>
	<li class="rating-icons"></li>
</ul>
<ul class="list-unstyled sidebar-menu hidden">
	{% if (frappe.help.has_help(doctype)) { %}
	<li><a class="help-link list-link" data-doctype="{{ doctype }}">{{ __("Help") }}</a></li>
	{% } %}
</ul>
<ul class="list-unstyled sidebar-menu form-assignments">
	<li>
		<span class="form-sidebar-items">
			<span class="add-assignment-label">
				<svg class="es-icon ml-0 icon-sm"><use href="#es-line-add-people"></use></svg>
				<span class="ellipsis">{%= __("Assigned To") %}</span>
			</span>
			<button class="add-assignment-btn btn btn-link icon-btn">
				<svg class="es-icon icon-sm"><use href="#es-line-add"></use></svg>
			</button>
		</span>
		<div class="assignments"></div>
	</li>
</ul>
<ul class="list-unstyled sidebar-menu form-attachments">
	<li class="attachments-actions">
		<span class="form-sidebar-items">
			<span>
				<svg class="es-icon ml-0 icon-sm">
					<use href="#es-line-attachment"></use>
				</svg>
				<a class="pill-label ellipsis explore-link">
					{%= __("Attachments") %}
				</a>
			</span>
			<button class="add-attachment-btn btn btn-link icon-btn">
				<svg class="es-icon icon-sm"><use href="#es-line-add"></use></svg>
			</button>
		</span>
	</li>
	<a class="show-all-btn hidden" href="">
		<svg class="es-icon icon-sm">
			<use href="#es-line-preview"></use>
		</svg>
		<span class="pill-label ellipsis">
			{%= __("Show All") %}
		</span>
	</a>
</ul>
<ul class="list-unstyled sidebar-menu form-reviews">
		<li class="reviews">
			<span class="form-sidebar-items">
				<span>
					<svg class="es-icon ml-0 icon-sm"><use href="#es-line-star"></use></svg>
					<span class="ellipsis">{%= __("Reviews") %}</span>
				</span>
				<button class="add-review-btn btn btn-link icon-btn">
					<svg class="es-icon icon-sm"><use href="#es-line-add"></use></svg>
				</button>
			</span>
		</li>
</ul>
<ul class="list-unstyled sidebar-menu form-tags">
		<li>
			<span class="form-sidebar-items">
				<span>
					<svg class="es-icon ml-0 icon-sm"><use href="#es-line-tag"></use></svg>
					<span class="tags-label ellipsis">{%= __("Tags") %}</span>
				</span>
			</span>
		</li>
</ul>
<ul class="list-unstyled sidebar-menu form-shared">
	<li>
		<span class="form-sidebar-items">
			<span class="share-label">
				<svg class="es-icon ml-0 icon-sm"><use href="#es-line-add-people"></use></svg>
				<span class="ellipsis">{%= __("Share") %}</span>
			</span>
			<button class="share-doc-btn btn btn-link icon-btn">
				<svg class="es-icon icon-sm"><use href="#es-line-add"></use></svg>
			</button>
		</span>
		<div class="shares"></div>
	</li>
</ul>
<ul class="list-unstyled sidebar-menu followed-by-section">
	<li class="sidebar-label followed-by-label hidden">
		<svg class="icon icon-sm">
			<use href="#icon-link-url" class="like-icon"></use>
		</svg>
		{%= __("Followed by") %}
	</li>
	<li class="followed-by"></li>
	<li class="document-follow">
		<a class="badge-hover follow-document-link hidden">
			{%= __("Follow") %}
		</a>
		<a class="badge-hover unfollow-document-link hidden">
			{%= __("Unfollow") %}
		</a>
	</li>
</ul>
<ul class="list-unstyled sidebar-menu">
	<a><li class="auto-repeat-status"><li></a>
</ul>
<ul class="list-unstyled sidebar-menu form-sidebar-stats">
	<li class="flex">
		<div class="form-stats d-flex">
			<span class="form-stats-likes">
				<span class="liked-by like-action d-flex align-items-center">
					<svg class="es-icon icon-sm">
						<use href="#es-solid-heart" class="like-icon"></use>
					</svg>
					<span class="like-count ml-2"></span>
				</span>
			</span>
			<span class="mx-2">\xB7</span>
			<a class="comments d-flex align-items-center">
				<svg class="es-icon icon-sm">
					<use href="#es-line-chat-alt" class="comment-icon"></use>
				</svg>
				<span class="comments-count ml-2"></span>
			</a>
		</div>
		<a class="form-follow text-sm">
			Follow
		</a>
	</li>
</ul>
<hr>
<!-- <ul class="list-unstyled sidebar-menu">
	<li class="liked-by-parent">
		<span class="liked-by like-action">
			<svg class="icon icon-sm">
				<use href="#icon-heart" class="like-icon"></use>
			</svg>
			<span class="likes-count"></span>
		</span>
	</li>
</ul> -->
<ul class="list-unstyled sidebar-menu text-muted">
	<li class="pageview-count"></li>
	<li class="modified-by"></li>
	<li class="created-by"></li>
</ul>
{% if(frappe.get_form_sidebar_extension) { %}
	{{ frappe.get_form_sidebar_extension() }}
{% } %}
`;frappe.templates.print_layout=`<!-- <div class="form-print-wrapper frappe-card">
	<div class="print-toolbar row">
		<div class="col-xs-3">
			<div class="flex">
				<select class="print-preview-select input-sm form-control"></select>
				<button class="btn btn-default btn-sm border print-preview-refresh" type="button">{%= __("Refresh") %}</button>
			</div>
		</div>
		<div class="col-xs-2">
			<select class="languages input-sm form-control"
				placeholder="{{ __("Language") }}"></select></div>
		<div class="col-xs-2">
			<div class="checkbox small" style="margin-top: 7px; margin-bottom: 0px;">
				<label>
					<input type="checkbox" class="print-letterhead text-muted"/>
					{%= __("Letter Head") %}</label>
			</div>
		</div>
		<div class="col-xs-5 text-right">
			<a class="close btn-print-close" style="margin-top: 2px; margin-left: 10px;">&times;</a>
			<div class="btn-group">
				<a class="btn btn-default btn-sm"
					style="border-top-right-radius:0px; border-bottom-right-radius: 0px;"
					data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
					<span>{%= __("Settings") %}</span>
					<span>
						<svg class="icon icon-xs">
							<use href="#icon-select"></use>
						</svg>
					</span>
				</a>
				<ul class="dropdown-menu print-format-dropdown" style="max-height: 300px;
					overflow-y: auto; left: auto;">
					<li><a class="dropdown-item" href="/app/Form/Print Settings">
						{%= __("Print Settings") %}</a></li>
					<li><a class="btn-printer-setting dropdown-item" style="display: none;">
						{%= __("Raw Printing Settings") %}</a></li>
					<li><a class="btn-print-edit dropdown-item">
						{%= __("Customize") %}</a></li>
				</ul>
				<a class="btn-print-preview btn-sm btn btn-default">
					{%= __("Full Page") %}</a>
				<a class="btn-download-pdf btn-sm btn btn-default">
					{%= __("PDF") %}</a>
				<a class="btn-print-print btn-sm btn btn-default">
					<strong>{%= __("Print") %}</strong></a>
			</div>
		</div>
	</div>
	<div class="print-preview-wrapper">
		<div class="print-preview">
			<div class="print-format"></div>
		</div>
		<div class="page-break-message text-muted text-center text-medium margin-top"></div>
	</div>
</div> -->
`;frappe.templates.report_links=`<div class="form-documents">
	{% for (var i=0; i < reports.length; i++) { %}
		{% if (i % 3 === 0) { %}
		<div class="row">
		{% } %}
			<div class="col-md-4">
				<div class="form-link-title">
					<span>{{ __(reports[i].label) }}</span>
				</div>
				{% for (let j=0; j < reports[i].items.length; j++) { %}
					{% let report = reports[i].items[j]; %}
					<div class="document-link" data-report="{{ report }}">
						<div class="report-link-badge" data-report="{{ report }}">
							<a class="report-link">{{ __(report) }}</a>
						</div>
					</div>
				{% } %}
			</div>
		{% if (i % 3 === 2 || i === (reports.length - 1)) { %}
		</div>
		{% } %}
	{% } %}
</div>
`;frappe.templates.set_sharing=`<div>
	<div class="row">
		<div class="col-xs-4"><h6>{%= __("User") %}</h6></div>
		<div class="col-xs-2 flex justify-center align-center"><h6>{%= __("Can Read") %}</h6></div>
		<div class="col-xs-2 flex justify-center align-center"><h6>{%= __("Can Write") %}</h6></div>
		<div class="col-xs-2 flex justify-center align-center"><h6>{%= __("Can Submit") %}</h6></div>
		<div class="col-xs-2 flex justify-center align-center"><h6>{%= __("Can Share") %}</h6></div>
	</div>

	<div class="row shared-user" data-everyone=1>
		<div class="col-xs-4 share-all"><b>{{ __("Everyone") }}</b></div>
		<div class="col-xs-2 flex justify-center align-center"><input type="checkbox" name="read"
			{% if(cint(everyone.read)) { %}checked{% } %} class="edit-share"></div>
		<div class="col-xs-2 flex justify-center align-center"><input type="checkbox" name="write"
			class="edit-share"
			{% if(cint(everyone.write)) { %}checked{% } %}
			{% if (!frm.perm[0].write){ %} disabled="disabled"{% } %}>
		</div>
		<div class="col-xs-2 flex justify-center align-center"><input type="checkbox" name="submit"
			class="edit-share"
			{% if(cint(everyone.submit)) { %}checked{% } %}
			{% if (!frm.perm[0].submit){ %} disabled="disabled"{% } %}>
		</div>
		<div class="col-xs-2 flex justify-center align-center"><input type="checkbox" name="share"
			{% if(cint(everyone.share)) { %}checked{% } %} class="edit-share"></div>
	</div>

	{% for (var i=0, l=shared.length; i < l; i++) {
		var s = shared[i]; %}
		{% if(s && !s.everyone) { %}
		<div class="row shared-user" data-user="{%= s.user %}" data-name="{%= s.name %}">
			<div class="col-xs-4">{%= s.user %}</div>
			<div class="col-xs-2 flex justify-center align-center"><input type="checkbox" name="read"
				{% if(cint(s.read)) { %}checked{% } %} class="edit-share"></div>
			<div class="col-xs-2 flex justify-center align-center"><input type="checkbox" name="write"
				{% if(cint(s.write)) { %}checked{% } %} class="edit-share"{% if (!frm.perm[0].write){ %} disabled="disabled"{% } %}></div>
			<div class="col-xs-2 flex justify-center align-center"><input type="checkbox" name="submit"
				{% if(cint(s.submit)) { %}checked{% } %} class="edit-share"{% if (!frm.perm[0].submit){ %} disabled="disabled"{% } %}></div>
			<div class="col-xs-2 flex justify-center align-center"><input type="checkbox" name="share"
				{% if(cint(s.share)) { %}checked{% } %} class="edit-share"></div>
		</div>
		{% } %}
	{% } %}

	{% if(frappe.model.can_share(null, frm)) { %}
	<hr>

	<div class="row">
		<div class="col-xs-4"><h6>{%= __("Share this document with") %}</h6></div>
		<div class="col-xs-2 flex justify-center align-center"><h6>{%= __("Can Read") %}</h6></div>
		<div class="col-xs-2 flex justify-center align-center"><h6>{%= __("Can Write") %}</h6></div>
		<div class="col-xs-2 flex justify-center align-center"><h6>{%= __("Can Submit") %}</h6></div>
		<div class="col-xs-2 flex justify-center align-center"><h6>{%= __("Can Share") %}</h6></div>
	</div>

	<div class="row">
		<div class="col-xs-4 input-wrapper-add-share"></div>
		<div class="col-xs-2 flex justify-center align-flex-start mt-2"><input type="checkbox" class="add-share-read" name="read"></div>
		<div class="col-xs-2 flex justify-center align-flex-start mt-2"><input type="checkbox" class="add-share-write" name="write"
			{% if (!frm.perm[0].write){ %} disabled="disabled"{% } %}>
		</div>
		<div class="col-xs-2 flex justify-center align-flex-start mt-2"><input type="checkbox" class="add-share-submit" name="submit"
			{% if (!frm.perm[0].submit){ %} disabled="disabled"{% } %}>
		</div>
		<div class="col-xs-2 flex justify-center align-flex-start mt-2"><input type="checkbox" class="add-share-share" name="share"></div>
	</div>
	<div>
		<button class="btn btn-primary btn-sm btn-add-share mt-3">{{ __("Add") }}</button>
	</div>
	{% endif %}
</div>`;frappe.templates.timeline_message_box=`<div class="timeline-message-box" data-communication-type="{{ doc.communication_type }}">
	<span class="flex justify-between m-1 mb-3">
		<span class="text-color flex">
			{% if (doc.communication_type && doc.communication_type == "Automated Message") { %}
				<span>
					<!-- Display maximum of 3 users-->
					{{ __("Notification sent to") }}
					{% var recipients = (doc.recipients && doc.recipients.split(",")) || [] %}
					{% var cc = (doc.cc && doc.cc.split(",")) || [] %}
					{% var bcc = (doc.bcc && doc.bcc.split(",")) || [] %}
					{% var emails = recipients.concat(cc, bcc) %}
					{% var display_emails_len = Math.min(emails.length, 3) %}

					{% for (var i=0, len=display_emails_len; i<len; i++) { var email = emails[i]; %}
						{{ frappe.user_info(email).fullname || email }}
						{% if (len > i+1) { %}
							{{ "," }}
						{% } %}
					{% } %}

					{% if (emails.length > display_emails_len) { %}
						{{ "..." }}
					{% } %}

					<div class="text-muted">
						{{ comment_when(doc.creation) }}
					</div>
				</span>
			{% } else if (doc.comment_type && doc.comment_type == "Comment") { %}
				<span>
					{{ frappe.avatar(doc.owner, "avatar-medium") }}
					<span class="ml-2" style="font-size: var(--text-base);">{{ doc.user_full_name || frappe.user.full_name(doc.owner) }}</span>
					<span class="text-muted">{{ __("commented") }}</span>
					<span> . </span>
					<span class="margin-left text-muted">
						{{ comment_when(doc.creation) }}
					</span>
				</span>
			{% } else { %}
				<span class="margin-right">
					{{ frappe.avatar(doc.owner, "avatar-medium") }}
				</span>
				<div>
					{{ doc.user_full_name || frappe.user.full_name(doc.owner) }}
					<span> . </span>
					<span class="text-muted">
						{{ comment_when(doc.creation) }}
					</span>
					{% if (doc.subject) { %}
						<div class="text-muted my-1">{{doc.subject}}</div>
					{% } %}
				</div>
			{% } %}
		</span>
		<span class="actions" style="flex-shrink: 0">
			{% if (doc._doc_status && doc._doc_status_indicator) { %}
			<span class="indicator-pill {%= doc._doc_status_indicator %}"
				title="{%= __(doc._doc_status) %}"
				style="order: -1">
				<span class="hidden-xs small">
					{%= __(doc._doc_status) %}
				</span>
			</span>
			{% } %}

			{% if (doc._url) { %}
			<a class="action-btn" href="{{ doc._url }}" title="{{ __("Open Communication") }}">
				<svg class="es-icon icon-sm">
					<use href="#es-line-link"></use>
				</svg>
			</a>
			{% } %}
			<div class="custom-actions"></div>
			<div class="more-actions">
				<a type="button" class="action-btn"
					data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
					<svg class="icon icon-sm">
						<use href="#icon-dot-horizontal"></use>
					</svg>
				</a>
				<ul class="dropdown-menu small">
					<li>
						<a class="dropdown-item" data-action="copy_link">{{ __('Copy Link') }}</a>
					</li>
				</ul>
			</div>
		</span>
	</span>
	<div class="content">
		{{ doc.content }}
	</div>
	{% if (doc.attachments && doc.attachments.length) { %}
	<div style="margin-top: 10px">
	{% $.each(doc.attachments, function(i, a) { %}
	<div class="ellipsis flex">
		<a href="{%= encodeURI(a.file_url).replace(/#/g, '%23') %}"
			class="text-muted small" target="_blank" rel="noopener noreferrer">
			<svg viewBox="0 0 16 16" class="icon icon-xs" xmlns="http://www.w3.org/2000/svg">
				<path d="M14 7.66625L8.68679 12.8875C7.17736 14.3708 4.64151 14.3708 3.13208 12.8875C1.62264 11.4042 1.62264 8.91224 3.13208 7.42892L7.84151 2.80099C8.9283 1.733 10.6189 1.733 11.7057 2.80099C12.7925 3.86897 12.7925 5.53028 11.7057 6.59827L7.35849 10.8109C6.75472 11.4042 5.78868 11.4042 5.24528 10.8109C4.64151 10.2176 4.64151 9.26823 5.24528 8.73424L8.86792 5.17429" stroke="currentColor" stroke-miterlimit="10" stroke-linecap="round"/>
			</svg>
			{%= a.file_url.split("/").slice(-1)[0] %}
			{% if (a.is_private) { %}
				<svg class="icon icon-xs" style="color: var(--yellow-300)"
					xmlns="http://www.w3.org/2000/svg" viewBox="0 0 16 16">
					<path fill-rule="evenodd" clip-rule="evenodd" d="M8.077 1.45h-.055a3.356 3.356 0 00-3.387 3.322v.35H3.75a2 2 0 00-2 2v5.391a2 2 0 002 2h8.539a2 2 0 002-2V7.122a2 2 0 00-2-2h-.885v-.285A3.356 3.356 0 008.082 1.45h-.005zm2.327 3.672V4.83a2.356 2.356 0 00-2.33-2.38h-.06a2.356 2.356 0 00-2.38 2.33v.342h4.77zm-6.654 1a1 1 0 00-1 1v5.391a1 1 0 001 1h8.539a1 1 0 001-1V7.122a1 1 0 00-1-1H3.75zm4.27 4.269a.573.573 0 100-1.147.573.573 0 000 1.147zm1.573-.574a1.573 1.573 0 11-3.147 0 1.573 1.573 0 013.147 0z" fill="currentColor" stroke="currentColor"></path>
				</svg>
			{% } %}
		</a>
	</div>
	{% }); %}
	</div>
	{% } %}
</div>
`;frappe.templates.users_in_sidebar=`{% for (var i=0, l=users.length; i < l; i++) {
	var u = users[i];
%}
	<span class="avatar avatar-small {{ u.avatar_class || "" }}" title="{{ u.title }}">
	{% if (u.icon) { %}
		<i class="{{ u.icon }}"></i>
	{% } else if(u.image) { %}
		<img class="media-object" src="{{ u.image }}" alt="{{ u.fullname }}">
	{% } else { %}
		<div class="standard-image" style="background-color: {{ u.color }};">{{ u.abbr.substr(0,1) }}</div>
	{% } %}
	</span>
{% } %}
`;frappe.provide("frappe.views.formview");frappe.views.FormFactory=class extends frappe.views.Factory{make(e){var t=e[1],i=frappe.router.doctype_layout||t;frappe.views.formview[i]?this.show_doc(e):frappe.model.with_doctype(t,()=>{this.page=frappe.container.add_page(i),frappe.views.formview[i]=this.page,this.make_and_show(t,e)}),this.setup_events()}make_and_show(e,t){frappe.router.doctype_layout?frappe.model.with_doc("DocType Layout",frappe.router.doctype_layout,()=>{this.make_form(e),this.show_doc(t)}):(this.make_form(e),this.show_doc(t))}make_form(e){this.page.frm=new frappe.ui.form.Form(e,this.page,!0,frappe.router.doctype_layout)}setup_events(){this.initialized||$(document).on("page-change",function(){frappe.ui.form.close_grid_form()}),this.initialized=!0}show_doc(e){var t=e[1],i=frappe.router.doctype_layout||t,s=e.slice(2).join("/");if(frappe.model.new_names[s]){s=frappe.model.new_names[s],frappe.set_route("Form",i,s);return}let a=frappe.get_doc(t,s);a&&frappe.model.get_docinfo(t,s)&&(a.__islocal||frappe.model.is_fresh(a))?this.render(i,s):this.fetch_and_render(t,s,i)}fetch_and_render(e,t,i){frappe.model.with_doc(e,t,(s,a)=>{if(!(a&&a[403])){if(!(locals[e]&&locals[e][s])){s&&s.substr(0,3)==="new"?this.render_new_doc(e,s,i):frappe.show_not_found();return}this.render(i,s)}})}render_new_doc(e,t,i){let s=frappe.model.make_new_doc_and_get_name(e,!0);s===t?this.render(i,t):(frappe.route_flags.replace_route=!0,frappe.set_route("Form",i,s))}render(e,t){frappe.container.change_to(e),frappe.views.formview[e].frm.refresh(t)}};frappe.provide("frappe.ui.form");frappe.quick_edit=function(r,e){frappe.db.get_doc(r,e).then(t=>{frappe.ui.form.make_quick_entry(r,null,null,t)})};frappe.ui.form.make_quick_entry=(r,e,t,i,s)=>{var a=r.replace(/ /g,""),n="QuickEntryForm";return frappe.ui.form[a+"QuickEntryForm"]&&(n=a+"QuickEntryForm"),frappe.quick_entry=new frappe.ui.form[n](r,e,t,i,s),frappe.quick_entry.setup()};frappe.ui.form.QuickEntryForm=class{constructor(e,t,i,s,a){this.doctype=e,this.after_insert=t,this.init_callback=i,this.doc=s,this.force=a||!1}setup(){return new Promise(e=>{frappe.model.with_doctype(this.doctype,()=>{this.check_quick_entry_doc(),this.set_meta_and_mandatory_fields(),this.is_quick_entry()||this.force?(this.render_dialog(),e(this)):(frappe.quick_entry=null,frappe.set_route("Form",this.doctype,this.doc.name).then(()=>e(this)),this.init_callback&&this.init_callback(this.doc))})})}set_meta_and_mandatory_fields(){this.meta=frappe.get_meta(this.doctype);let e=this.meta.fields;this.mandatory=e.filter(t=>(t.reqd||t.allow_in_quick_entry)&&!t.read_only&&!t.is_virtual)}check_quick_entry_doc(){this.doc||(this.doc=frappe.model.get_new_doc(this.doctype,null,null,!0))}is_quick_entry(){return!(this.meta.quick_entry!=1||(this.validate_for_prompt_autoname(),this.has_child_table()||!this.mandatory.length))}too_many_mandatory_fields(){return this.mandatory.length>7}has_child_table(){return!!$.map(this.mandatory,function(e){return e.fieldtype==="Table"?e:null}).length}validate_for_prompt_autoname(){this.meta.autoname&&this.meta.autoname.toLowerCase()==="prompt"&&(this.mandatory=[{fieldname:"__newname",label:__("{0} Name",[__(this.meta.name)]),reqd:1,fieldtype:"Data"}].concat(this.mandatory))}render_dialog(){var e=this;this.dialog=new frappe.ui.Dialog({title:__("New {0}",[__(this.doctype)]),fields:this.mandatory,doc:this.doc}),this.register_primary_action(),!this.force&&this.render_edit_in_full_page_link(),this.dialog.wrapper.keydown(function(t){if((t.ctrlKey||t.metaKey)&&t.which==13&&!frappe.request.ajax_count)return e.dialog.get_primary_btn().trigger("click"),t.preventDefault(),!1}),this.dialog.onhide=()=>frappe.quick_entry=null,this.dialog.show(),this.dialog.refresh_dependency(),this.set_defaults(),this.init_callback&&this.init_callback(this.dialog)}register_primary_action(){var e=this;this.dialog.set_primary_action(__("Save"),function(){if(!e.dialog.working){var t=e.dialog.get_values();t&&(e.dialog.working=!0,e.dialog.set_message(__("Saving...")),e.insert().then(()=>{e.dialog.clear_message()}))}})}insert(){let e=this;return new Promise(t=>{e.update_doc(),frappe.call({method:"frappe.client.save",args:{doc:e.dialog.doc},callback:function(i){frappe.model.is_submittable(e.doctype)?frappe.run_serially([()=>e.dialog.working=!0,()=>{e.dialog.set_primary_action(__("Submit"),function(){e.submit(i.message)})}]):(e.dialog.hide(),frappe.model.clear_doc(e.dialog.doc.doctype,e.dialog.doc.name),e.dialog.doc=i.message,frappe._from_link?frappe.ui.form.update_calling_link(e.dialog.doc):e.after_insert?e.after_insert(e.dialog.doc):e.open_form_if_not_list())},error:function(){e.skip_redirect_on_error||e.open_doc(!0)},always:function(){e.dialog.working=!1,t(e.dialog.doc)},freeze:!0})})}submit(e){var t=this;frappe.call({method:"frappe.client.submit",args:{doc:e},callback:function(i){t.dialog.hide(),frappe.model.clear_doc(t.dialog.doc.doctype,t.dialog.doc.name),t.dialog.doc=i.message,frappe._from_link?frappe.ui.form.update_calling_link(t.dialog.doc):t.after_insert?t.after_insert(t.dialog.doc):t.open_form_if_not_list(),cur_frm&&cur_frm.reload_doc()}})}open_form_if_not_list(){let e=frappe.get_route(),t=this.dialog.doc;e&&!(e[0]==="List"&&e[1]===t.doctype)&&frappe.run_serially([()=>frappe.set_route("Form",t.doctype,t.name)])}update_doc(){var e=this,t=this.dialog.get_values(!0);return $.each(t,function(i,s){is_null(s)||(e.dialog.doc[i]=s)}),this.dialog.doc}open_doc(e){this.dialog.hide(),this.update_doc(),e&&this.after_insert&&(frappe.route_options=frappe.route_options||{},frappe.route_options.after_save=t=>{this.after_insert(t)}),frappe.set_route("Form",this.doctype,this.doc.name)}render_edit_in_full_page_link(){var e=this;this.dialog.add_custom_action(__("Edit Full Form"),()=>e.open_doc(!0))}set_defaults(){var e=this;$.each(this.dialog.fields_dict,function(t,i){i.doctype=e.doc.doctype,i.docname=e.doc.name,is_null(e.doc[t])||i.set_input(e.doc[t])})}};frappe.ui.form.LinkedWith=class{constructor(e){$.extend(this,e)}show(){this.dialog||this.make_dialog(),$(this.dialog.body).html(`<div class="text-muted text-center" style="padding: 30px 0px">
				${__("Loading")}...
			</div>`),this.dialog.show()}make_dialog(){this.dialog=new frappe.ui.Dialog({title:__("Linked With")}),this.dialog.on_page_show=()=>{frappe.xcall("frappe.desk.form.linked_with.get",{doctype:this.frm.doctype,docname:this.frm.docname}).then(e=>{this.frm.__linked_docs=e}).then(()=>this.make_html())}}make_html(){let e="",t=this.frm.__linked_docs,i=Object.keys(t);i.length===0?e=__("Not Linked to any record"):e=i.map(s=>{let a=t[s];return`
					<div class="list-item-table margin-bottom">
						${this.make_doc_head(s)}
						${a.map(n=>this.make_doc_row(n,s)).join("")}
					</div>
				`}).join(""),$(this.dialog.body).html(e)}make_doc_head(e){return`
			<header class="level list-row list-row-head text-muted small">
				<div>${__(e)}</div>
			</header>
		`}make_doc_row(e,t){return`<div class="list-row-container">
			<div class="level list-row small">
				<div class="level-left bold">
					<a href="/app/${frappe.router.slug(t)}/${e.name}">${e.name}</a>
				</div>
			</div>
		</div>`}};frappe.ui.form.FormViewers=class{constructor({frm:e,parent:t}){this.frm=e,this.parent=t,this.parent.tooltip({title:__("Currently Viewing")}),this._past_users={},this._active_users={},this.setup_events()}get past_users(){var e,t;return this._past_users[(t=(e=this.frm)==null?void 0:e.doc)==null?void 0:t.name]||[]}set past_users(e){var i,s;let t=(s=(i=this.frm)==null?void 0:i.doc)==null?void 0:s.name;!t||(this._past_users[t]=e)}get active_users(){var e,t;return this._active_users[(t=(e=this.frm)==null?void 0:e.doc)==null?void 0:t.name]||[]}set active_users(e){var i,s;let t=(s=(i=this.frm)==null?void 0:i.doc)==null?void 0:s.name;!t||(this._active_users[t]=e)}refresh(){if(!this.active_users.length){this.parent.empty();return}let e=frappe.avatar_group(this.active_users,5,{align:"left",overlap:!0});this.parent.empty().append(e)}setup_events(){let e=this;frappe.realtime.off("doc_viewers"),frappe.realtime.on("doc_viewers",function(t){e.update_users(t)})}async update_users({doctype:e,docname:t,users:i=[]}){var o,l,d,_;i=i.filter(c=>c!=frappe.session.user);let s=i.filter(c=>!this.past_users.includes(c)),a=this.past_users.filter(c=>!i.includes(c));[...s,...a].length!==0&&(await this.fetch_user_info(i),this.active_users=i,this.past_users=i,((l=(o=this.frm)==null?void 0:o.doc)==null?void 0:l.doctype)===e&&((_=(d=this.frm)==null?void 0:d.doc)==null?void 0:_.name)==t&&this.refresh())}async fetch_user_info(e){let t=[];for(let s of e)frappe.boot.user_info[s]||t.push(s);if(!t.length)return;let i=await frappe.xcall("frappe.desk.form.load.get_user_info_for_viewers",{users:t});Object.assign(frappe.boot.user_info,i)}};var A=class{constructor({frm:e}){this.frm=e}show(){let e=this;this.dialog=new frappe.ui.Dialog({title:__("Create a Reminder"),fields:[{fieldtype:"Select",label:__("Remind Me In"),fieldname:"remind_me_in",options:[{label:__("30 minutes"),value:"30_minutes"},{label:__("1 hour"),value:"1_hour"},{label:__("4 hours"),value:"4_hours"},{label:__("1 Day"),value:"1_day"},{label:__("Custom"),value:"custom"}],default:"1_hour",onchange:()=>{e._update_datetime_selector()}},{fieldtype:"Column Break",fieldname:"col_break_1"},{fieldtype:"Datetime",label:__("Remind At"),fieldname:"remind_at",reqd:1,read_only:1},{fieldtype:"Section Break",fieldname:"divider_between_message_and_time"},{fieldtype:"Small Text",label:__("Description"),fieldname:"description",reqd:1}],primary_action_label:__("Create"),primary_action:()=>{this.create_reminder(),this.dialog.hide()},secondary_action_label:__("Cancel"),secondary_action:()=>{this.dialog.hide()}}),this._update_datetime_selector(),this.dialog.show()}_update_datetime_selector(){var e;this._convert_period_to_absolute_time(),this.dialog.fields_dict.remind_at.df.read_only=this.dialog.get_value("remind_me_in")!="custom",this.dialog.fields_dict.remind_at.refresh(),(e=this.dialog.fields_dict.remind_at.datepicker)==null||e.update({minDate:frappe.datetime.str_to_obj(frappe.datetime.now_datetime())})}_convert_period_to_absolute_time(){let e=this.dialog.get_value("remind_me_in");if(!e||e=="custom")return;let t=frappe.datetime.str_to_obj(frappe.datetime.now_datetime()),[i,s]=e.split("_"),a=moment(t).add(i,s).format(frappe.defaultDatetimeFormat);this.dialog.set_value("remind_at",a)}create_reminder(){var e,t;frappe.xcall("frappe.automation.doctype.reminder.reminder.create_new_reminder",{remind_at:this.dialog.get_value("remind_at"),description:this.dialog.get_value("description"),reminder_doctype:(e=this.frm)==null?void 0:e.doc.doctype,reminder_docname:(t=this.frm)==null?void 0:t.doc.name}).then(i=>{frappe.show_alert(__("Reminder set at {0}",[frappe.datetime.str_to_user(i.remind_at)]))})}};frappe.ui.form.Toolbar=class{constructor(e){$.extend(this,e),this.refresh(),this.add_update_button_on_dirty(),this.setup_editable_title()}refresh(){this.make_menu(),this.set_title(),this.page.clear_user_actions(),this.show_title_as_dirty(),this.set_primary_action(),this.frm.meta.hide_toolbar?this.page.hide_menu():this.frm.doc.__islocal?(this.page.hide_menu(),this.print_icon&&this.print_icon.addClass("hide")):(this.page.show_menu(),this.print_icon&&this.print_icon.removeClass("hide"))}set_title(){let e;if(this.frm.is_new())e=__("New {0}",[__(this.frm.meta.name)]);else if(this.frm.meta.title_field){let i=(this.frm.doc[this.frm.meta.title_field]||"").toString().trim();e=strip_html(i||this.frm.docname),this.frm.doc.__islocal||e===this.frm.docname||this.frm.meta.autoname==="hash"?this.page.set_title_sub(""):(this.page.set_title_sub(this.frm.docname),this.page.$sub_title_area.css("cursor","copy"),this.page.$sub_title_area.on("click",s=>{s.stopImmediatePropagation(),frappe.utils.copy_to_clipboard(this.frm.docname)}))}else e=this.frm.docname;var t=this;e=__(e),this.page.set_title(e),this.frm.meta.title_field&&frappe.utils.set_title(e+" - "+this.frm.docname),this.page.$title_area.toggleClass("editable-title",!!(this.is_title_editable()||this.can_rename())),this.set_indicator()}is_title_editable(){let e=this.frm.meta.title_field,t=this.frm.get_docfield(e);return!!(e&&this.frm.perm[0].write&&!this.frm.doc.__islocal&&t.fieldtype==="Data"&&!t.read_only)}can_rename(){return this.frm.perm[0].write&&this.frm.meta.allow_rename&&!this.frm.doc.__islocal}show_unchanged_document_alert(){frappe.show_alert({indicator:"info",message:__("Unchanged")})}rename_document_title(e,t,i=!1){let s=null,a=this.frm.doc.name,n=this.frm.meta.title_field||"",o=this.frm.doctype,l;if(this.frm.__rename_queue&&(l=this.frm.__rename_queue),e){let _=__("This cannot be undone");s=`${__("Are you sure you want to merge {0} with {1}?",[a.bold(),e.bold()])}<br><b>${_}<b>`}let d=()=>(e!=a&&frappe.realtime.doctype_subscribe(o,e),frappe.xcall("frappe.model.rename_doc.update_document_title",{doctype:o,docname:a,name:e,title:t,enqueue:!0,merge:i,freeze:!0,freeze_message:__("Updating related fields..."),queue:l}).then(_=>{let c=u=>{$(document).trigger("rename",[o,a,u]),locals[o]&&locals[o][a]&&delete locals[o][a],this.frm.reload_doc()};e!=a&&(frappe.realtime.on("list_update",u=>{u.doctype==o&&u.name==e&&(c(e),frappe.show_alert({message:__("Document renamed from {0} to {1}",[a.bold(),e.bold()]),indicator:"success"}))}),frappe.show_alert(__("Document renaming from {0} to {1} has been queued",[a.bold(),e.bold()]))),e&&(_||e)!=a&&c(_||e)}));return new Promise((_,c)=>{t===this.frm.doc[n]&&e===a?(this.show_unchanged_document_alert(),_()):i?frappe.confirm(s,()=>{d().then(_).catch(c)},c):d().then(_).catch(c)})}setup_editable_title(){let e=this;this.page.$title_area.find(".title-text").on("click",()=>{let t=[],i=e.frm.doc.name,s=e.frm.meta.title_field||"";if(e.is_title_editable()){let a=e.frm.get_docfield(s).label;t.push({label:__("New {0}",[__(a)]),fieldname:"title",fieldtype:"Data",reqd:1,default:e.frm.doc[s]})}if(e.can_rename()){let a=__("New Name");if(e.frm.meta.autoname&&e.frm.meta.autoname.startsWith("field:")){let n=e.frm.meta.autoname.split(":")[1];a=__("New {0}",[e.frm.get_docfield(n).label])}t.push({label:a,fieldname:"name",fieldtype:"Data",reqd:1,default:i},{label:__("Merge with existing"),fieldname:"merge",fieldtype:"Check",default:0})}if(t.length>0){let a=new frappe.ui.Dialog({title:__("Rename"),fields:t});a.show(),a.set_primary_action(__("Rename"),n=>{a.disable_primary_action(),a.hide(),this.rename_document_title(n.name,n.title,n.merge).then(()=>{a.hide()}).catch(()=>{a.enable_primary_action()})})}})}get_dropdown_menu(e){return this.page.add_dropdown(e)}set_indicator(){var e=frappe.get_indicator(this.frm.doc);this.frm.save_disabled&&e&&[__("Saved"),__("Not Saved")].includes(e[0])||(e?this.page.set_indicator(e[0],e[1]):this.page.clear_indicator())}make_menu(){this.page.clear_icons(),this.page.clear_menu(),frappe.boot.desk_settings.form_sidebar&&(this.make_navigation(),this.make_menu_items())}make_navigation(){!this.frm.is_new()&&!this.frm.meta.issingle&&(this.page.add_action_icon("es-line-left-chevron",()=>{this.frm.navigate_records(1)},"prev-doc",__("Previous Document")),this.page.add_action_icon("es-line-right-chevron",()=>{this.frm.navigate_records(0)},"next-doc",__("Next Document")))}make_menu_items(){let e=this,t=this.frm.perm[0],i=cint(this.frm.doc.docstatus),s=frappe.model.is_submittable(this.frm.doc.doctype),a=frappe.model.get_doc(":Print Settings","Print Settings"),n=cint(a.allow_print_for_draft),o=cint(a.allow_print_for_cancelled);(!s||i==1||o&&i==2||n&&i==0)&&frappe.model.can_print(null,e.frm)&&!this.frm.meta.issingle&&(this.page.add_menu_item(__("Print"),function(){e.frm.print_doc()},!0),this.print_icon=this.page.add_action_icon("printer",function(){e.frm.print_doc()},"",__("Print"))),frappe.model.can_email(null,e.frm)&&e.frm.doc.docstatus<2&&this.page.add_menu_item(__("Email"),function(){e.frm.email_doc()},!0,{shortcut:"Ctrl+E",condition:()=>!this.frm.is_new()}),this.page.add_menu_item(__("Jump to field"),function(){e.show_jump_to_field_dialog()},!0,"Ctrl+J"),e.frm.meta.issingle||this.page.add_menu_item(__("Links"),function(){e.show_linked_with()},!0),frappe.boot.user.can_create.includes(e.frm.doctype)&&!e.frm.meta.allow_copy&&this.page.add_menu_item(__("Duplicate"),function(){e.frm.copy_doc()},!0,"Shift+D"),this.page.add_menu_item(__("Copy to Clipboard"),function(){frappe.utils.copy_to_clipboard(JSON.stringify(e.frm.doc))},!0),this.can_rename()&&this.page.add_menu_item(__("Rename"),function(){e.frm.rename_doc()},!0),this.page.add_menu_item(__("Reload"),function(){e.frm.reload_doc()},!0),cint(e.frm.doc.docstatus)!=1&&!e.frm.doc.__islocal&&!frappe.model.is_single(e.frm.doctype)&&frappe.model.can_delete(e.frm.doctype)&&this.page.add_menu_item(__("Delete"),function(){e.frm.savetrash()},!0,{shortcut:"Shift+Ctrl+D",condition:()=>!this.frm.is_new()}),this.page.add_menu_item(__("Remind Me"),()=>{new A({frm:this.frm}).show()},!0,{shortcut:"Shift+R",condition:()=>!this.frm.is_new()}),this.page.add_menu_item(__("Undo"),()=>{this.frm.undo_manager.undo()},!0,{shortcut:"ctrl+z",condition:()=>!this.frm.is_form_builder(),description:__("Undo last action")}),this.page.add_menu_item(__("Redo"),()=>{this.frm.undo_manager.redo()},!0,{shortcut:"ctrl+y",condition:()=>!this.frm.is_form_builder(),description:__("Redo last action")}),this.make_customize_buttons(),this.can_repeat()&&this.page.add_menu_item(__("Repeat"),function(){frappe.utils.new_auto_repeat_prompt(e.frm)},!0),t[CREATE]&&!this.frm.meta.issingle&&!this.frm.meta.in_create&&this.page.add_menu_item(__("New {0}",[__(e.frm.doctype)]),function(){frappe.new_doc(e.frm.doctype,!0)},!0,{shortcut:"Ctrl+B",condition:()=>!this.frm.is_new()})}make_customize_buttons(){let e=this.frm.doctype==="DocType";if(frappe.model.can_create("Custom Field")&&frappe.model.can_create("Property Setter")){let t=e?this.frm.docname:this.frm.doctype,i=e?this.frm.doc.custom:!1;t!="DocType"&&!i&&this.frm.meta.issingle===0&&this.page.add_menu_item(__("Customize"),()=>{this.frm.meta&&this.frm.meta.custom?frappe.set_route("Form","DocType",t):frappe.set_route("Form","Customize Form",{doc_type:t})},!0)}frappe.model.can_create("DocType")&&frappe.boot.developer_mode===1&&!e&&this.page.add_menu_item(__("Edit DocType"),()=>{frappe.set_route("Form","DocType",this.frm.doctype)},!0)}can_repeat(){return this.frm.meta.allow_auto_repeat&&!this.frm.is_new()&&!this.frm.doc.auto_repeat}can_save(){return this.get_docstatus()===0}can_submit(){return this.get_docstatus()===0&&!this.frm.doc.__islocal&&!this.frm.doc.__unsaved&&this.frm.perm[0].submit&&!this.has_workflow()}can_update(){return this.get_docstatus()===1&&!this.frm.doc.__islocal&&this.frm.perm[0].submit&&this.frm.doc.__unsaved}can_cancel(){return this.get_docstatus()===1&&this.frm.perm[0].cancel&&!this.read_only}can_amend(){return this.get_docstatus()===2&&this.frm.perm[0].amend&&!this.read_only}has_workflow(){return this._has_workflow===void 0&&(this._has_workflow=frappe.get_list("Workflow",{document_type:this.frm.doctype}).length),this._has_workflow}get_docstatus(){return cint(this.frm.doc.docstatus)}show_linked_with(){this.frm.linked_with||(this.frm.linked_with=new frappe.ui.form.LinkedWith({frm:this.frm})),this.frm.linked_with.show()}set_primary_action(e){e||this.page.clear_user_actions();var t=this.get_action_status();if(t)if(t!==this.current_status&&t==="Amend"){let i=this.frm.doc;frappe.xcall("frappe.client.is_document_amended",{doctype:i.doctype,docname:i.name}).then(s=>{if(s){this.page.clear_actions();return}this.set_page_actions(t)})}else this.set_page_actions(t);else this.page.clear_actions(),this.current_status=null}get_action_status(){var e=null;return this.frm.page.current_view_name==="print"||this.frm.hidden?e="Edit":this.can_submit()?e="Submit":this.can_save()?this.frm.save_disabled||(!this.has_workflow()||this.frm.doc.__unsaved)&&(e="Save"):this.can_update()?e="Update":this.can_cancel()?e="Cancel":this.can_amend()&&(e="Amend"),e}set_page_actions(e){var t=this;if(this.page.clear_actions(),e!=="Edit"){var i=this.frm.action_perm_type_map[e];if(!this.frm.perm[0][i])return}if(e==="Edit")this.page.set_primary_action(__("Edit"),function(){t.frm.page.set_view("main")},"edit");else if(e==="Cancel"){let n=()=>{this.page.set_secondary_action(__(e),function(){t.frm.savecancel(this)})};this.has_workflow()?frappe.xcall("frappe.model.workflow.can_cancel_document",{doctype:this.frm.doc.doctype}).then(o=>{o&&n()}):n()}else{var s={Save:function(){return t.frm.save("Save",null,this)},Submit:function(){return t.frm.savesubmit(this)},Update:function(){return t.frm.save("Update",null,this)},Amend:function(){return t.frm.amend_doc()}}[e],a={Update:"edit"}[e];this.page.set_primary_action(__(e),s,a)}this.current_status=e}add_update_button_on_dirty(){var e=this;$(this.frm.wrapper).on("dirty",function(){e.show_title_as_dirty(),e.frm.page.clear_actions_menu(),e.frm.save_disabled||e.set_primary_action(!0)})}show_title_as_dirty(){this.frm.save_disabled&&!this.frm.set_dirty||(this.frm.is_dirty()&&this.page.set_indicator(__("Not Saved"),"orange"),$(this.frm.wrapper).attr("data-state",this.frm.is_dirty()?"dirty":"clean"))}show_jump_to_field_dialog(){let e=s=>!["Section Break","Column Break","Tab Break"].includes(s.df.fieldtype)&&!s.df.hidden&&s.disp_status!=="None",t=this.frm.fields.filter(e).map(s=>({label:__(s.df.label),value:s.df.fieldname})),i=new frappe.ui.Dialog({title:__("Jump to field"),fields:[{fieldtype:"Autocomplete",fieldname:"fieldname",label:__("Select Field"),options:t,reqd:1}],primary_action_label:__("Go"),primary_action:({fieldname:s})=>{i.hide(),this.frm.scroll_to_field(s)},animate:!1});i.show()}};var x=class{constructor(e,t,i,s){this.layout=s,this.card_layout=i,this.parent=e,this.df=t||{},this.columns=[],this.fields_list=[],this.fields_dict={},this.make(),this.df.label&&this.df.collapsible&&localStorage.getItem(t.css_class+"-closed")&&this.collapse(),this.row={wrapper:this.wrapper},this.refresh()}make(){let e=this.card_layout;this.wrapper=$(`<div class="row
				${this.df.is_dashboard_section?"form-dashboard-section":"form-section"}
				${e?"card-section":""}" data-fieldname="${this.df.fieldname}">
			`).appendTo(this.parent),this.df&&(this.df.label&&this.make_head(),this.df.description&&(this.description_wrapper=$(`<div class="col-sm-12 form-section-description">
						${__(this.df.description)}
					</div>`),this.wrapper.append(this.description_wrapper)),this.df.css_class&&this.wrapper.addClass(this.df.css_class),this.df.hide_border&&this.wrapper.toggleClass("hide-border",!0)),this.body=$('<div class="section-body">').appendTo(this.wrapper),this.df.body_html&&this.body.append(this.df.body_html)}make_head(){this.head=$(`
			<div class="section-head">
				${__(this.df.label)}
				<span class="ml-2 collapse-indicator mb-1"></span>
			</div>
		`),this.head.appendTo(this.wrapper),this.indicator=this.head.find(".collapse-indicator"),this.indicator.hide(),this.df.collapsible&&(this.head.addClass("collapsible"),this.collapse_link=this.head.on("click",()=>{this.collapse()}),this.set_icon(),this.indicator.show())}replace_field(e,t){var i;if((i=this.fields_dict[e])!=null&&i.df){let s=this.fields_dict[e],a=this.fields_list.findIndex(n=>n==s);this.fields_list.splice(a,1,t),this.fields_dict[e]=t,t.section=this}}add_field(e){this.fields_list.push(e),this.fields_dict[e.df.fieldname]=e,e.section=this}refresh(e){!this.df||(e=e||this.df.hidden||this.df.hidden_due_to_dependency,this.wrapper.toggleClass("hide-control",!!e))}collapse(e){!(this.head&&this.body)||(e===void 0&&(e=!this.body.hasClass("hide")),this.body.toggleClass("hide",e),this.head&&this.head.toggleClass("collapsed",e),this.set_icon(e),this.fields_list.forEach(t=>t.on_section_collapse&&t.on_section_collapse(e)),this.df.css_class&&localStorage.setItem(this.df.css_class+"-closed",e?"1":""))}set_icon(e){let t=e?"es-line-down":"es-line-up";this.indicator&&this.indicator.html(frappe.utils.icon(t,"sm","mb-1"))}is_collapsed(){return this.body.hasClass("hide")}has_missing_mandatory(){let e=!1;for(let t=0,i=this.fields_list.length;t<i;t++){let s=this.fields_list[t].df;if(s.reqd&&this.layout.doc[s.fieldname]==null){e=!0;break}}return e}hide(){this.on_section_toggle(!1)}show(){this.on_section_toggle(!0)}on_section_toggle(e){this.wrapper.toggleClass("hide-control",!e)}};frappe.ui.form.Dashboard=class{constructor(e,t){this.parent=e,this.frm=t,this.setup_dashboard_sections()}setup_dashboard_sections(){this.progress_area=this.make_section({css_class:"progress-area",hidden:1,collapsible:1,is_dashboard_section:1}),this.heatmap_area=this.make_section({label:__("Activity"),css_class:"form-heatmap",hidden:1,collapsible:1,is_dashboard_section:1,body_html:`
				<div id="heatmap-${frappe.model.scrub(this.frm.doctype)}" class="heatmap"></div>
				<div class="text-muted small heatmap-message hidden"></div>
			`}),this.chart_area=this.make_section({label:__("Graph"),css_class:"form-graph",hidden:1,collapsible:1,is_dashboard_section:1}),this.stats_area_row=$('<div class="row"></div>'),this.stats_area=this.make_section({label:__("Stats"),css_class:"form-stats",hidden:1,collapsible:1,is_dashboard_section:1,body_html:this.stats_area_row}),this.transactions_area=$('<div class="transactions"></div>'),this.links_area=this.make_section({label:__("Connections"),css_class:"form-links",hidden:1,collapsible:1,is_dashboard_section:1,body_html:this.transactions_area})}make_section(e){return new x(this.parent,e)}reset(){this.progress_area.body.empty(),this.progress_area.hide(),this.heatmap_area.hide(),this.chart_area.hide(),this.links_area.body.find(".count, .open-notification").addClass("hidden"),this.links_area.hide(),this.stats_area_row.empty(),this.stats_area.hide(),this.parent.find(".custom").remove()}add_section(e,t=null,i="custom",s=!1){let a={label:t,css_class:i,hidden:s,body_html:e,make_card:!0,collapsible:1,is_dashboard_section:1};return new x(this.parent,a).body}add_progress(e,t,i){let s=this.make_progress_chart(e);$.isArray(t)||(t=this.format_percent(e,t));let a=$('<div class="progress"></div>').appendTo(s);return $.each(t,function(n,o){$(`<div class="progress-bar ${o.progress_class}" style="width: ${o.width}" title="${o.title}"></div>`).appendTo(a)}),i||(i=""),$(`<p class="progress-message text-muted small">${i}</p>`).appendTo(s),this.show(),s}show_progress(e,t,i){this._progress_map=this._progress_map||{};let s=this._progress_map[e];(!s||s.parent().length==0)&&(s=this.add_progress(e,t,i),this._progress_map[e]=s),$.isArray(t)||(t=this.format_percent(e,t)),s.find(".progress-bar").each((a,n)=>{let{progress_class:o,width:l}=t[a];$(n).css("width",l).removeClass("progress-bar-danger progress-bar-success").addClass(o)}),i||(i=""),s.find(".progress-message").text(i)}hide_progress(e){e?(this._progress_map[e].remove(),delete this._progress_map[e]):(this._progress_map={},this.progress_area.hide())}format_percent(e,t){let i=cint(t),s=i<0?100:i,a=i<0?"progress-bar-danger":"progress-bar-success";return[{title:e,width:s+"%",progress_class:a}]}make_progress_chart(e){return this.progress_area.show(),$('<div class="progress-chart" title="'+(e||"")+'"></div>').appendTo(this.progress_area.body)}refresh(){if(this.reset(),this.frm.doc.__islocal||!frappe.boot.desk_settings.dashboard)return;this.data||this.init_data();let e=!1;if(this.data&&((this.data.transactions||[]).length||(this.data.reports||[]).length)){if(this.data.docstatus&&this.frm.doc.docstatus!==this.data.docstatus)return;this.render_links(),e=!0}this._fetched_counts=!1,this.data.heatmap&&(this.render_heatmap(),e=!0),this.data.graph&&this.setup_graph(),e&&this.show()}after_refresh(){this.links_area.body.find(".btn-new").each((e,t)=>{this.frm.can_create($(t).attr("data-doctype"))&&$(t).removeClass("hidden")}),this.observe_link_render()}observe_link_render(){let e=this,t=this.links_area.wrapper[0];new IntersectionObserver((i,s)=>{i.forEach(a=>{a.intersectionRatio>0&&(e.set_open_count(),s.disconnect())})}).observe(t)}init_data(){this.data=this.frm.meta.__dashboard||{},this.data.transactions||(this.data.transactions=[]),this.data.internal_links||(this.data.internal_links={}),this.data.internal_and_external_links||(this.data.internal_and_external_links={}),this.filter_permissions()}add_transactions(e){let t=[];Array.isArray(e)||(e=[e]),this.data||this.init_data(),this.data&&(this.data.transactions||[]).length&&(this.data.transactions.map(i=>{e.map(s=>{s.label==i.label&&(t.push(s.label),i.items.push(...s.items))})}),e.map(i=>{t.includes(i.label)||this.data.transactions.push(i)}),this.filter_permissions())}filter_permissions(){let e=[];(this.data.transactions||[]).forEach(function(t){let i=[];t.items.forEach(function(s){frappe.model.can_read(s)&&i.push(s)}),i.length&&(t.items=i,e.push(t))}),this.data.transactions=e}render_links(){let e=this;if(this.links_area.show(),this.links_area.body.find(".btn-new").addClass("hidden"),this.data_rendered)return;this.data.frm=this.frm;let t=this.transactions_area;$(frappe.render_template("form_links",this.data)).appendTo(t),this.render_report_links(),t.find(".badge-link").on("click",function(){e.open_document_list($(this).closest(".document-link"))}),t.find(".open-notification").on("click",function(){e.open_document_list($(this).parent(),!0)}),t.find(".btn-new").on("click",function(){e.frm.make_new($(this).attr("data-doctype"))}),this.data_rendered=!0}render_report_links(){let e=this.transactions_area;this.data.reports&&this.data.reports.length&&($(frappe.render_template("report_links",this.data)).appendTo(e),e.find(".report-link").on("click",t=>{this.open_report($(t.target).parent())}))}open_report(e){let t=e.attr("data-report"),i=this.data.non_standard_fieldnames?this.data.non_standard_fieldnames[t]||this.data.fieldname:this.data.fieldname;frappe.provide("frappe.route_options"),frappe.route_options[i]=this.frm.doc.name,frappe.set_route("query-report",t)}open_document_list(e,t){let i=e.attr("data-doctype"),s=e.attr("data-names")||[];if(this.internal_links_found&&this.internal_links_found.find(a=>a.doctype===i))if(s.length)frappe.route_options={name:["in",s]};else return!1;else this.data.fieldname&&(frappe.route_options=this.get_document_filter(i),t&&frappe.ui.notifications&&frappe.ui.notifications.show_open_count_list(i));frappe.set_route("List",i,"List")}get_document_filter(e){let t={},i=this.data.non_standard_fieldnames?this.data.non_standard_fieldnames[e]||this.data.fieldname:this.data.fieldname;if(this.data.dynamic_links&&this.data.dynamic_links[i]){let s=this.data.dynamic_links[i][1];t[s]=this.data.dynamic_links[i][0]}return t[i]=this.frm.doc.name,t}set_open_count(){if(!this.data||!this.data.transactions||!this.data.fieldname||this.frm.is_new()||this._fetched_counts)return;let e=[],t=this;this.data.transactions.forEach(function(s){s.items.forEach(function(a){e.push(a)})});let i=this.data.method||"frappe.desk.notifications.get_open_count";frappe.call({type:"GET",method:i,args:{doctype:this.frm.doctype,name:this.frm.docname,items:e},callback:function(s){s.message.timeline_data&&t.update_heatmap(s.message.timeline_data),t.update_badges(s.message.count),t.frm.dashboard_data=s.message,t._fetched_counts=!0,t.frm.trigger("dashboard_update")}})}update_badges(e){let t=this;this.internal_links_found=e.internal_links_found,$.each(e.internal_links_found,function(i,s){t.frm.dashboard.set_badge_count_for_internal_link(s.doctype,cint(s.open_count),cint(s.count),s.names)}),$.each(e.external_links_found,function(i,s){t.frm.dashboard.set_badge_count_for_external_link(s.doctype,cint(s.open_count),cint(s.count))})}set_badge_count_for_external_link(e,t,i){let s=$(this.transactions_area).find('.document-link[data-doctype="'+e+'"]');this.set_badge_count_common(t,i,s)}set_badge_count_for_internal_link(e,t,i,s){let a=$(this.transactions_area).find('.document-link[data-doctype="'+e+'"]');this.set_badge_count_common(t,i,a),s&&s.length?a.attr("data-names",s?s.join(","):""):a.find("a").attr("disabled",!0)}set_badge_count_common(e,t,i){e&&i.find(".open-notification").removeClass("hidden").html(e>99?"99+":e),t&&i.find(".count").removeClass("hidden").text(t>99?"99+":t)}update_heatmap(e){this.heatmap&&this.heatmap.update({dataPoints:e})}render_heatmap(){this.heatmap=new frappe.Chart("#heatmap-"+frappe.model.scrub(this.frm.doctype),{type:"heatmap",start:new Date(moment().subtract(1,"year").toDate()),count_label:"interactions",discreteDomains:1,radius:3,data:{}}),this.heatmap_area.show(),this.heatmap_area.body.find("svg").css({margin:"auto"});let e=this.heatmap_area.body.find(".heatmap-message");this.data.heatmap_message?e.removeClass("hidden").html(this.data.heatmap_message):e.addClass("hidden")}add_indicator(e,t){this.show(),this.stats_area.show();let i=this.stats_area_row.find(".indicator-column"),s=i.length+1,a;return s>4?a=3:a=12/s,i.length&&i.removeClass().addClass("col-sm-"+a).addClass("indicator-column"),$('<div class="col-sm-'+a+' indicator-column"><span class="indicator '+t+'">'+e+"</span></div>").appendTo(this.stats_area_row)}setup_graph(){let e=this,t=this.data.graph_method,i={doctype:this.frm.doctype,docname:this.frm.doc.name};$.extend(i,this.data.graph_method_args),frappe.call({type:"GET",method:t,args:i,callback:function(s){s.message?(e.render_graph(s.message),e.show()):e.hide()}})}render_graph(e){this.chart_area.show(),this.chart_area.body.empty(),$.extend(e,{type:e.type||"line",colors:e.colors||["green"],truncateLegends:1,axisOptions:{shortenYAxisNumbers:1,numberFormatter:frappe.utils.format_chart_axis_number}}),this.show(),this.chart=new frappe.Chart(".form-graph",e),this.chart||this.hide()}show(){this.toggle_visibility(!0)}hide(){this.toggle_visibility(!1)}toggle_visibility(e){this.parent.toggleClass("visible-section",e),this.parent.toggleClass("empty-section",!e)}set_headline(e,t){this.frm.layout.show_message(e,t)}clear_headline(){this.frm.layout.show_message()}add_comment(e,t,i){this.set_headline_alert(e,t),i||setTimeout(()=>{this.clear_headline()},1e4)}clear_comment(){this.clear_headline()}set_headline_alert(e,t){e?this.set_headline(`<div>${e}</div>`,t):this.clear_headline()}};frappe.ui.form.States=class{constructor(e){if($.extend(this,e),this.state_fieldname=frappe.workflow.get_state_fieldname(this.frm.doctype),!!this.state_fieldname){this.update_fields=frappe.workflow.get_update_fields(this.frm.doctype);var t=this;$(this.frm.wrapper).bind("render_complete",function(){t.refresh()})}}setup_help(){var e=this;this.frm.page.add_action_item(__("Help"),function(){frappe.workflow.setup(e.frm.doctype);var t=e.get_state(),i=new frappe.ui.Dialog({title:"Workflow: "+frappe.workflow.workflows[e.frm.doctype].name});frappe.workflow.get_transitions(e.frm.doc).then(s=>{let a=$.map(s,o=>`${o.action.bold()} ${__("by Role")} ${o.allowed}`).join(", ")||__("None: End of Workflow").bold(),n=frappe.workflow.get_document_state_roles(e.frm.doctype,t).map(o=>o.bold()).join(", ");$(i.body).html(`
					<p>${__("Current status")}: ${t.bold()}</p>
					<p>${__("Document is only editable by users with role")}: ${n}</p>
					<p>${__("Next actions")}: ${a}</p>
					<p>${__("{0}: Other permission rules may also apply",[__("Note").bold()])}</p>
				`).css({padding:"15px"}),i.show()})},!0)}refresh(){if(this.frm.doc.__islocal){this.set_default_state();return}let e=this.get_state();e&&this.show_actions(e)}show_actions(){var e=!1,t=this;if(this.frm.doc.__unsaved===1)return;function i(s){let a=!1,n=frappe.session.user;return(n==="Administrator"||s.allow_self_approval||n!==t.frm.doc.owner)&&(a=!0),a}frappe.workflow.get_transitions(this.frm.doc).then(s=>{this.frm.page.clear_actions_menu(),s.forEach(a=>{frappe.user_roles.includes(a.allowed)&&i(a)&&(e=!0,t.frm.page.add_action_item(__(a.action),function(){frappe.dom.freeze(),t.frm.selected_workflow_action=a.action,t.frm.script_manager.trigger("before_workflow_action").then(()=>{frappe.xcall("frappe.model.workflow.apply_workflow",{doc:t.frm.doc,action:a.action}).then(n=>{frappe.model.sync(n),t.frm.refresh(),t.frm.selected_workflow_action=null,t.frm.script_manager.trigger("after_workflow_action")}).finally(()=>{frappe.dom.unfreeze()})})}))}),this.setup_btn(e)})}setup_btn(e){e&&(this.frm.page.btn_primary.addClass("hide"),this.frm.page.btn_secondary.addClass("hide"),this.frm.toolbar.current_status="",this.setup_help())}set_default_state(){var e=frappe.workflow.get_default_state(this.frm.doctype,this.frm.doc.docstatus);e&&this.frm.set_value(this.state_fieldname,e)}get_state(){return this.frm.doc[this.state_fieldname]||this.set_default_state(),this.frm.doc[this.state_fieldname]}};frappe.ui.form.save=function(r,e,t,i){$(i).prop("disabled",!0);let s={Save:__("Saving",null,"Freeze message while saving a document"),Submit:__("Submitting",null,"Freeze message while submitting a document"),Update:__("Updating",null,"Freeze message while updating a document"),Amend:__("Amending",null,"Freeze message while amending a document"),Cancel:__("Cancelling",null,"Freeze message while cancelling a document")}[toTitle(e)];var a=s?__(s):"",n=function(){o(),$(r.wrapper).addClass("validated-form"),(e!=="Save"||r.is_dirty())&&d()?u({method:"frappe.desk.form.save.savedocs",args:{doc:r.doc,action:e},callback:function(p){$(document).trigger("save",[r.doc]),t(p)},error:function(p){t(p)},btn:i,freeze_message:a}):(!r.is_dirty()&&frappe.show_alert({message:__("No changes in document"),indicator:"orange"}),$(i).prop("disabled",!1))},o=function(){let h=frappe.model.get_all_docs(r.doc).filter(m=>frappe.model.is_table(m.doctype)),f=[];h.map(m=>{let w=(frappe.meta.docfield_list[m.doctype]||[]).filter(y=>cint(y.in_list_view)===1);(function(y){for(let S=0;S<y.length;S++)if(locals[m.doctype][m.name]&&locals[m.doctype][m.name][y[S].fieldname])return!1;return!0})(w)&&(frappe.model.clear_doc(m.doctype,m.name),f.push(m.parentfield))}),f.forEach(m=>{r.refresh_field(m)})},l=function(){var p={doctype:r.doc.doctype,name:r.doc.name},h=frappe.workflow.get_state_fieldname(r.doctype);h&&$.extend(p,{workflow_state_fieldname:h,workflow_state:r.doc[h]}),u({method:"frappe.desk.form.save.cancel",args:p,callback:function(f){$(document).trigger("save",[r.doc]),t(f)},btn:i,freeze_message:a})},d=function(){var p=!1;return r.scroll_set=!1,r.doc.docstatus==2?!0:($.each(frappe.model.get_all_docs(r.doc),function(h,f){var m=[],v=!1;if($.each(frappe.meta.docfield_list[f.doctype]||[],function(w,k){if(k.fieldname){let y=frappe.meta.get_docfield(f.doctype,k.fieldname,f.name);y.fieldtype==="Fold"&&(v=r.layout.folded),_(f,y)&&!frappe.model.has_value(f.doctype,f.name,y.fieldname)&&(p=!0,m[m.length]=__(y.label),r.scroll_set||c(f.parentfield||y.fieldname),v&&(r.layout.unfold(),v=!1))}}),r.is_new()&&r.meta.autoname==="Prompt"&&!r.doc.__newname&&(p=!0,m=[__("Name"),...m]),m.length){let w=frappe.get_meta(f.doctype),k;if(w.istable){let y=frappe.meta.docfield_map[f.parenttype][f.parentfield],S=__(y.label||frappe.unscrub(y.fieldname)).bold();k=__("Mandatory fields required in table {0}, Row {1}",[S,f.idx])}else k=__("Mandatory fields required in {0}",[__(f.doctype)]);k=k+"<br><br><ul><li>"+m.join("</li><li>")+"</ul>",frappe.msgprint({message:k,indicator:"red",title:__("Missing Fields")}),r.refresh()}}),!p)};let _=function(p,h){if(h.reqd)return!0;if(!h.mandatory_depends_on||!p)return;let f=null,m=h.mandatory_depends_on,v=frappe.get_meta(h.parent);if(typeof m=="boolean")f=m;else if(typeof m=="function")f=m(p);else if(m.substr(0,5)=="eval:")try{f=frappe.utils.eval(m.substr(5),{doc:p,parent:v}),v&&v.istable&&m.includes("is_submittable")&&(f=!0)}catch(k){frappe.throw(__('Invalid "mandatory_depends_on" expression'))}else{var w=p[m];$.isArray(w)?f=!!w.length:f=!!w}return f},c=p=>{r.scroll_to_field(p),r.scroll_set=!0};var u=function(p){if(frappe.ui.form.is_saving)throw console.log("Already saving. Please wait a few moments."),"saving";return r.is_new()&&frappe.ui.form.remove_old_form_route(),frappe.ui.form.is_saving=!0,frappe.call({freeze:!0,method:p.method,args:p.args,btn:p.btn,callback:function(h){p.callback&&p.callback(h)},error:p.error,always:function(h){if($(i).prop("disabled",!1),frappe.ui.form.is_saving=!1,h){var f=h.docs&&h.docs[0];f&&frappe.ui.form.update_calling_link(f)}}})};e==="cancel"?l():n()};frappe.ui.form.remove_old_form_route=()=>{let r=frappe.get_route().join("/");frappe.route_history=frappe.route_history.filter(e=>e.join("/")!==r)};frappe.ui.form.update_calling_link=r=>{if(!frappe._from_link)return;var e=frappe.get_doc(frappe._from_link.doctype,frappe._from_link.docname);(()=>frappe._from_link.df.fieldtype==="Link"?r.doctype===frappe._from_link.df.options:r.doctype===e[frappe._from_link.df.options])()&&frappe.model.with_doctype(r.doctype,()=>{let i=frappe.get_meta(r.doctype);e&&e.parentfield?$.each(frappe._from_link.frm.fields_dict[e.parentfield].grid.grid_rows,function(s,a){a.doc&&a.doc.name===frappe._from_link.docname&&(i.title_field&&i.show_title_field_in_link&&frappe.utils.add_link_title(r.doctype,r.name,r[i.title_field]),frappe._from_link.set_value(r.name))}):(i.title_field&&i.show_title_field_in_link&&frappe.utils.add_link_title(r.doctype,r.name,r[i.title_field]),frappe._from_link.set_value(r.name)),frappe._from_link.refresh(),frappe._from_link.frm&&frappe.set_route("Form",frappe._from_link.frm.doctype,frappe._from_link.frm.docname).then(()=>{frappe.utils.scroll_to(frappe._from_link_scrollY)}),frappe._from_link=null})};frappe.ui.get_print_settings=function(r,e,t,i){var s=locals[":Print Settings"]["Print Settings"],a=locals[":Company"]&&frappe.defaults.get_default("company")?locals[":Company"][frappe.defaults.get_default("company")].default_letter_head:"",n=[{fieldtype:"Check",fieldname:"with_letter_head",label:__("With Letter head")},{fieldtype:"Select",fieldname:"letter_head",label:__("Letter Head"),depends_on:"with_letter_head",options:Object.keys(frappe.boot.letter_heads),default:t||a},{fieldtype:"Select",fieldname:"orientation",label:__("Orientation"),options:[{value:"Landscape",label:__("Landscape")},{value:"Portrait",label:__("Portrait")}],default:"Landscape"}];return i&&n.push({label:__("Pick Columns"),fieldtype:"Check",fieldname:"pick_columns"},{label:__("Select Columns"),fieldtype:"MultiCheck",fieldname:"columns",depends_on:"pick_columns",columns:2,select_all:!0,options:i.map(o=>({label:__(o.label),value:o.fieldname}))}),frappe.prompt(n,function(o){o=$.extend(s,o),o.with_letter_head||(o.letter_head=null),o.letter_head&&(o.letter_head=frappe.boot.letter_heads[s.letter_head]),e(o)},__("Print Settings"))};frappe.ui.form.qz_connect=function(){return new Promise(function(r,e){frappe.ui.form.qz_init().then(()=>{qz.websocket.isActive()?r():(frappe.show_alert({message:__("Attempting Connection to QZ Tray..."),indicator:"blue"}),qz.websocket.connect().then(()=>{frappe.show_alert({message:__("Connected to QZ Tray!"),indicator:"green"}),r()},function(i){i.message==="Unable to establish connection with QZ"?(frappe.show_alert({message:__("Attempting to launch QZ Tray..."),indicator:"blue"},14),window.location.assign("qz:launch"),qz.websocket.connect({retries:3,delay:1}).then(()=>{frappe.show_alert({message:__("Connected to QZ Tray!"),indicator:"green"}),r()},()=>{frappe.throw(__('Error connecting to QZ Tray Application...<br><br> You need to have QZ Tray application installed and running, to use the Raw Print feature.<br><br><a target="_blank" href="https://qz.io/download/">Click here to Download and install QZ Tray</a>.<br> <a target="_blank" href="https://erpnext.com/docs/user/manual/en/setting-up/print/raw-printing">Click here to learn more about Raw Printing</a>.')),e()})):(frappe.show_alert({message:"QZ Tray "+i.toString(),indicator:"red"},14),e())}))})})};frappe.ui.form.qz_init=function(){return new Promise(r=>{if(typeof qz=="object"&&typeof qz.version=="string")r();else{let e=["/assets/frappe/node_modules/js-sha256/build/sha256.min.js","/assets/frappe/node_modules/qz-tray/qz-tray.js"];frappe.require(e,()=>{qz.api.setPromiseType(function(i){return new Promise(i)}),qz.api.setSha256Type(function(t){return sha256(t)}),r()})}})};frappe.ui.form.qz_get_printer_list=function(){return frappe.ui.form.qz_connect().then(function(){return qz.printers.find()}).then(r=>r).catch(r=>{frappe.ui.form.qz_fail(r)})};frappe.ui.form.qz_success=function(){frappe.show_alert({message:__("Print Sent to the printer!"),indicator:"green"})};frappe.ui.form.qz_fail=function(r){frappe.show_alert({message:__("QZ Tray Failed: ")+r.toString(),indicator:"red"},20)};frappe.provide("frappe.ui.form");frappe.provide("frappe.success_action");frappe.ui.form.SuccessAction=class{constructor(e){this.form=e,this.load_setting()}load_setting(){this.setting=frappe.boot.success_action.find(e=>e.ref_doctype===this.form.doctype)}show(){!this.setting||this.form.doc.docstatus===0&&!this.is_first_creation()||(this.prepare_dom(),this.show_alert())}prepare_dom(){this.container=$(document.body).find(".success-container"),this.container.length||(this.container=$('<div class="success-container">').appendTo(document.body))}show_alert(){frappe.db.get_list(this.form.doctype,{limit:2}).then(e=>{let t=e.length,i=this.setting,s=t===1?i.first_success_message:i.message,a=this.get_actions().map(l=>{let d=$(`<button class="next-action"><span>${__(l.label)}</span></button>`);return d.click(()=>l.action(this.form)),d}),n=$('<div class="next-action-container"></div>');n.append(a);let o=n;frappe.show_alert({message:s,body:o,indicator:"green"},i.action_timeout||7)})}get_actions(){let e=[];return this.setting.next_actions.split(`
`).forEach(i=>{typeof i=="string"&&this.default_actions[i]?e.push(this.default_actions[i]):typeof i=="object"&&e.push(i)}),e}get default_actions(){return{new:{label:__("New"),action:e=>frappe.new_doc(e.doctype)},print:{label:__("Print"),action:e=>e.print_doc()},email:{label:__("Email"),action:e=>e.email_doc()},list:{label:__("View All"),action:e=>{frappe.set_route("List",e.doctype)}}}}is_first_creation(){let{modified:e,creation:t}=this.form.doc;return e=e.split(".")[0],t=t.split(".")[0],e===t}};frappe.provide("frappe.ui.form.handlers");window.extend_cscript=(r,e)=>($.extend(r,e),r&&e&&(r.__proto__=e.__proto__),r);frappe.ui.form.get_event_handler_list=function(r,e){return frappe.ui.form.handlers[r]||(frappe.ui.form.handlers[r]={}),frappe.ui.form.handlers[r][e]||(frappe.ui.form.handlers[r][e]=[]),frappe.ui.form.handlers[r][e]};frappe.ui.form.on=frappe.ui.form.on_change=function(r,e,t){var i=function(n,o){var l=frappe.ui.form.get_event_handler_list(r,n);let d=(..._)=>{try{return o(..._)}catch(c){throw console.error(o),c}};l.push(d),cur_frm&&cur_frm.doctype===r&&(cur_frm.events[n]=d)};if(!t&&$.isPlainObject(e))for(var s in e){var a=e[s];typeof a=="function"&&i(s,a)}else i(e,t)};frappe.ui.form.off=function(r,e,t){var i=frappe.ui.form.get_event_handler_list(r,e);i.length&&(frappe.ui.form.handlers[r][e]=[]),cur_frm&&cur_frm.doctype===r&&cur_frm.events[e]&&delete cur_frm.events[e],cur_frm&&cur_frm.cscript&&cur_frm.cscript[e]&&delete cur_frm.cscript[e]};frappe.ui.form.trigger=function(r,e){cur_frm.script_manager.trigger(e,r)};frappe.ui.form.ScriptManager=class{constructor(e){$.extend(this,e)}make(e){this.frm.cscript=extend_cscript(this.frm.cscript,new e({frm:this.frm}))}trigger(e,t,i){let s=this;t=t||this.frm.doctype,i=i||this.frm.docname;let a=[],n=this.get_handlers(e,t);this.frm.selected_doc=frappe.get_doc(t,i);let o=(l,d)=>{let _=null;return d?_=s.frm.cscript[l](s.frm.doc,t,i):_=l(s.frm,t,i),_&&_.then?_:frappe.after_server_call()};return n.new_style.forEach(l=>{e==="setup"?o(l,!1):a.push(()=>o(l,!1))}),n.old_style.forEach(l=>{e==="setup"?o(l,!0):a.push(()=>o(l,!0))}),frappe.run_serially(a)}has_handlers(e,t){let i=this.get_handlers(e,t);return i&&(i.old_style.length||i.new_style.length)}get_handlers(e,t){let i=this,s={old_style:[],new_style:[]};return frappe.ui.form.handlers[t]&&frappe.ui.form.handlers[t][e]&&$.each(frappe.ui.form.handlers[t][e],function(a,n){s.new_style.push(n)}),this.frm.cscript[e]&&s.old_style.push(e),this.frm.cscript["custom_"+e]&&s.old_style.push("custom_"+e),s}setup(){var a;let e=this.frm.meta,t=this,i=e.__js;if((a=this.frm.doctype_layout)!=null&&a.client_script&&(i+=`
${this.frm.doctype_layout.client_script}`),i&&new Function(i)(),!this.frm.doctype_layout&&e.__custom_js)try{new Function(e.__custom_js)()}catch(n){frappe.msgprint({title:__("Error in Client Script"),indicator:"orange",message:'<pre class="small"><code>'+n.stack+"</code></pre>"})}function s(n){if((["Data","Read Only","Text","Small Text","Currency","Check","Text Editor","Attach Image","Code","Link","Float","Int","Date","Select","Duration"].includes(n.fieldtype)||n.read_only==1||n.is_virtual==1)&&n.fetch_from&&n.fetch_from.indexOf(".")!=-1){var l=n.fetch_from.split(".");t.frm.add_fetch(l[0],l[1],n.fieldname,n.parent)}}$.each(this.frm.fields,function(n,o){s(o.df),frappe.model.table_fields.includes(o.df.fieldtype)&&$.each(frappe.meta.get_docfields(o.df.options,t.frm.docname),function(l,d){s(d)})}),e.__css&&frappe.dom.set_style(e.__css),this.trigger("setup")}log_error(e,t){frappe.show_alert({message:__("Error in Client Script."),indicator:"error"}),console.group&&console.group(),console.log("----- error in client script -----"),console.log("method: "+e),console.log(t),console.log("error message: "+t.message),console.trace&&console.trace(),console.log("----- end of error message -----"),console.group&&console.groupEnd()}copy_from_first_row(e,t,i){var s=this.frm.doc[e];s.length===1||s[0]===t||(typeof i=="string"&&(i=[i]),$.each(i,function(a,n){frappe.model.set_value(t.doctype,t.name,n,s[0][n])}))}};window.refresh_many=function(r,e,t){for(var i in r)t?refresh_field(r[i],e,t):refresh_field(r[i])};window.refresh_field=function(r,e,t){if(typeof r==typeof[]&&refresh_many(r,e,t),r&&typeof r=="string"&&t){var i=cur_frm.fields_dict[t].grid,s=frappe.utils.filter_dict(i.docfields,{fieldname:r}),a=i.grid_rows_by_docname[e];if(s&&s.length){s=s[0];var n=frappe.meta.get_docfield(s.parent,s.fieldname,e);$.extend(s,n),a?a.refresh_field(r):i.refresh()}}else cur_frm&&cur_frm.refresh_field(r)};window.set_field_options=function(r,e){cur_frm.set_df_property(r,"options",e)};window.toggle_field=function(r,e){var t=frappe.meta.get_docfield(cur_frm.doctype,r,cur_frm.docname);t?(t.hidden=e,refresh_field(r)):console.log((e?"hide_field":"unhide_field")+" cannot find field "+r)};window.hide_field=function(r){if(cur_frm)if(r.substr)toggle_field(r,1);else for(var e in r)toggle_field(r[e],1)};window.unhide_field=function(r){if(cur_frm)if(r.substr)toggle_field(r,0);else for(var e in r)toggle_field(r[e],0)};frappe.ui.form.AssignTo=class{constructor(e){$.extend(this,e),this.btn=this.parent.find(".add-assignment-btn").on("click",()=>this.add()),this.btn_wrapper=this.btn.parent(),this.refresh()}refresh(){if(this.frm.doc.__islocal){this.parent.toggle(!1);return}this.parent.toggle(!0),this.render(this.frm.get_docinfo().assignments)}render(e){this.frm.get_docinfo().assignments=e;let t=this.parent.find(".assignments");t.empty();let i=e.map(a=>a.owner);if(!i.length){t.hide();return}let s=frappe.avatar_group(i,5,{align:"left",overlap:!0});t.show(),t.append(s),s.click(()=>{new frappe.ui.form.AssignmentDialog({assignments:i,frm:this.frm})})}add(){var e=this;if(this.frm.is_new()){frappe.throw(__("Please save the document before assignment"));return}e.assign_to||(e.assign_to=new frappe.ui.form.AssignToDialog({method:"frappe.desk.form.assign_to.add",doctype:e.frm.doctype,docname:e.frm.docname,frm:e.frm,callback:function(t){e.render(t.message)}})),e.assign_to.dialog.clear(),e.assign_to.dialog.show()}remove(e){if(this.frm.is_new()){frappe.throw(__("Please save the document before removing assignment"));return}return frappe.xcall("frappe.desk.form.assign_to.remove",{doctype:this.frm.doctype,name:this.frm.docname,assign_to:e}).then(t=>{this.render(t)})}};frappe.ui.form.AssignToDialog=class{constructor(e){$.extend(this,e),this.make(),this.set_description_from_doc()}make(){let e=this;e.dialog=new frappe.ui.Dialog({title:__("Add to ToDo"),fields:e.get_fields(),primary_action_label:__("Add"),primary_action:function(){let t=e.dialog.get_values();t&&t.assign_to&&(e.dialog.set_message("Assigning..."),frappe.call({method:e.method,args:$.extend(t,{doctype:e.doctype,name:e.docname,assign_to:t.assign_to,bulk_assign:e.bulk_assign||!1,re_assign:e.re_assign||!1}),btn:e.dialog.get_primary_btn(),callback:function(i){i.exc?e.dialog.clear_message():(e.callback&&e.callback(i),e.dialog&&e.dialog.hide())}}))}})}assign_to_me(){let e=this,t=[];e.dialog.get_value("assign_to_me")&&t.push(frappe.session.user),e.dialog.set_value("assign_to",t)}set_description_from_doc(){let e=this;e.frm&&e.frm.meta.title_field&&e.dialog.set_value("description",e.frm.doc[e.frm.meta.title_field])}get_fields(){let e=this;return[{label:__("Assign to me"),fieldtype:"Check",fieldname:"assign_to_me",default:0,onchange:()=>e.assign_to_me()},{fieldtype:"MultiSelectPills",fieldname:"assign_to",label:__("Assign To"),reqd:!0,get_data:function(t){return frappe.db.get_link_options("User",t,{user_type:"System User",enabled:1})}},{fieldtype:"Section Break"},{label:__("Complete By"),fieldtype:"Date",fieldname:"date"},{fieldtype:"Column Break"},{label:__("Priority"),fieldtype:"Select",fieldname:"priority",options:[{value:"Low",label:__("Low")},{value:"Medium",label:__("Medium")},{value:"High",label:__("High")}],default:["Low","Medium","High"].includes(e.frm&&e.frm.doc.priority?e.frm.doc.priority:"Medium")},{fieldtype:"Section Break"},{label:__("Comment"),fieldtype:"Small Text",fieldname:"description"}]}};frappe.ui.form.AssignmentDialog=class{constructor(r){this.frm=r.frm,this.assignments=r.assignments,this.make()}make(){this.dialog=new frappe.ui.Dialog({title:__("Assignments"),size:"small",no_focus:!0,fields:[{label:__("Assign a user"),fieldname:"user",fieldtype:"Link",options:"User",change:()=>{let r=this.dialog.get_value("user");r&&!this.assigning&&(this.assigning=!0,this.dialog.set_df_property("user","read_only",1),this.dialog.set_df_property("user","description",__("Assigning...")),this.add_assignment(r).then(()=>{this.dialog.set_value("user",null)}).finally(()=>{this.dialog.set_df_property("user","description",null),this.dialog.set_df_property("user","read_only",0),this.assigning=!1}))}},{fieldtype:"HTML",fieldname:"assignment_list"}]}),this.assignment_list=$(this.dialog.get_field("assignment_list").wrapper),this.assignment_list.removeClass("frappe-control"),this.assignments.forEach(r=>{this.update_assignment(r)}),this.dialog.show()}render(r){this.frm&&this.frm.assign_to.render(r)}add_assignment(r){return frappe.xcall("frappe.desk.form.assign_to.add",{doctype:this.frm.doctype,name:this.frm.docname,assign_to:[r]}).then(e=>{this.update_assignment(r),this.render(e)})}remove_assignment(r){return frappe.xcall("frappe.desk.form.assign_to.remove",{doctype:this.frm.doctype,name:this.frm.docname,assign_to:r})}close_assignment(r){return frappe.xcall("frappe.desk.form.assign_to.close",{doctype:this.frm.doctype,name:this.frm.docname,assign_to:r})}update_assignment(r){this.assignment_list.find(`[data-user="${r}"]`).length||this.assignment_list.append(this.get_assignment_row(r))}get_assignment_row(r){let e=$(`
			<div class="dialog-assignment-row" data-user="${r}">
				<div class="assignee">
					${frappe.avatar(r)}
					${frappe.user.full_name(r)}
				</div>
				<div class="btn-group btn-group-sm" role="group" aria-label="Actions">
				</div>
			</div>
		`),t=e.find(".btn-group");return r===frappe.session.user&&(t.append(`
				<button type="button" class="btn btn-default complete-btn" title="${__("Done")}">
					${frappe.utils.icon("tick","xs")}
				</button>
			`),t.find(".complete-btn").click(()=>{this.close_assignment(r).then(i=>{e.remove(),this.render(i)})})),(r===frappe.session.user||this.frm.perm[0].write)&&(t.append(`
				<button type="button" class="btn btn-default remove-btn" title="${__("Cancel")}">
				${frappe.utils.icon("close")}
				</button>
			`),t.find(".remove-btn").click(()=>{this.remove_assignment(r).then(i=>{e.remove(),this.render(i)})})),e}};frappe.ui.form.Attachments=class{constructor(e){$.extend(this,e),this.attachments_page_length=10,this.show_all_attachments=!1,this.make()}make(){var e=this;this.parent.find(".add-attachment-btn").click(function(){e.new_attachment()}),this.parent.find(".explore-link").click(()=>{var t;!((t=this.frm.attachments.get_attachments())!=null&&t.length)||(frappe.open_in_new_tab=!0,frappe.set_route("List","File",{attached_to_doctype:this.frm.doctype,attached_to_name:this.frm.docname}))}),this.add_attachment_wrapper=this.parent.find(".attachments-actions"),this.attachments_label=this.parent.find(".attachments-label")}max_reached(e=!1){let t=Object.keys(this.get_attachments()).length,i=this.frm.meta.max_attachments;return i&&t>=i?(e&&frappe.throw({title:__("Attachment Limit Reached"),message:__("Maximum attachment limit of {0} has been reached.",[cstr(i).bold()])}),!0):!1}refresh(){if(this.frm.doc.__islocal){this.parent.toggle(!1);return}this.parent.toggle(!0),this.parent.find(".attachment-row").remove();var e=this.max_reached();this.add_attachment_wrapper.find(".add-attachment-btn").toggle(!e);var t=this.get_attachments();this.render_attachments(t),this.setup_show_all_button(t)}setup_show_all_button(e){let t=e.length>this.attachments_page_length,i=!this.show_all_attachments&&t,s=this.parent.find(".show-all-btn");if(!i){s.addClass("hidden");return}s.removeClass("hidden"),s.click(()=>{s.addClass("hidden"),this.show_all_attachments=!0,this.refresh()})}get_attachments(){return this.frm.get_docinfo().attachments||[]}render_attachments(e){var t=this;let i=e,s=e.length>this.attachments_page_length;if(!this.show_all_attachments&&s){let a=e.length-this.attachments_page_length;i=e.slice(a,e.length)}if(i.length){let a={};i.filter(o=>Object.prototype.hasOwnProperty.call(a,o.file_name)?!1:a[o.file_name]=!0).forEach(o=>{t.add_attachment(o)})}e.length||this.attachments_label.removeClass("has-attachments")}add_attachment(e){var t=e.file_name,i=this.get_file_url(e),s=e.name;t||(t=i);var a=this;let n=`
			<a href="${i}" target="_blank" title="${frappe.utils.escape_html(t)}"
				class="ellipsis" style="max-width: calc(100% - 43px);"
			>
				<span>${t}</span>
			</a>`,o=null;frappe.model.can_write(this.frm.doctype,this.frm.name)&&(o=function(d){return frappe.confirm(__("Are you sure you want to delete the attachment?"),function(){let _=a.get_attachments().find(u=>u.name===d);a.get_attachments().filter(u=>u.file_name===_.file_name).forEach(u=>a.remove_attachment(u.name))}),!1});let l=`<a href="/app/file/${s}">
				${frappe.utils.icon(e.is_private?"es-line-lock":"es-line-unlock","sm ml-0")}
			</a>`;$('<li class="attachment-row">').append(frappe.get_data_pill(n,s,o,l)).insertAfter(this.add_attachment_wrapper)}get_file_url(e){var t=e.file_url;return t||(e.file_name.indexOf("files/")===0?t="/"+e.file_name:t="/files/"+e.file_name),encodeURI(t).replace(/#/g,"%23")}get_file_id_from_file_url(e){var t;return $.each(this.get_attachments(),function(i,s){if(s.file_url===e)return t=s.name,!1}),t}remove_attachment_by_filename(e,t){this.remove_attachment(this.get_file_id_from_file_url(e),t)}remove_attachment(e,t){if(!e){t&&t();return}var i=this;return frappe.call({method:"frappe.desk.form.utils.remove_attach",type:"DELETE",args:{fid:e,dt:i.frm.doctype,dn:i.frm.docname},callback:function(s,a){if(s.exc){s._server_messages||frappe.msgprint(__("There were errors"));return}i.remove_fileid(e),i.frm.sidebar.reload_docinfo(),t&&t()}})}new_attachment(e){this.dialog&&this.dialog.$wrapper.remove();let t={};this.frm.meta.max_attachments&&(t.max_number_of_files=this.frm.meta.max_attachments-this.frm.attachments.get_attachments().length),new frappe.ui.FileUploader({doctype:this.frm.doctype,docname:this.frm.docname,frm:this.frm,folder:"Home/Attachments",on_success:i=>{this.attachment_uploaded(i)},restrictions:t,make_attachments_public:this.frm.meta.make_attachments_public})}get_args(){return{from_form:1,doctype:this.frm.doctype,docname:this.frm.docname}}attachment_uploaded(e){this.dialog&&this.dialog.hide(),this.update_attachment(e),this.frm.sidebar.reload_docinfo(),this.fieldname&&this.frm.set_value(this.fieldname,e.file_url)}update_attachment(e){e.name&&(this.add_to_attachments(e),this.refresh())}add_to_attachments(e){var t=this.get_attachments();for(var i in t)if(t[i].name===e.name)return;t.push(e)}remove_fileid(e){var t=this.get_attachments(),i=[];$.each(t,function(s,a){a.name!=e&&i.push(a)}),this.frm.get_docinfo().attachments=i,this.refresh()}};frappe.ui.form.Share=class{constructor(e){$.extend(this,e),this.shares=this.parent.find(".shares")}refresh(){this.render_sidebar()}render_sidebar(){let t=(this.shared||this.frm.get_docinfo().shared).filter(Boolean).map(s=>s.user);if(this.frm.is_new()&&this.parent.find(".share-doc-btn").hide(),this.parent.find(".share-doc-btn").off("click").on("click",()=>{this.frm.share_doc()}),this.shares.empty(),!t.length){this.shares.hide();return}this.shares.show();let i=frappe.avatar_group(t,5,{align:"left",overlap:!0});i.on("click",()=>{this.frm.share_doc()}),this.shares.append(i)}show(){var e=this,t=new frappe.ui.Dialog({title:__("Share {0} with",[this.frm.doc.name])});this.dialog=t,this.dirty=!1,$(t.body).html('<p class="text-muted">'+__("Loading...")+"</p>"),frappe.call({method:"frappe.share.get_users",args:{doctype:this.frm.doctype,name:this.frm.doc.name},callback:function(i){e.render_shared(i.message||[])}}),t.onhide=function(){e.dirty&&e.frm.sidebar.reload_docinfo()},t.show()}render_shared(e){e&&(this.shared=e);var t=this.dialog;$(t.body).empty();var i={};$.each(this.shared,function(s,a){a&&a.everyone&&(i=a)}),$(frappe.render_template("set_sharing",{frm:this.frm,shared:this.shared,everyone:i})).appendTo(t.body),frappe.model.can_share(null,this.frm)?(this.make_user_input(),this.add_share_button(),this.set_edit_share_events()):$(t.body).find(".edit-share").prop("disabled",!0)}make_user_input(){this.dialog.share_with=frappe.ui.form.make_control({parent:$(this.dialog.body).find(".input-wrapper-add-share"),df:{fieldtype:"Link",label:__("Share With"),fieldname:"share_with",options:"User",filters:{user_type:"System User",name:["!=",frappe.session.user]}},only_input:!0,render_input:!0})}add_share_button(){var e=this,t=this.dialog;$(t.body).find(".btn-add-share").on("click",function(){var i=t.share_with.get_value();!i||frappe.call({method:"frappe.share.add",args:{doctype:e.frm.doctype,name:e.frm.doc.name,user:i,read:$(t.body).find(".add-share-read").prop("checked")?1:0,write:$(t.body).find(".add-share-write").prop("checked")?1:0,submit:$(t.body).find(".add-share-submit").prop("checked")?1:0,share:$(t.body).find(".add-share-share").prop("checked")?1:0,notify:1},btn:this,callback:function(s){$.each(e.shared,function(a,n){n&&n.user===s.message.user&&delete e.shared[a]}),e.dirty=!0,e.shared.push(s.message),e.render_shared(),e.frm.shared.refresh()}})})}set_edit_share_events(){var e=this,t=this.dialog;$(t.body).find(".edit-share").on("click",function(){var i=$(this).parents(".shared-user:first").attr("data-user")||"",s=$(this).prop("checked")?1:0,a=$(this).attr("name"),n=cint($(this).parents(".shared-user:first").attr("data-everyone"));frappe.call({method:"frappe.share.set_permission",args:{doctype:e.frm.doctype,name:e.frm.doc.name,user:i,permission_to:a,value:s,everyone:n},callback:function(o){var l=null;$.each(e.shared,function(d,_){if(_&&(_.user===i||n&&_.everyone===1))return o.message?e.shared[d]=$.extend(_,o.message):delete e.shared[d],l=!0,!1}),l||e.shared.push(o.message),e.dirty=!0,e.render_shared(),e.frm.shared.refresh()}})})}};frappe.ui.form.Review=class{constructor({parent:e,frm:t}){this.parent=e,this.frm=t,this.points=frappe.boot.points,this.reviews=this.parent.find(".reviews"),this.setup_add_review_button(),this.update_reviewers()}update_points(){return frappe.xcall("frappe.social.doctype.energy_point_log.energy_point_log.get_energy_points",{user:frappe.session.user}).then(e=>{frappe.boot.points=e,this.points=e})}setup_add_review_button(){let e=this.reviews.find(".add-review-btn");this.points.review_points?e.click(()=>this.show_review_dialog()):(e.click(!1),e.popover({trigger:"hover",content:()=>`<div class="text-medium">
						${__("You do not have enough review points")}
					</div>`,html:!0}))}show_review_dialog(){let e=this.frm.get_involved_users(),t=new frappe.ui.Dialog({title:__("Add Review"),fields:[{fieldname:"to_user",fieldtype:"Autocomplete",label:__("To User"),reqd:1,options:e,ignore_validation:1,description:__("Only users involved in the document are listed")},{fieldname:"review_type",fieldtype:"Select",label:__("Action"),options:[{label:__("Appreciate"),value:"Appreciation"},{label:__("Criticize"),value:"Criticism"}],default:"Appreciation"},{fieldname:"points",fieldtype:"Int",label:__("Points"),reqd:1,description:__("Currently you have {0} review points",[this.points.review_points])},{fieldtype:"Small Text",fieldname:"reason",reqd:1,label:__("Reason")}],primary_action:i=>{if(t.disable_primary_action(),i.points>this.points.review_points)return frappe.msgprint(__("You do not have enough points"));frappe.xcall("frappe.social.doctype.energy_point_log.energy_point_log.review",{doc:{doctype:this.frm.doc.doctype,name:this.frm.doc.name},to_user:i.to_user,points:i.points,review_type:i.review_type,reason:i.reason}).then(s=>{t.hide(),t.clear(),this.frm.get_docinfo().energy_point_logs.unshift(s),this.frm.timeline.refresh(),this.update_reviewers(),this.update_points()}).finally(()=>{t.enable_primary_action()})},primary_action_label:__("Submit")});t.show()}update_reviewers(){let e=this.frm.get_docinfo().energy_point_logs.filter(t=>["Appreciation","Criticism"].includes(t.type));this.reviews.find(".review").remove(),e.forEach(t=>{let i=$(`
				<div class="review ${t.points<0?"criticism":"appreciation"} cursor-pointer">
					${frappe.avatar(t.owner)}
					<span class="review-points">
						${t.points>0?"+":""}${t.points}
					</span>
				</div>
			`);this.reviews.append(i),this.setup_detail_popover(i,t)})}setup_detail_popover(e,t){let i="",s=frappe.user.full_name(t.user),a=`<span class="text-muted">${frappe.datetime.comment_when(t.creation)}</span>`,n=[Math.abs(t.points),s,a];return t.type==="Appreciation"?t.points==1?i=__("{0} appreciation point for {1}",n):i=__("{0} appreciation points for {1}",n):t.points==-1?i=__("{0} criticism point for {1}",n):i=__("{0} criticism points for {1}",n),e.popover({animation:!0,trigger:"hover",delay:500,placement:"top",template:`
				<div class="review-popover popover" role="tooltip">
					<div class="arrow"></div>
					<h3 class="popover-header"></h3>
					<div class="popover-body">
					</div>
				</div>'
			`,content:()=>`
					<div class="text-medium">
						<div class="body">
							<div>${t.reason}</div>
						</div>

						<div class="subject">
							${frappe.utils.icon("review")}
							${i}

							<p class="mt-1">
								<!-- ${frappe.avatar("shivam@example.com","avatar-xs")} -->
								<span>${frappe.user.full_name(t.owner)}</span> - ${a}
							</p>
						</div>
					</div>
				`,html:!0,container:"body"}),e}};frappe.provide("frappe.ui.form");frappe.ui.form.DocumentFollow=class{constructor(e){if($.extend(this,e),!frappe.boot.user.document_follow_notify){this.hide_follow_section();return}this.follow_document_link=this.parent.find(".follow-document-link"),this.unfollow_document_link=this.parent.find(".unfollow-document-link"),this.follow_span=this.parent.find(".anchor-document-follow > span"),this.followed_by=this.parent.find(".followed-by"),this.followed_by_label=this.parent.find(".followed-by-label")}refresh(){this.set_followers(),this.render_sidebar()}render_sidebar(){let e=this.frm.get_docinfo(),t=frappe.boot.user.document_follow_notify,i=frappe.get_meta(this.frm.doctype).track_changes;if(frappe.session.user==="Administrator"||!t||!i){this.hide_follow_section();return}this.bind_events(),(e&&e.is_document_followed)>0?(this.unfollow_document_link.removeClass("hidden"),this.follow_document_link.addClass("hidden")):(this.followed_by_label.addClass("hidden"),this.followed_by.addClass("hidden"),this.unfollow_document_link.addClass("hidden"),this.follow_document_link.removeClass("hidden"))}bind_events(){this.follow_document_link.on("click",()=>{this.follow_document_link.addClass("text-muted disable-click"),frappe.call({method:"frappe.desk.form.document_follow.follow_document",args:{doctype:this.frm.doctype,doc_name:this.frm.doc.name,user:frappe.session.user,force:!0},callback:e=>{e.message&&this.follow_action()}})}),this.unfollow_document_link.on("click",()=>{this.unfollow_document_link.addClass("text-muted disable-click"),frappe.call({method:"frappe.desk.form.document_follow.unfollow_document",args:{doctype:this.frm.doctype,doc_name:this.frm.doc.name,user:frappe.session.user},callback:e=>{e.message&&this.unfollow_action()}})})}hide_follow_section(){this.parent.hide()}set_followers(){this.followed_by.removeClass("hidden"),this.followed_by_label.removeClass("hidden"),this.followed_by.empty(),this.get_followed_user().then(e=>{$(e).appendTo(this.followed_by)})}get_followed_user(){var e="";return new Promise(t=>{frappe.call({method:"frappe.desk.form.document_follow.get_follow_users",args:{doctype:this.frm.doctype,doc_name:this.frm.doc.name}}).then(i=>{this.count_others=0;for(var s in i.message)this.count_others++,this.count_others<4&&(e+=frappe.avatar(i.message[s].user,"avatar-small")),this.count_others===0&&this.followed_by.addClass("hidden");t(e)})})}follow_action(){frappe.show_alert({message:__("You are now following this document. You will receive daily updates via email. You can change this in User Settings."),indicator:"orange"}),this.follow_document_link.removeClass("text-muted disable-click"),this.follow_document_link.addClass("hidden"),this.unfollow_document_link.removeClass("hidden"),this.set_followers()}unfollow_action(){frappe.show_alert({message:__("You unfollowed this document"),indicator:"red"}),this.unfollow_document_link.removeClass("text-muted disable-click"),this.unfollow_document_link.addClass("hidden"),this.follow_document_link.removeClass("hidden"),this.followed_by.addClass("hidden"),this.followed_by_label.addClass("hidden")}};frappe.ui.form.set_user_image=function(r){var e=r.sidebar.image_section,t=r.meta.image_field,i=r.doc[t],s=r.page.$title_area.find(".title-image"),a=r.sidebar.image_wrapper.find(".sidebar-image-actions");if(e.toggleClass("hide",!t),s.toggleClass("hide",!t),!!t)if(i)i=window.cordova&&i.indexOf("http")===-1?frappe.base_url+i:i,e.find(".sidebar-image").attr("src",i).removeClass("hide"),e.find(".sidebar-standard-image").addClass("hide"),s.css("background-image",`url("${i}")`).html(""),a.find(".sidebar-image-change, .sidebar-image-remove").show();else{e.find(".sidebar-image").attr("src",null).addClass("hide");var n=r.get_title();e.find(".sidebar-standard-image").removeClass("hide").find(".standard-image").html(frappe.get_abbr(n)),s.css("background-image","").html(frappe.get_abbr(n)),a.find(".sidebar-image-change").show(),a.find(".sidebar-image-remove").hide()}};frappe.ui.form.setup_user_image_event=function(r){r.meta.image_field&&frappe.ui.form.on(r.doctype,r.meta.image_field,function(e){frappe.ui.form.set_user_image(e)}),r.meta.image_field&&!r.fields_dict[r.meta.image_field].df.read_only&&r.sidebar.image_wrapper.on("click",":not(.sidebar-image-actions)",e=>{if($(e.currentTarget).is("a.dropdown-toggle, .dropdown"))return;r.sidebar.image_wrapper.find(".sidebar-image-actions .dropdown").toggleClass("open"),e.stopPropagation()}),r.sidebar.image_wrapper.on("click",".sidebar-image-change, .sidebar-image-remove",function(e){var s,a;let t=$(e.currentTarget);var i=r.get_field(r.meta.image_field);t.is(".sidebar-image-change")?(i.$input||i.make_input(),i.$input.trigger("attach_doc_image"),(a=(s=r.page).close_sidebar)==null||a.call(s)):r.attachments.remove_attachment_by_filename(r.doc[r.meta.image_field],function(){i.set_value("").then(()=>r.save())})})};frappe.ui.form.SidebarUsers=class{constructor(r){$.extend(this,r)}get_users(r){let e=this.frm.get_docinfo();return e&&e[r]||null}refresh(r,e){this.parent=e=="viewers"?this.$wrapper.find(".form-viewers"):this.$wrapper.find(".form-typers"),this.parent.empty();let t=this.get_users(e);t&&this.show_in_sidebar(t,e,r)}show_in_sidebar(r,e,t){let i=[],s=[],a=[],n=e=="viewers"?"viewing this document":"composing an email";r.current.forEach(l=>{if(l!==frappe.session.user){var d=frappe.user_info(l);i.push({image:d.image,fullname:d.fullname,abbr:d.abbr,color:d.color,title:__("{0} is currently {1}",[d.fullname,n])}),r.new.indexOf(l)!==-1&&s.push(d.fullname),a.push(d.fullname)}}),i.length?(this.parent.parent().removeClass("hidden"),this.parent.append(frappe.render_template("users_in_sidebar",{users:i}))):this.parent.parent().addClass("hidden");let o=e=="viewers"?s:a;t&&this.show_alert(o,n)}show_alert(r,e){r.length&&(r.length===1?frappe.show_alert(__("{0} is currently {1}",[r[0],e])):frappe.show_alert(__("{0} are currently {1}",[frappe.utils.comma_and(r),e])))}};function L(r,e){if(!r.data)return[];let t=JSON.parse(r.data);if(t.comment)return[C(r,t.comment)];let i=[],s=null,a=t.updater_reference;if(!$.isEmptyObject(a)){let o=a.label||__("via {0}",[a.doctype]),{doctype:l,docname:d}=a;l&&d?s=frappe.utils.get_form_link(l,d,!0,o):s=o}if(t.changed&&t.changed.length){var n=[];if(t.changed.every(function(o){if(o[0]==="docstatus"){if(o[2]===1){let l=s?b(r.owner,__("You submitted this document {0}",[s],"Form timeline"),__("{0} submitted this document {1}",[g(r.owner),s],"Form timeline")):b(r.owner,__("You submitted this document",null,"Form timeline"),__("{0} submitted this document",[g(r.owner)],"Form timeline"));i.push(C(r,l))}else if(o[2]===2){let l=s?b(r.owner,__("You cancelled this document {1}",[s],"Form timeline"),__("{0} cancelled this document {1}",[g(r.owner),s],"Form timeline")):b(r.owner,__("You cancelled this document",null,"Form timeline"),__("{0} cancelled this document",[g(r.owner)],"Form timeline"));i.push(C(r,l))}}else{let l=frappe.meta.get_docfield(e.doctype,o[0],e.docname);if(l&&!l.hidden){let d=frappe.perm.get_field_display_status(l,null,e.perm);(d==="Read"||d==="Write")&&n.push(__("{0} from {1} to {2}",[__(l.label),D(o[1]),D(o[2])]))}}return n.length<3}),n.length){let o=s?b(r.owner,__("You changed the value of {0} {1}",[n.join(", "),s]),__("{0} changed the value of {1} {2}",[g(r.owner),n.join(", "),s])):b(r.owner,__("You changed the value of {0}",[n.join(", ")]),__("{0} changed the value of {1}",[g(r.owner),n.join(", ")]));i.push(C(r,o))}}if(t.row_changed&&t.row_changed.length){let o=[];if(t.row_changed.every(function(l){return l[3].every(function(d){var _=e.fields_dict[l[0]]&&frappe.meta.get_docfield(e.fields_dict[l[0]].grid.doctype,d[0],e.docname);if(_&&!_.hidden){var c=frappe.perm.get_field_display_status(_,null,e.perm);(c==="Read"||c==="Write")&&o.push(__("{0} from {1} to {2} in row #{3}",[frappe.meta.get_label(e.fields_dict[l[0]].grid.doctype,d[0]),D(d[1]),D(d[2]),l[1]]))}return o.length<3}),o.length<3}),o.length){let l=s?b(r.owner,__("You changed the values for {0} {1}",[o.join(", "),s]),__("{0} changed the values for {1} {2}",[g(r.owner),o.join(", "),s])):b(r.owner,__("You changed the values for {0}",[o.join(", ")]),__("{0} changed the values for {1}",[g(r.owner),o.join(", ")]));i.push(C(r,l))}}return["added","removed"].forEach(function(o){if(t[o]&&t[o].length){let l=(t[o]||[]).map(function(d){var _=frappe.meta.get_docfield(e.doctype,d[0],e.docname);if(_&&!_.hidden){var c=frappe.perm.get_field_display_status(_,null,e.perm);if(c==="Read"||c==="Write")return __(frappe.meta.get_label(e.doctype,d[0]))}});if(l=l.filter(function(d){return d}),l.length){let d="";o==="added"?d=__("added rows for {0}",[l.join(", ")]):o==="removed"&&(d=__("removed rows for {0}",[l.join(", ")]));let _=C(r,d),c=g(r.owner);i.push(`${c} ${_}`)}}}),i}function C(r,e){if(e.includes("<a")){let t="",i="";try{return e+="</>",Array.from($(e)).forEach(s=>{$(s).is("a")?(t+=i?frappe.utils.get_form_link("Version",r.name,!0,i):"",i="",t+=s.outerHTML):i+=s.outerHTML||s.textContent}),i&&(t+=frappe.utils.get_form_link("Version",r.name,!0,i)),t}catch(s){}}return frappe.utils.get_form_link("Version",r.name,!0,e)}function D(r){return r=frappe.ellipsis(r,40)||'""',r=frappe.utils.escape_html(r),r.bold()}function g(r){let e=frappe.user_info(r).fullname||"";return frappe.utils.get_form_link("User",r,!0,e)}function b(r,e,t){return frappe.utils.is_current_user(r)?e:t}frappe.ui.form.Sidebar=class{constructor(r){$.extend(this,r)}make(){var r=frappe.render_template("form_sidebar",{doctype:this.frm.doctype,frm:this.frm,can_write:frappe.model.can_write(this.frm.doctype,this.frm.docname)});this.sidebar=$('<div class="form-sidebar overlay-sidebar hidden-xs hidden-sm"></div>').html(r).appendTo(this.page.sidebar.empty()),this.comments=this.sidebar.find(".form-sidebar-stats .comments"),this.user_actions=this.sidebar.find(".user-actions"),this.image_section=this.sidebar.find(".sidebar-image-section"),this.image_wrapper=this.image_section.find(".sidebar-image-wrapper"),this.make_assignments(),this.make_attachments(),this.make_review(),this.make_shared(),this.make_tags(),this.make_like(),this.make_follow(),this.bind_events(),this.setup_keyboard_shortcuts(),this.show_auto_repeat_status(),frappe.ui.form.setup_user_image_event(this.frm),this.refresh()}bind_events(){var r=this;this.comments.on("click",function(){frappe.utils.scroll_to(r.frm.footer.wrapper.find(".comment-box"),!0)}),this.like_icon.on("click",function(){frappe.ui.toggle_like(r.like_wrapper,r.frm.doctype,r.frm.doc.name,function(){r.refresh_like()})})}setup_keyboard_shortcuts(){let r=this.sidebar.find(".add-assignment");frappe.ui.keys.get_shortcut_group(this.page).add(r)}refresh(){if(this.frm.doc.__islocal)this.sidebar.toggle(!1),this.page.sidebar.addClass("hide-sidebar");else{if(this.page.sidebar.removeClass("hide-sidebar"),this.sidebar.toggle(!0),this.frm.assign_to.refresh(),this.frm.attachments.refresh(),this.frm.shared.refresh(),this.frm.tags&&this.frm.tags.refresh(this.frm.get_docinfo().tags),this.frm.doc.route&&cint(frappe.boot.website_tracking_enabled)){let r=this.frm.doc.route;frappe.utils.get_page_view_count(r).then(e=>{this.sidebar.find(".pageview-count").html(__("{0} Web page views",[String(e.message).bold()]))})}this.sidebar.find(".modified-by").html(b(this.frm.doc.modified_by,__("You last edited this",null),__("{0} last edited this",[g(this.frm.doc.modified_by)]))+" \xB7 "+comment_when(this.frm.doc.modified)),this.sidebar.find(".created-by").html(b(this.frm.doc.owner,__("You created this",null),__("{0} created this",[g(this.frm.doc.owner)]))+" \xB7 "+comment_when(this.frm.doc.creation)),this.refresh_like(),this.refresh_follow(),this.refresh_comments_count(),frappe.ui.form.set_user_image(this.frm)}}show_auto_repeat_status(){if(this.frm.meta.allow_auto_repeat&&this.frm.doc.auto_repeat){let r=this;frappe.call({method:"frappe.client.get_value",args:{doctype:"Auto Repeat",filters:{name:this.frm.doc.auto_repeat},fieldname:["frequency"]},callback:function(e){r.sidebar.find(".auto-repeat-status").html(__("Repeats {0}",[__(e.message.frequency)])),r.sidebar.find(".auto-repeat-status").on("click",function(){frappe.set_route("Form","Auto Repeat",r.frm.doc.auto_repeat)})}})}}make_tags(){if(this.frm.meta.issingle){this.sidebar.find(".form-tags").toggle(!1);return}let r=this.sidebar.find(".form-tags");this.frm.tags=new frappe.ui.TagEditor({parent:r,add_button:r.find(".add-tags-btn"),frm:this.frm,on_change:function(e){this.frm.tags&&this.frm.tags.refresh(e)}})}make_attachments(){var r=this;this.frm.attachments=new frappe.ui.form.Attachments({parent:r.sidebar.find(".form-attachments"),frm:r.frm})}make_assignments(){this.frm.assign_to=new frappe.ui.form.AssignTo({parent:this.sidebar.find(".form-assignments"),frm:this.frm})}make_shared(){this.frm.shared=new frappe.ui.form.Share({frm:this.frm,parent:this.sidebar.find(".form-shared")})}add_user_action(r,e){return $("<a>").html(r).appendTo($('<li class="user-action-row">').appendTo(this.user_actions.removeClass("hidden"))).on("click",e)}clear_user_actions(){this.user_actions.addClass("hidden"),this.user_actions.find(".user-action-row").remove()}make_like(){this.like_wrapper=this.sidebar.find(".liked-by"),this.like_icon=this.sidebar.find(".liked-by .like-icon"),this.like_count=this.sidebar.find(".liked-by .like-count"),frappe.ui.setup_like_popover(this.sidebar.find(".form-stats-likes"),".like-icon")}make_follow(){this.follow_button=this.sidebar.find(".form-sidebar-stats .form-follow"),this.follow_button.on("click",()=>{let r=this.frm.get_docinfo().is_document_followed;frappe.call("frappe.desk.form.document_follow.update_follow",{doctype:this.frm.doctype,doc_name:this.frm.doc.name,following:!r}).then(()=>{frappe.model.set_docinfo(this.frm.doctype,this.frm.doc.name,"is_document_followed",!r),this.refresh_follow(!r)})})}refresh_follow(r){r==null&&(r=this.frm.get_docinfo().is_document_followed),this.follow_button.text(r?__("Unfollow"):__("Follow"))}refresh_like(){if(!this.like_icon)return;this.like_wrapper.attr("data-liked-by",this.frm.doc._liked_by);let r=frappe.ui.is_liked(this.frm.doc);this.like_wrapper.toggleClass("not-liked",!r).toggleClass("liked",r).attr("data-doctype",this.frm.doctype).attr("data-name",this.frm.doc.name),this.like_count&&this.like_count.text(JSON.parse(this.frm.doc._liked_by||"[]").length)}refresh_comments_count(){let r=(this.frm.get_docinfo().comments||[]).length;this.comments.find(".comments-count").html(r)}refresh_image(){}make_review(){let r=this.sidebar.find(".form-reviews");frappe.boot.energy_points_enabled&&!this.frm.is_new()?this.frm.reviews=new frappe.ui.form.Review({parent:r,frm:this.frm}):r.remove()}reload_docinfo(r){frappe.call({method:"frappe.desk.form.load.get_docinfo",args:{doctype:this.frm.doctype,name:this.frm.docname},callback:e=>{r&&r(e.docinfo),this.frm.timeline&&this.frm.timeline.refresh(),this.frm.assign_to.refresh(),this.frm.attachments.refresh()}})}};var F=class{constructor(e){Object.assign(this,e),this.make()}make(){this.timeline_wrapper=$('<div class="new-timeline">'),this.wrapper=this.timeline_wrapper,this.timeline_items_wrapper=$('<div class="timeline-items">'),this.timeline_actions_wrapper=$(`
			<div class="timeline-items timeline-actions">
				<div class="timeline-item">
					<div class="timeline-content action-buttons"></div>
				</div>
			</div>
		`),this.timeline_wrapper.append(this.timeline_actions_wrapper),this.timeline_actions_wrapper.hide(),this.timeline_wrapper.append(this.timeline_items_wrapper),this.parent.replaceWith(this.timeline_wrapper),this.timeline_items=[]}refresh(){this.render_timeline_items()}add_action_button(e,t,i=null,s=null){let a=i?frappe.utils.icon(i,"xs"):null;this.timeline_actions_wrapper.show();let n=$(`<button class="btn btn-xs ${s||"btn-default"} action-btn">
			${a}
			${e}
		</button>`);return n.click(t),this.timeline_actions_wrapper.find(".action-buttons").append(n),n}render_timeline_items(){this.timeline_items_wrapper.empty(),this.timeline_items=[],this.doc_info=this.frm&&this.frm.get_docinfo()||{};let e=this.prepare_timeline_contents();e instanceof Promise?e.then(()=>{this.timeline_items.sort((t,i)=>new Date(i.creation)-new Date(t.creation)),this.timeline_items.forEach(this.add_timeline_item.bind(this))}):(this.timeline_items.sort((t,i)=>new Date(i.creation)-new Date(t.creation)),this.timeline_items.forEach(this.add_timeline_item.bind(this)))}prepare_timeline_contents(){}add_timeline_item(e,t=!1){let i=this.get_timeline_item(e);return t?this.timeline_items_wrapper.append(i):this.timeline_items_wrapper.prepend(i),i}add_timeline_items(e,t=!1){e.forEach(i=>this.add_timeline_item(i,t))}add_timeline_items_based_on_creation(e){e.forEach(t=>{this.timeline_items_wrapper.find(".timeline-item").each((i,s)=>{let a=$(s).attr("data-timestamp");if(a&&new Date(a)<new Date(t.creation))return $(s).before(this.get_timeline_item(t)),!1})})}get_timeline_item(e){let t=$('<div class="timeline-item">');if(e.name=="load-more")return t.append(`<div class="timeline-load-more">
					<button class="btn btn-default btn-sm btn-load-more">
						<span>${e.content}</span>
					</button>
				</div>`),t.find(".btn-load-more").on("click",async()=>{let s=await this.get_more_communication_timeline_contents();t.remove(),this.add_timeline_items_based_on_creation(s)}),t;t.attr({"data-doctype":e.doctype,"data-name":e.name,"data-timestamp":e.creation}),e.icon?t.append(`
				<div class="timeline-badge" title='${e.title||frappe.utils.to_title_case(e.icon)}'>
					${frappe.utils.icon(e.icon,e.icon_size||"md",e.icon_class||"")}
				</div>
			`):e.timeline_badge?t.append(e.timeline_badge):t.append('<div class="timeline-dot">'),t.append(`<div class="timeline-content ${e.is_card?"frappe-card":""}">`);let i=t.find(".timeline-content");return i.append(e.content),!e.hide_timestamp&&!e.is_card&&i.append(`<span> \xB7 ${comment_when(e.creation)}</span>`),e.id&&i.attr("id",e.id),t}},R=F;var j=class extends R{make(){super.make(),this.setup_timeline_actions(),this.render_timeline_items(),this.setup_activity_toggle()}refresh(){super.refresh(),this.frm.trigger("timeline_refresh"),this.setup_document_email_link()}setup_timeline_actions(){this.add_action_button(__("New Email"),()=>this.compose_mail(),"es-line-add","btn-secondary"),this.setup_new_event_button()}setup_new_event_button(){if(this.frm.meta.allow_events_in_timeline){let e=()=>{let t={doc:this.frm.doc,frm:this.frm,recipients:this.get_recipient(),txt:frappe.markdown(this.frm.comment_box.get_value())};return new frappe.views.InteractionComposer(t)};this.add_action_button(__("New Event"),e,"calendar")}}setup_activity_toggle(){let e=this.doc_info||this.frm.get_docinfo(),t=()=>{let s=e.communications,a=e.comments;return(s||[]).length||(a||[]).length},i=this;this.timeline_wrapper.remove(this.timeline_actions_wrapper),this.timeline_wrapper.prepend(`
				<div class="timeline-item activity-title">
				<h4>${__("Activity")}</h4>
				</div>
			`),t()&&this.timeline_wrapper.find(".timeline-item.activity-title").append(`
					<div class="d-flex align-items-center show-all-activity">
						<span style="color: var(--text-light); margin:0px 6px;">${__("Show all activity")}</span>
						<label class="switch">
							<input type="checkbox">
							<span class="slider round"></span>
						</label>
					</div>
				`).find("input[type=checkbox]").prop("checked",!i.only_communication).on("click",function(s){i.only_communication=!this.checked,i.render_timeline_items(),$(this).tab("show")}),this.timeline_wrapper.find(".timeline-item.activity-title").append(this.timeline_actions_wrapper)}setup_document_email_link(){let e=this.doc_info||this.frm.get_docinfo();if(this.document_email_link_wrapper&&this.document_email_link_wrapper.remove(),e.document_email){let t=`<a class="document-email-link">${e.document_email}</a>`,i=__("Add to this activity by mailing to {0}",[t.bold()]);this.document_email_link_wrapper=$(`
				<div class="timeline-item">
					<div class="timeline-dot"></div>
					<div class="timeline-content">
						<span>${i}</span>
					</div>
				</div>
			`),this.timeline_items_wrapper.before(this.document_email_link_wrapper),this.document_email_link_wrapper.find(".document-email-link").on("click",s=>{let a=$(s.target).text();frappe.utils.copy_to_clipboard(a)})}}render_timeline_items(){super.render_timeline_items(),this.add_web_page_view_count(),frappe.utils.bind_actions_with_object(this.timeline_items_wrapper,this)}add_web_page_view_count(){this.frm.doc.route&&cint(frappe.boot.website_tracking_enabled)&&frappe.utils.get_page_view_count(this.frm.doc.route).then(e=>{this.add_timeline_item({content:__("{0} Web page views",[e.message]),hide_timestamp:!0})})}get_creation_message(){return{creation:this.frm.doc.creation,content:b(this.frm.doc.owner,__("You created this"),__("{0} created this",[g(this.frm.doc.owner)]))}}get_modified_message(){return{creation:this.frm.doc.modified,content:b(this.frm.doc.modified_by,__("You last edited this"),__("{0} last edited this",[g(this.frm.doc.modified_by)]))}}prepare_timeline_contents(){this.timeline_items.push(this.get_creation_message()),this.timeline_items.push(this.get_modified_message()),this.timeline_items.push(...this.get_communication_timeline_contents()),this.timeline_items.push(...this.get_comment_timeline_contents()),this.only_communication||(this.timeline_items.push(...this.get_view_timeline_contents()),this.timeline_items.push(...this.get_energy_point_timeline_contents()),this.timeline_items.push(...this.get_version_timeline_contents()),this.timeline_items.push(...this.get_share_timeline_contents()),this.timeline_items.push(...this.get_workflow_timeline_contents()),this.timeline_items.push(...this.get_like_timeline_contents()),this.timeline_items.push(...this.get_custom_timeline_contents()),this.timeline_items.push(...this.get_assignment_timeline_contents()),this.timeline_items.push(...this.get_attachment_timeline_contents()),this.timeline_items.push(...this.get_info_timeline_contents()),this.timeline_items.push(...this.get_milestone_timeline_contents()))}get_view_timeline_contents(){let e=[];return(this.doc_info.views||[]).forEach(t=>{e.push({creation:t.creation,content:b(t.owner,__("You viewed this"),__("{0} viewed this",[g(t.owner)]))})}),e}get_communication_timeline_contents(e,t){let i=this.get_email_communication_timeline_contents(e),s=this.get_auto_messages_timeline_contents(t),a=i.concat(s);if(a.length>20){a.pop(),(e||t)&&a.forEach(l=>{l.communication_type=="Automated Message"?this.doc_info.automated_messages.push(l):this.doc_info.communications.push(l)});let o={creation:a[a.length-1].creation,content:__("Load More Communications",null,"Form timeline"),name:"load-more"};a.push(o)}return a}get_email_communication_timeline_contents(e){let t=[],i={Email:"mail",Phone:"call",Meeting:"calendar",Other:"dot-horizontal"};return(e||this.doc_info.communications||[]).forEach(a=>{let n=a.communication_medium;t.push({icon:i[n],icon_size:"sm",creation:a.creation,is_card:!0,content:this.get_communication_timeline_content(a),doctype:"Communication",id:`communication-${a.name}`,name:a.name})}),t}async get_more_communication_timeline_contents(){let e=[],t=this.doc_info.communications.length+this.doc_info.automated_messages.length-1,i=await frappe.call({method:"frappe.desk.form.load.get_communications",args:{doctype:this.doc_info.doctype,name:this.doc_info.name,start:t,limit:21}});if(i.message){let s=[],a=[];i.message.forEach(n=>{n.communication_type=="Automated Message"?a.push(n):s.push(n)}),e=this.get_communication_timeline_contents(s,a)}return e}get_communication_timeline_content(e,t=!0){e._url=frappe.utils.get_form_link("Communication",e.name),this.set_communication_doc_status(e),e.attachments&&typeof e.attachments=="string"&&(e.attachments=JSON.parse(e.attachments)),e.owner=e.sender,e.user_full_name=e.sender_full_name,e.content=frappe.dom.remove_script_and_style(e.content);let i=$(frappe.render_template("timeline_message_box",{doc:e}));return t&&this.setup_reply(i,e),i}set_communication_doc_status(e){let t="red";["Sent","Clicked"].includes(e.delivery_status)?t="green":["Sending","Scheduled"].includes(e.delivery_status)?t="orange":["Opened","Read"].includes(e.delivery_status)?t="blue":e.delivery_status=="Error"&&(t="red"),e._doc_status=e.delivery_status,e._doc_status_indicator=t}get_auto_messages_timeline_contents(e){let t=[];return(e||this.doc_info.automated_messages||[]).forEach(s=>{t.push({icon:"notification",icon_size:"sm",creation:s.creation,is_card:!0,content:this.get_communication_timeline_content(s,!1),doctype:"Communication",name:s.name})}),t}get_comment_timeline_contents(){let e=[];return(this.doc_info.comments||[]).forEach(t=>{e.push(this.get_comment_timeline_item(t))}),e}get_comment_timeline_item(e){return{icon:"es-line-chat-alt",icon_size:"sm",creation:e.creation,is_card:!0,doctype:"Comment",id:`comment-${e.name}`,name:e.name,content:this.get_comment_timeline_content(e)}}get_comment_timeline_content(e){e.content=frappe.dom.remove_script_and_style(e.content);let t=$(frappe.render_template("timeline_message_box",{doc:e}));return this.setup_comment_actions(t,e),t}get_version_timeline_contents(){let e=[];return(this.doc_info.versions||[]).forEach(t=>{L(t,this.frm).forEach(s=>{e.push({creation:t.creation,content:s})})}),e}get_share_timeline_contents(){let e=[];return(this.doc_info.share_logs||[]).forEach(t=>{e.push({creation:t.creation,content:t.content})}),e}get_assignment_timeline_contents(){let e=[];return(this.doc_info.assignment_logs||[]).forEach(t=>{e.push({creation:t.creation,content:t.content})}),e}get_info_timeline_contents(){let e=[];return(this.doc_info.info_logs||[]).forEach(t=>{e.push({creation:t.creation,content:`${g(t.owner)} ${t.content}`})}),e}get_attachment_timeline_contents(){let e=[];return(this.doc_info.attachment_logs||[]).forEach(t=>{let i=t.comment_type=="Attachment",s=g(t.owner),a=t.content,n=i?b(t.owner,__("You attached {0}",[a],"Form timeline"),__("{0} attached {1}",[s,a],"Form timeline")):b(t.owner,__("You removed attachment {0}",[a],"Form timeline"),__("{0} removed attachment {1}",[s,a],"Form timeline"));e.push({icon:i?"es-line-attachment":"es-line-delete",icon_size:"sm",creation:t.creation,content:n})}),e}get_milestone_timeline_contents(){let e=[];return(this.doc_info.milestones||[]).forEach(t=>{let i=frappe.meta.get_label(this.frm.doctype,t.track_field),s=t.value.bold(),a=g(t.owner),n=b(t.owner,__("You changed {0} to {1}",[i,s],"Form timeline"),__("{0} changed {1} to {2}",[a,i,s],"Form timeline"));e.push({icon:"milestone",creation:t.creation,content:n})}),e}get_like_timeline_contents(){let e=[];return(this.doc_info.like_logs||[]).forEach(t=>{let i=b(t.owner,__("You Liked"),__("{0} Liked",[g(t.owner)]));e.push({icon:"es-line-like",icon_size:"sm",creation:t.creation,content:i,title:"Like"})}),e}get_workflow_timeline_contents(){let e=[];return(this.doc_info.workflow_logs||[]).forEach(t=>{e.push({icon:"branch",icon_size:"sm",creation:t.creation,content:`${g(t.owner)} ${__(t.content)}`,title:"Workflow"})}),e}get_custom_timeline_contents(){let e=[];return(this.doc_info.additional_timeline_content||[]).forEach(t=>{e.push({icon:t.icon,icon_size:"sm",is_card:t.is_card,creation:t.creation,content:t.content||frappe.render_template(t.template,t.template_data)})}),e}get_energy_point_timeline_contents(){let e=[];return(this.doc_info.energy_point_logs||[]).forEach(t=>{let i=`
			<div class="timeline-badge ${t.points>0?"appreciation":"criticism"} bold">
				${t.points}
			</div>`;e.push({timeline_badge:i,creation:t.creation,content:frappe.energy_points.format_form_log(t)})}),e}setup_reply(e,t){let i=e.find(".custom-actions"),s=$(`<a class="action-btn reply">${frappe.utils.icon("reply","md")}</a>`).click(()=>{this.compose_mail(t)}),a=$(`<a class="action-btn reply-all">${frappe.utils.icon("reply-all","md")}</a>`).click(()=>{this.compose_mail(t,!0)});i.append(s),i.append(a)}compose_mail(e=null,t=!1){let i={doc:this.frm.doc,frm:this.frm,recipients:e&&e.sender!=frappe.session.user_email?e.sender:this.get_recipient(),is_a_reply:Boolean(e),title:e?__("Reply"):null,last_email:e,subject:e&&e.subject,reply_all:t},s=frappe.boot.email_accounts.filter(a=>!["All Accounts","Sent","Spam","Trash"].includes(a.email_account)&&a.enable_outgoing).map(a=>a.email_id);if(e&&i.is_a_reply){if(i.cc="",s.includes(frappe.session.user_email)&&e.sender!=frappe.session.user_email){let a=e.recipients.split(",").map(n=>n.trim());i.cc=a.filter(n=>n!=frappe.session.user_email).join(", ")+", "}t&&(i.cc+=e.cc,i.bcc=e.bcc)}if(this.frm.doctype==="Communication")i.message="",i.last_email=this.frm.doc,i.recipients=this.frm.doc.sender,i.subject=__("Re: {0}",[this.frm.doc.subject]);else{let a=frappe.markdown(this.frm.comment_box.get_value());i.message=strip_html(a)?a:""}new frappe.views.CommunicationComposer(i)}get_recipient(){return this.frm.email_field?this.frm.doc[this.frm.email_field]:this.frm.doc.email_id||this.frm.doc.email||""}setup_comment_actions(e,t){let i=$('<div class="comment-edit-box">').hide(),s=this.make_editable(i),a=e.find(".content"),n=e.find(".more-actions");if(frappe.model.can_delete("Comment")&&(frappe.session.user==t.owner||frappe.user.has_role("System Manager"))){let c=$(`
				<li>
					<a class="dropdown-item">
						${__("Delete")}
					</a>
				</li>
			`).click(()=>this.delete_comment(t.name));n.find(".dropdown-menu").append(c)}let o=$(`
			<button class="btn btn-link action-btn">
				${__("Dismiss")}
			</button>
		`).click(()=>l.toggle_edit_mode());o.hide(),s.set_value(t.content),s.on_submit=c=>{a.empty(),a.append(c),l.prop("disabled",!0),s.quill.enable(!1),t.content=c,this.update_comment(t.name,c).then(l.toggle_edit_mode).finally(()=>{l.prop("disabled",!1),s.quill.enable(!0)})},a.after(i);let l=$(),d=frappe.session.user;["Administrator",t.owner].includes(d)&&(l=$(`<button class="btn btn-link action-btn">${__("Edit")}</a>`).click(()=>{l.edit_mode?s.submit():l.toggle_edit_mode()})),l.toggle_edit_mode=()=>{l.edit_mode=!l.edit_mode,l.text(l.edit_mode?__("Save"):__("Edit")),n.toggle(!l.edit_mode),o.toggle(l.edit_mode),i.toggle(l.edit_mode),a.toggle(!l.edit_mode)};let _=e.find(".custom-actions");_.append(l),_.append(o)}make_editable(e){return frappe.ui.form.make_control({parent:e,df:{fieldtype:"Comment",fieldname:"comment",label:"Comment"},enable_mentions:!0,render_input:!0,only_input:!0,no_wrapper:!0})}update_comment(e,t){return frappe.xcall("frappe.desk.form.utils.update_comment",{name:e,content:t}).then(()=>{frappe.utils.play_sound("click")})}get_last_email(e){let t=this.frm.get_docinfo().communications||[],i=this.get_recipient();return t.filter(a=>a.communication_type==="Communication"&&a.communication_medium==="Email"&&(!e||a.sender===i)).sort((a,n)=>n.creation-a.creation)[0]||null}delete_comment(e){frappe.confirm(__("Delete comment?"),()=>frappe.xcall("frappe.client.delete",{doctype:"Comment",name:e}).then(()=>{frappe.utils.play_sound("delete")}))}copy_link(e){let t=frappe.urllib.get_full_url(frappe.utils.get_form_link(this.frm.doctype,this.frm.docname)),i=$(e.currentTarget).closest(".timeline-content").attr("id");frappe.utils.copy_to_clipboard(`${t}#${i}`)}},N=j;frappe.ui.form.Footer=class{constructor(e){$.extend(this,e),this.make(),this.make_comment_box(),this.make_timeline(),$(this.frm.wrapper).on("render_complete",()=>{this.refresh()})}make(){this.wrapper=$(frappe.render_template("form_footer",{})).appendTo(this.parent),this.wrapper.find(".btn-save").click(()=>{this.frm.save("Save",null,this)})}make_comment_box(){this.frm.comment_box=frappe.ui.form.make_control({parent:this.wrapper.find(".comment-box"),render_input:!0,only_input:!0,enable_mentions:!0,df:{fieldtype:"Comment",fieldname:"comment"},on_submit:e=>{(strip_html(e).trim()!=""||e.includes("img"))&&(this.frm.comment_box.disable(),frappe.xcall("frappe.desk.form.utils.add_comment",{reference_doctype:this.frm.doctype,reference_name:this.frm.docname,content:e,comment_email:frappe.session.user,comment_by:frappe.session.user_fullname}).then(t=>{let i=this.frm.timeline.get_comment_timeline_item(t);this.frm.comment_box.set_value(""),frappe.utils.play_sound("click"),this.frm.timeline.add_timeline_item(i),this.frm.sidebar.refresh_comments_count&&this.frm.sidebar.refresh_comments_count()}).finally(()=>{this.frm.comment_box.enable()}))}})}make_timeline(){this.frm.timeline=new N({parent:this.wrapper.find(".timeline"),frm:this.frm})}refresh(){this.frm.doc.__islocal?this.parent.addClass("hide"):(this.parent.removeClass("hide"),this.frm.timeline.refresh())}};frappe.ui.form.FormTour=class{constructor({frm:e}){this.frm=e,this.driver_steps=[]}init_driver(){this.driver=new frappe.Driver({className:"frappe-driver",allowClose:!1,padding:10,overlayClickNext:!0,keyboardControl:!0,nextBtnText:"Next",prevBtnText:"Previous",opacity:.25,onHighlighted:e=>{e.options.is_save_step&&($(e.options.element).one("click",()=>this.driver.reset()),this.driver.overlay.refresh());let t=$(e.node).find("input").get(0);t&&frappe.utils.sleep(200).then(()=>t.focus())}}),frappe.router.on("change",()=>this.driver.reset()),this.frm.layout.sections.forEach(e=>e.collapse(!1))}async init({tour_name:e,on_finish:t}){e?this.tour=await frappe.db.get_doc("Form Tour",e):await frappe.db.exists("Form Tour",this.frm.doctype)?this.tour=await frappe.db.get_doc("Form Tour",this.frm.doctype):this.tour={steps:frappe.tour[this.frm.doctype]},this.tour.steps&&(t&&(this.on_finish=t),this.init_driver(),this.tour.include_name_field&&this.include_name_field(),this.build_steps(),this.update_driver_steps())}include_name_field(){let e={description:__("Enter a name for this {0}",[this.frm.doctype]),fieldname:"__newname",title:__("Document Name"),position:"right",is_table_field:0};this.tour.steps.unshift(e)}build_steps(){this.driver_steps=[],this.tour.steps.forEach(e=>{let t=()=>{var n;this.is_next_condition_satisfied(e)||this.driver.preventMove(),this.driver.hasNextStep()||this.on_finish&&this.on_finish();let a=(n=this.get_next_step())==null?void 0:n.options.element.fieldobj;(a==null?void 0:a.tab)&&!a.tab.is_active()&&(a.tab.set_active(),this.driver.reset(!0),frappe.utils.sleep(200).then(()=>{this.start(e.idx),this.driver.overlay.refresh()}))},i=()=>{var n;if(!this.driver.hasPreviousStep())return;let a=(n=this.driver.steps[this.driver.currentStep-1])==null?void 0:n.options.element.fieldobj;(a==null?void 0:a.tab)&&!a.tab.is_active()&&(a.tab.set_active(),this.driver.reset(!0),frappe.utils.sleep(200).then(()=>{this.start(e.idx-2),this.driver.overlay.refresh()}))},s=this.get_step(e,t,i);this.driver_steps.push(s),e.fieldtype=="Table"&&this.handle_table_step(e),e.is_table_field&&this.handle_child_table_step(e),e.fieldtype=="Attach Image"&&this.handle_attach_image_steps(e)}),this.tour.save_on_complete&&this.frm.is_dirty()&&this.add_step_to_save()}is_next_condition_satisfied(e){return(e.is_table_field?this.frm.cur_grid.grid_form:this.frm).layout.evaluate_depends_on_value(e.next_step_condition||!0)}get_step(e,t,i){let{name:s,fieldname:a,title:n,description:o,position:l,is_table_field:d}=e,_=`.frappe-control[data-fieldname='${a}']`,c=this.frm.get_field(a);return c&&(_=c.wrapper[0]?c.wrapper[0]:c.wrapper),d&&(_=`.grid-row-open .frappe-control[data-fieldname='${a}']`),{element:_,name:s,popover:{title:n,description:o,position:frappe.router.slug(l||"Bottom")},onNext:t,onPrevious:i}}update_driver_steps(e=[]){e.length==0&&(e=this.driver_steps),this.driver.defineSteps(e)}start(e=0){this.driver_steps.length!=0&&this.driver.start(e)}get_next_step(){if(this.driver.isActivated&this.driver.hasNextStep()){let e=this.driver.currentStep;return this.driver.steps[e+1]}}handle_table_step(e){if(!(e.idx==this.tour.steps.length)){let i=e;if(!(this.tour.steps[i.idx].parent_fieldname==i.fieldname))return;let n=this.frm.doc[i.fieldname];if(n&&n.length>0){let l=this.driver_steps.find(d=>d.name==i.name);l.onNext=()=>{this.is_next_condition_satisfied(i)?this.expand_row_and_proceed(i,i.idx):this.driver.preventMove()},this.update_driver_steps()}else this.add_new_row_step(i)}}add_new_row_step(e){let t=`.frappe-control[data-fieldname='${e.fieldname}'] .grid-add-row`,i={element:t,popover:{title:__("Add a Row"),description:""},onNext:()=>{cur_frm.cur_grid||this.driver.preventMove()}};this.driver_steps.push(i),$(t).one("click",()=>{this.expand_row_and_proceed(e,e.idx+1)})}expand_row_and_proceed(e,t){this.open_first_row_of(e.fieldname),this.update_driver_steps(),frappe.utils.sleep(300).then(()=>this.driver.start(t))}open_first_row_of(e){this.frm.fields_dict[e].grid.grid_rows[0].toggle_view();let t=".grid-row-open .grid-collapse-row";$(t).one("click",()=>{let i=this.get_next_step(),s=i.options.is_save_step?null:i.node;frappe.utils.scroll_to(s,!0,150,null,()=>{this.driver.moveNext(),frappe.flags.disable_auto_scroll=!1}),frappe.flags.disable_auto_scroll=!0})}handle_child_table_step(e){if(e.idx==this.tour.steps.length)this.tour.save_on_complete&&this.add_collapse_row_step();else{let i=e,s=this.tour.steps[i.idx];if(!this.frm.get_field(s.fieldname))return;this.add_collapse_row_step()}}add_collapse_row_step(){let t={element:".grid-row-open .grid-collapse-row",popover:{title:__("Collapse"),description:"",position:"left"},onNext:()=>{cur_frm.cur_grid&&this.driver.preventMove()}};this.driver_steps.push(t)}add_step_to_save(){let i={element:`${`[id="page-${this.frm.doctype}"]`} .standard-actions .primary-action`,is_save_step:!0,allowClose:!1,overlayClickNext:!1,popover:{title:__("Save the document."),description:"",position:"left",showButtons:!1},onNext:()=>{this.frm.save()}};this.driver_steps.push(i),frappe.ui.form.on(this.frm.doctype,"after_save",()=>this.on_finish&&this.on_finish())}handle_attach_image_steps(){$(".btn-attach").one("click",()=>{setTimeout(()=>{let e=$(".file-uploader").closest(".modal-content"),t={element:e[0],allowClose:!1,overlayClickNext:!1,popover:{title:__("Select an Image"),description:"",position:"left",doneBtnText:__("Next")}};this.driver_steps.splice(this.driver.currentStep+1,0,t),this.update_driver_steps(),this.driver.moveNext(),this.driver.overlay.refresh(),e.closest(".modal").on("hidden.bs.modal",()=>{this.driver.moveNext()})},500)})}};var E=class{constructor({frm:e}){this.frm=e,this.undo_stack=[],this.redo_stack=[]}record_change({fieldname:e,old_value:t,new_value:i,doctype:s,docname:a,is_child:n}){t!=i&&this.undo_stack.push({fieldname:e,old_value:t,new_value:i,doctype:s,docname:a,is_child:n})}erase_history(){this.undo_stack=[],this.redo_stack=[]}undo(){let e=this.undo_stack.pop();e?(this._apply_change(e),this._push_reverse_entry(e,this.redo_stack)):this._show_alert(__("Nothing left to undo"))}redo(){let e=this.redo_stack.pop();e?(this._apply_change(e),this._push_reverse_entry(e,this.undo_stack)):this._show_alert(__("Nothing left to redo"))}_push_reverse_entry(e,t){t.push(P(T({},e),{new_value:e.old_value,old_value:e.new_value}))}_apply_change(e){e.is_child?frappe.model.set_value(e.doctype,e.docname,e.fieldname,e.old_value):(this.frm.set_value(e.fieldname,e.old_value),this.frm.scroll_to_field(e.fieldname,!1))}_show_alert(e){frappe.show_alert(e,3)}};frappe.provide("frappe.ui.form");frappe.provide("frappe.model.docinfo");frappe.ui.form.Controller=class{constructor(e){$.extend(this,e)}};frappe.ui.form.Form=class{constructor(e,t,i,s){this.docname="",this.doctype=e,this.doctype_layout_name=s,this.in_form=!!i,this.hidden=!1,this.refresh_if_stale_for=120,this.opendocs={},this.custom_buttons={},this.sections=[],this.grids=[],this.cscript=new frappe.ui.form.Controller({frm:this}),this.events={},this.fetch_dict={},this.parent=t,this.doctype_layout=frappe.get_doc("DocType Layout",s),this.undo_manager=new E({frm:this}),this.setup_meta(e),this.debounced_reload_doc=frappe.utils.debounce(this.reload_doc.bind(this),1e3),this.beforeUnloadListener=a=>(a.preventDefault(),a.returnValue="There are unsaved changes, are you sure you want to exit?")}setup_meta(){this.meta=frappe.get_doc("DocType",this.doctype),this.meta.istable&&(this.meta.in_dialog=1),this.perm=frappe.perm.get_perm(this.doctype),this.action_perm_type_map={Create:"create",Save:"write",Submit:"submit",Update:"submit",Cancel:"cancel",Amend:"amend",Delete:"delete"}}setup(){this.fields=[],this.fields_dict={},this.state_fieldname=frappe.workflow.get_state_fieldname(this.doctype),this.wrapper=this.parent,this.$wrapper=$(this.wrapper);let e=this.doctype==="DocType"?!0:this.meta.hide_toolbar;frappe.ui.make_app_page({parent:this.wrapper,single_column:e}),this.page=this.wrapper.page,this.layout_main=this.page.main.get(0),this.$wrapper.on("hide",()=>{this.script_manager.trigger("on_hide")}),this.toolbar=new frappe.ui.form.Toolbar({frm:this,page:this.page}),this.viewers=new frappe.ui.form.FormViewers({frm:this,parent:$('<div class="form-viewers d-flex"></div>').prependTo(this.page.page_actions)}),this.add_form_keyboard_shortcuts(),this.setup_std_layout(),this.script_manager=new frappe.ui.form.ScriptManager({frm:this}),this.script_manager.setup(),this.watch_model_updates(),!this.meta.hide_toolbar&&frappe.boot.desk_settings.timeline&&(this.footer=new frappe.ui.form.Footer({frm:this,parent:$("<div>").appendTo(this.page.main.parent())}),$("body").attr("data-sidebar",1)),this.setup_file_drop(),this.setup_doctype_actions(),this.setup_notify_on_rename(),this.setup_done=!0}add_form_keyboard_shortcuts(){frappe.ui.keys.add_shortcut({shortcut:"shift+ctrl+>",action:()=>this.navigate_records(0),page:this.page,description:__("Go to next record"),ignore_inputs:!0,condition:()=>!this.is_new()}),frappe.ui.keys.add_shortcut({shortcut:"shift+ctrl+<",action:()=>this.navigate_records(1),page:this.page,description:__("Go to previous record"),ignore_inputs:!0,condition:()=>!this.is_new()}),frappe.ui.keys.add_shortcut({shortcut:"shift+ctrl+z",action:()=>this.undo_manager.redo(),page:this.page,description:__("Redo last action"),condition:()=>!this.is_form_builder()}),frappe.ui.keys.add_shortcut({shortcut:"ctrl+p",action:()=>this.print_doc(),description:__("Print document")}),[{shortcut:"Up Arrow",description:__("Move cursor to above row")},{shortcut:"Down Arrow",description:__("Move cursor to below row")},{shortcut:"tab",description:__("Move cursor to next column")},{shortcut:"shift+tab",description:__("Move cursor to previous column")},{shortcut:"Ctrl+up",description:__("Add a row above the current row")},{shortcut:"Ctrl+down",description:__("Add a row below the current row")},{shortcut:"Ctrl+shift+up",description:__("Add a row at the top")},{shortcut:"Ctrl+shift+down",description:__("Add a row at the bottom")},{shortcut:"shift+alt+down",description:__("Duplicate current row")}].forEach(t=>{frappe.ui.keys.add_shortcut({shortcut:t.shortcut,page:this.page,description:__(t.description),ignore_inputs:!0,condition:()=>!this.is_new()})})}setup_std_layout(){this.form_wrapper=$("<div></div>").appendTo(this.layout_main),this.body=$('<div class="std-form-layout"></div>').appendTo(this.form_wrapper),this.meta.section_style="Simple",this.layout=new frappe.ui.form.Layout({parent:this.body,doctype:this.doctype,doctype_layout:this.doctype_layout,frm:this,with_dashboard:!0,card_layout:!0}),this.layout.make(),this.fields_dict=this.layout.fields_dict,this.fields=this.layout.fields_list;let e=$('<div class="form-dashboard">'),t=!1;this.layout.tabs.length?(this.layout.tabs.every(i=>i.df.show_dashboard?(i.wrapper.prepend(e),t=!0,!1):!0),t||this.layout.tabs[0].wrapper.prepend(e)):this.layout.wrapper.find(".form-page").prepend(e),this.dashboard=new frappe.ui.form.Dashboard(e,this),this.tour=new frappe.ui.form.FormTour({frm:this}),this.states=new frappe.ui.form.States({frm:this})}watch_model_updates(){var e=this;frappe.model.on(e.doctype,"*",function(i,s,a,n=!1){if(a.name==e.docname){n||e.dirty();let o=e.fields_dict[i];return o&&o.refresh(i),o&&["Link","Dynamic Link"].includes(o.df.fieldtype)&&o.validate&&o.validate(s),e.layout.refresh_dependency(),e.layout.refresh_sections(),e.script_manager.trigger(i,a.doctype,a.name)}});var t=frappe.get_children("DocType",e.doctype,"fields",{fieldtype:["in",frappe.model.table_fields]});$.each(t,function(i,s){frappe.model.on(s.options,"*",function(a,n,o){if(o.parent==e.docname&&o.parentfield===s.fieldname)return e.dirty(),e.fields_dict[s.fieldname].grid.set_value(a,n,o),e.script_manager.trigger(a,o.doctype,o.name)})})}setup_notify_on_rename(){$(document).on("rename",(e,t,i,s)=>{t==this.doctype&&this.rename_notify(t,i,s)})}setup_file_drop(){var e=this;this.$wrapper.on("dragenter dragover",!1).on("drop",function(t){var i=t.originalEvent.dataTransfer;if(!!(i&&i.files&&i.files.length>0)){if(t.stopPropagation(),t.preventDefault(),e.doc.__islocal)throw frappe.msgprint(__("Please save before attaching.")),"attach error";new frappe.ui.FileUploader({doctype:e.doctype,docname:e.docname,frm:e,files:i.files,folder:"Home/Attachments",on_success(s){e.attachments.attachment_uploaded(s)}})}})}setup_image_autocompletions_in_markdown(){this.fields.map(e=>{e.df.fieldtype==="Markdown Editor"&&this.set_df_property(e.df.fieldname,"autocompletions",()=>this.attachments.get_attachments().filter(i=>frappe.utils.is_image_file(i.file_url)).map(i=>({caption:"image: "+i.file_name,value:`![](${i.file_url})`,meta:"image"})))})}refresh(e){var t=!!e;if(removeEventListener("beforeunload",this.beforeUnloadListener,{capture:!0}),e&&this.switch_doc(e),cur_frm=this,this.undo_manager.erase_history(),this.docname){if(this.save_disabled=!1,this.doc=frappe.get_doc(this.doctype,this.docname),this.fetch_permissions(),!this.has_read_permission()){frappe.show_not_permitted(__(this.doctype)+" "+__(cstr(this.docname)));return}if(this.grids.forEach(i=>{i.grid.refresh()}),this.read_only=frappe.workflow.is_read_only(this.doctype,this.docname),this.read_only&&(this.set_read_only(!0),frappe.show_alert(__("This form is not editable due to a Workflow."))),!this.opendocs[this.docname])this.check_doctype_conflict(this.docname);else if(this.check_reload())return;this.setup_done||this.setup(),this.trigger_onload(t),t&&this.show_print_first&&this.doc.docstatus===1&&this.print_doc(),this.$wrapper.removeClass("validated-form").toggleClass("editable-form",this.doc.docstatus===0).toggleClass("submitted-form",this.doc.docstatus===1).toggleClass("cancelled-form",this.doc.docstatus===2),this.show_conflict_message(),this.show_submission_queue_banner(),frappe.boot.read_only&&this.disable_form()}}setup_doctype_actions(){if(this.meta.actions)for(let e of this.meta.actions)frappe.ui.form.on(this.doctype,"refresh",()=>{this.is_new()||e.hidden||this.add_custom_button(e.label,()=>{this.execute_action(e)},e.group)})}execute_action(e){if(typeof e=="string"){for(let t of this.meta.actions)if(t.label===e){e=t;break}typeof e=="string"&&frappe.throw(`Action ${e} not found`)}if(e.action_type==="Server Action")return frappe.xcall(e.action,{doc:this.doc}).then(t=>{t.doctype&&(frappe.model.sync(t),this.refresh()),frappe.msgprint({message:__("{} Complete",[e.label]),alert:!0})});if(e.action_type==="Route")return frappe.set_route(e.action)}switch_doc(e){this.grids.forEach(t=>{t.grid.visible_columns=null,t.grid.grid_pagination.go_to_page(1,!0)}),frappe.ui.form.close_grid_form(),this.viewers&&this.viewers.parent.empty(),this.docname=e,this.setup_docinfo_change_listener()}check_reload(){if(this.doc&&!this.doc.__unsaved&&this.doc.__last_sync_on&&new Date-this.doc.__last_sync_on>this.refresh_if_stale_for*1e3)return this.debounced_reload_doc(),!0}trigger_onload(e){if(this.cscript.is_onload=!1,this.opendocs[this.docname])this.render_form(e),this.doc.localname&&(delete this.doc.localname,$(document).trigger("form-rename",[this]));else{var t=this;this.cscript.is_onload=!0,this.initialize_new_doc(),$(document).trigger("form-load",[this]),$(this.page.wrapper).on("hide",function(){$(document).trigger("form-unload",[t])})}}initialize_new_doc(){var e=this;this.script_manager.trigger("before_load",this.doctype,this.docname).then(()=>{e.script_manager.trigger("onload"),e.opendocs[e.docname]=!0,e.render_form(),frappe.after_ajax(function(){e.trigger_link_fields()}),frappe.breadcrumbs.add(e.meta.module,e.doctype)}),this.meta.track_seen&&$('.list-id[data-name="'+e.docname+'"]').addClass("seen")}render_form(e){this.meta.istable?this.refresh_header(e):(this.layout.doc=this.doc,this.layout.attach_doc_and_docfields(),frappe.boot.desk_settings.form_sidebar&&(this.sidebar=new frappe.ui.form.Sidebar({frm:this,page:this.page}),this.sidebar.make()),this.layout.show_message(),frappe.run_serially([()=>this.refresh_header(e),()=>$(document).trigger("form-refresh",[this]),()=>this.refresh_fields(),()=>this.script_manager.trigger("refresh"),()=>{if(this.cscript.is_onload)return this.onload_post_render(),this.script_manager.trigger("onload_post_render")},()=>this.cscript.is_onload&&this.is_new()&&this.focus_on_first_input(),()=>this.run_after_load_hook(),()=>this.dashboard.after_refresh()])),this.$wrapper.trigger("render_complete"),frappe.after_ajax(()=>{$(document).ready(()=>{this.scroll_to_element()})})}onload_post_render(){this.setup_image_autocompletions_in_markdown()}focus_on_first_input(){let e=this.layout.wrapper;!e||e.has(":focus").length||e.find(":input:visible:first").not("[data-fieldtype^='Date']").trigger("focus")}run_after_load_hook(){if(frappe.route_hooks.after_load){let e=frappe.route_hooks.after_load;delete frappe.route_hooks.after_load,e(this)}}refresh_fields(){this.layout.refresh(this.doc),this.layout.primary_button=this.$wrapper.find(".btn-primary"),this.cleanup_refresh(this)}cleanup_refresh(){if(this.fields_dict.amended_from&&(this.doc.amended_from?(unhide_field("amended_from"),this.fields_dict.amendment_date&&unhide_field("amendment_date")):(hide_field("amended_from"),this.fields_dict.amendment_date&&hide_field("amendment_date"))),this.fields_dict.trash_reason&&(this.doc.trash_reason&&this.doc.docstatus==2?unhide_field("trash_reason"):hide_field("trash_reason")),this.meta.autoname&&this.meta.autoname.substr(0,6)=="field:"&&!this.doc.__islocal){var e=this.meta.autoname.substr(6);this.doc[e]&&this.toggle_display(e,!1)}this.meta.autoname=="naming_series:"&&!this.doc.__islocal&&this.toggle_display("naming_series",!1)}refresh_header(e){(!this.meta.in_dialog||this.in_form)&&frappe.utils.set_title(this.meta.issingle?this.doctype:this.docname),this.toolbar&&(e&&(this.toolbar.current_status=void 0),this.toolbar.refresh()),this.viewers.refresh(),this.dashboard.refresh(),frappe.breadcrumbs.update(),this.show_submit_message(),this.clear_custom_buttons(),this.show_web_link()}save_or_update(){this.save_disabled||(this.doc.docstatus===0?this.save():this.doc.docstatus===1&&this.doc.__unsaved&&this.save("Update"))}save(e,t,i,s){let a=this;return new Promise((n,o)=>{i&&$(i).prop("disabled",!0),frappe.ui.form.close_grid_form(),a.validate_and_save(e,t,i,s,n,o)}).then(()=>{a.show_success_action()}).catch(n=>{console.error(n)})}validate_and_save(e,t,i,s,a,n){var o=this;e||(e="Save"),this.validate_form_action(e,a);var l=function(_){if(history.replaceState(null,null," "),_.exc)s&&(s(),n());else{if(["Save","Update","Amend"].indexOf(e)!==-1&&frappe.utils.play_sound("click"),o.script_manager.trigger("after_save"),frappe.route_hooks.after_save){let c=frappe.route_hooks.after_save;delete frappe.route_hooks.after_save,c(o)}o.comment_box&&o.comment_box.submit(),o.refresh()}t&&t(_),a()},d=_=>{_&&console.error(_),i&&$(i).prop("disabled",!1),s&&(s(),n())};e!="Update"?(frappe.validated=!0,frappe.run_serially([()=>this.script_manager.trigger("validate"),()=>this.script_manager.trigger("before_save"),()=>{if(!frappe.validated){d();return}frappe.ui.form.save(o,e,l,i)}]).catch(d)):frappe.ui.form.save(o,e,l,i)}savesubmit(e,t,i){var s=this;return new Promise(a=>{this.validate_form_action("Submit"),frappe.confirm(__("Permanently Submit {0}?",[this.docname]),function(){frappe.validated=!0,s.script_manager.trigger("before_submit").then(function(){if(!frappe.validated)return s.handle_save_fail(e,i);s.save("Submit",function(n){n.exc?s.handle_save_fail(e,i):(frappe.utils.play_sound("submit"),t&&t(),s.script_manager.trigger("on_submit").then(()=>a(s)).then(()=>{if(frappe.route_hooks.after_submit){let o=frappe.route_hooks.after_submit;delete frappe.route_hooks.after_submit,o(s)}}))},e,()=>s.handle_save_fail(e,i),a)})},()=>s.handle_save_fail(e,i))})}savecancel(e,t,i){let s=this;this.validate_form_action("Cancel"),s.ignore_doctypes_on_cancel_all=s.ignore_doctypes_on_cancel_all||[],frappe.call({method:"frappe.desk.form.linked_with.get_submitted_linked_docs",args:{doctype:s.doc.doctype,name:s.doc.name},freeze:!0}).then(a=>!a.exc&&(a.message.docs||[]).map(o=>o.doctype).filter(o=>!s.ignore_doctypes_on_cancel_all.includes(o)).length?s._cancel_all(a,e,t,i):s._cancel(e,t,i,!1))}_cancel_all(e,t,i,s){let a=this,n="",o=e.message.docs,l=Array.from(new Set(o.map(u=>u.doctype)));a.ignore_doctypes_on_cancel_all=a.ignore_doctypes_on_cancel_all||[];for(let u of l)if(!a.ignore_doctypes_on_cancel_all.includes(u)){let p=o.filter(h=>h.doctype==u).map(h=>frappe.utils.get_form_link(h.doctype,h.name,!0)).join(", ");n+=`<li><strong>${__(u)}</strong>: ${p}</li>`}n=`<ul>${n}</ul>`;let d=__("{0} {1} is linked with the following submitted documents: {2}",[__(a.doc.doctype).bold(),a.doc.name,n]),_=o.every(u=>frappe.model.can_cancel(u.doctype));_?d+=__("Do you want to cancel all linked documents?"):d+=__("You do not have permissions to cancel all linked documents.");let c=new frappe.ui.Dialog({title:__("Cancel All Documents"),fields:[{fieldtype:"HTML",options:`<p class="frappe-confirm-message">${d}</p>`}]},()=>a.handle_save_fail(t,s));_&&c.set_primary_action(__("Cancel All"),()=>{c.hide(),frappe.call({method:"frappe.desk.form.linked_with.cancel_all_linked_docs",args:{docs:o,ignore_doctypes_on_cancel_all:a.ignore_doctypes_on_cancel_all||[]},freeze:!0,callback:u=>{u.exc||(a.reload_doc(),a._cancel(t,i,s,!0))}})}),c.show()}_cancel(e,t,i,s){let a=this,n=()=>{frappe.validated=!0,a.script_manager.trigger("before_cancel").then(()=>{if(!frappe.validated)return a.handle_save_fail(e,i);var o=function(l){l.exc?a.handle_save_fail(e,i):(frappe.utils.play_sound("cancel"),a.refresh(),t&&t(),a.script_manager.trigger("after_cancel"))};frappe.ui.form.save(a,"cancel",o,e)})};s?n():frappe.confirm(__("Permanently Cancel {0}?",[this.docname]),n,a.handle_save_fail(e,i))}savetrash(){this.validate_form_action("Delete"),frappe.model.delete_doc(this.doctype,this.docname,function(){window.history.back()})}amend_doc(){if(!this.fields_dict.amended_from){frappe.msgprint(__('"amended_from" field must be present to do an amendment.'));return}frappe.xcall("frappe.client.is_document_amended",{doctype:this.doc.doctype,docname:this.doc.name}).then(e=>{e&&frappe.throw(__("This document is already amended, you cannot ammend it again")),this.validate_form_action("Amend");var t=this,i=function(s){s.amended_from=t.docname,t.fields_dict&&t.fields_dict.amendment_date&&(s.amendment_date=frappe.datetime.obj_to_str(new Date))};this.copy_doc(i,1),frappe.utils.play_sound("click")})}validate_form_action(e,t){var i=this.action_perm_type_map[e],s=!1,a=frappe.perm.get_perm(this.doc.doctype)[0];(frappe.workflow.is_read_only(this.doctype,this.docname)&&(a.write||a.create||a.submit||a.cancel)||!frappe.workflow.is_read_only(this.doctype,this.docname))&&(s=!0),!this.perm[0][i]&&!s&&(t&&t(),frappe.throw(__("No permission to '{0}' {1}",[__(e),__(this.doc.doctype)],"{0} = verb, {1} = object")))}enable_save(){this.save_disabled=!1,this.toolbar.set_primary_action()}disable_save(e=!1){this.save_disabled=!0,this.toolbar.current_status=null,this.set_dirty=e,this.page.clear_primary_action()}disable_form(){this.set_read_only(),this.fields.forEach(e=>{this.set_df_property(e.df.fieldname,"read_only","1")}),this.disable_save()}handle_save_fail(e,t){$(e).prop("disabled",!1),t&&t()}trigger_link_fields(){this.is_new()&&this.doc.__run_link_triggers&&($.each(this.fields_dict,function(e,t){t.df.fieldtype=="Link"&&this.doc[e]&&t.set_value(this.doc[e],!0)}),delete this.doc.__run_link_triggers)}show_conflict_message(){this.doc.__needs_refresh&&(this.doc.__unsaved?(this.dashboard.clear_headline(),this.dashboard.set_headline_alert(__("This form has been modified after you have loaded it")+'<button class="btn btn-xs btn-primary pull-right" onclick="cur_frm.reload_doc()">'+__("Refresh")+"</button>","alert-warning")):this.debounced_reload_doc())}show_submit_message(){this.meta.is_submittable&&this.perm[0]&&this.perm[0].submit&&!this.is_dirty()&&!this.is_new()&&!frappe.model.has_workflow(this.doctype)&&this.doc.docstatus===0&&this.dashboard.add_comment(__("Submit this document to confirm"),"blue",!0)}show_web_link(){!this.doc.__islocal&&this.doc.__onload&&this.doc.__onload.is_website_generator&&(this.web_link&&this.web_link.remove(),this.doc.__onload.published&&this.add_web_link("/"+this.doc.route))}add_web_link(e,t){t=__(t)||__("See on Website"),this.web_link=this.sidebar.add_user_action(__(t),function(){}).attr("href",e||this.doc.route).attr("target","_blank")}fetch_permissions(){let e=this.parent_doctype?this.parent_doctype:this.doctype;this.perm=frappe.perm.get_perm(e,this.doc)}has_read_permission(){return this.perm[0].read?1:0}check_doctype_conflict(e){this.doctype=="DocType"&&e=="DocType"?frappe.msgprint(__("Allowing DocType, DocType. Be careful!")):this.doctype=="DocType"?(frappe.views.formview[e]||frappe.pages["List/"+e])&&window.location.reload():frappe.views.formview.DocType&&frappe.views.formview.DocType.frm.opendocs[this.doctype]&&window.location.reload()}rename_notify(e,t,i){if(!this.meta.istable){if(this.docname==t)this.docname=i;else return;this&&this.opendocs[t]&&frappe.meta.docfield_copy[e]&&(frappe.meta.docfield_copy[e][i]=frappe.meta.docfield_copy[e][t],delete frappe.meta.docfield_copy[e][t]),delete this.opendocs[t],this.opendocs[i]=!0,!(this.meta.in_dialog||!this.in_form)&&(frappe.re_route[frappe.router.get_sub_path()]=`${encodeURIComponent(frappe.router.slug(this.doctype))}/${encodeURIComponent(i)}`,!frappe._from_link&&frappe.set_route("Form",this.doctype,i))}}print_doc(){frappe.route_options={frm:this},frappe.set_route("print",this.doctype,this.doc.name)}navigate_records(e){let t,i,s,a=frappe.get_list_view(this.doctype);if(a)t=a.get_filters_for_args(),i=a.sort_by,s=a.sort_order;else{let o=frappe.get_user_settings(this.doctype).List;o&&(t=o.filters,i=o.sort_by,s=o.sort_order)}let n={doctype:this.doctype,value:this.docname,filters:t,sort_order:s,sort_field:i,prev:e};frappe.call("frappe.desk.form.utils.get_next",n).then(o=>{o.message&&(frappe.set_route("Form",this.doctype,o.message),this.focus_on_first_input())})}rename_doc(){frappe.model.rename_doc(this.doctype,this.docname,()=>this.refresh_header())}share_doc(){this.shared.show()}email_doc(e){new frappe.views.CommunicationComposer({doc:this.doc,frm:this,subject:__(this.meta.name)+": "+this.docname,recipients:this.doc.email||this.doc.email_id||this.doc.contact_email,attach_document_print:!0,message:e})}copy_doc(e,t){this.validate_form_action("Create");var i=frappe.model.copy_doc(this.doc,t);i.idx=null,i.__run_link_triggers=!1,e&&e(i),frappe.set_route("Form",i.doctype,i.name)}reload_doc(){if(this.check_doctype_conflict(this.docname),!this.doc.__islocal)return frappe.model.remove_from_locals(this.doctype,this.docname),frappe.model.with_doc(this.doctype,this.docname,()=>{this.refresh()})}refresh_field(e){this.fields_dict[e]&&this.fields_dict[e].refresh&&(this.fields_dict[e].refresh(),this.layout.refresh_dependency(),this.layout.refresh_sections())}add_fetch(e,t,i,s){s||(s="*"),this.fetch_dict.setDefault(s,{}).setDefault(e,{})[i]=t}has_perm(e){return frappe.perm.has_perm(this.doctype,0,e,this.doc)}dirty(){this.doc.__unsaved=1,this.$wrapper.trigger("dirty"),frappe.boot.developer_mode||addEventListener("beforeunload",this.beforeUnloadListener,{capture:!0})}get_docinfo(){return frappe.model.docinfo[this.doctype][this.docname]}is_dirty(){return!!this.doc.__unsaved}is_new(){return this.doc.__islocal}is_form_builder(){return["DocType","Customize Form"].includes(this.doctype)&&this.get_active_tab().label=="Form"}get_perm(e,t){return this.perm[e]?this.perm[e][t]:null}set_intro(e,t){this.dashboard.set_headline_alert(e,t)}set_footnote(e){this.footnote_area=frappe.utils.set_footnote(this.footnote_area,this.body,e)}add_custom_button(e,t,i){i&&i.indexOf("fa fa-")!==-1&&(i=null);let s=this.page.add_inner_button(e,t,i);if(s){let a=i?`${i} > ${e}`:e;this.page.add_menu_item(a,t,!1).parent().addClass("hidden-xl"),this.custom_buttons[e]=s}return s}change_custom_button_type(e,t,i){this.page.change_inner_button_type(e,t,i)}clear_custom_buttons(){this.page.clear_inner_toolbar(),this.page.clear_user_actions(),this.custom_buttons={}}remove_custom_button(e,t){this.page.remove_inner_button(e,t)}scroll_to_element(){if(frappe.route_options&&frappe.route_options.scroll_to){var e=frappe.route_options.scroll_to;delete frappe.route_options.scroll_to;var t=[];for(var i in e){var s=e[i];t.push(repl('[data-%(key)s="%(value)s"]',{key:i,value:s}))}t=$(t.join(" ")),t.length&&frappe.utils.scroll_to(t)}else window.location.hash&&($(window.location.hash).length?frappe.utils.scroll_to(window.location.hash,!0,200,null,null,!0):this.scroll_to_field(window.location.hash.replace("#",""))&&history.replaceState(null,null," "))}show_success_action(){if(frappe.get_route()[0]!=="Form"||this.meta.is_submittable&&this.doc.docstatus!==1)return;new frappe.ui.form.SuccessAction(this).show()}get_doc(){return locals[this.doctype][this.docname]}set_currency_labels(e,t,i){if(!!t){var s=this,a=i?this.fields_dict[i].grid.doctype:this.doc.doctype,n={},o={};$.each(e,function(l,d){var _=frappe.meta.docfield_map[a][d];if(_){var c=__(_.label||"").replace(/\([^\)]*\)/g,"");i?o[a+"-"+d]=c.trim()+" ("+__(t)+")":n[d]=c.trim()+" ("+t+")"}}),$.each(n,function(l,d){s.fields_dict[l].set_label(d)}),$.each(o,function(l,d){l=l.split("-"),s.fields_dict[i].grid.update_docfield_property(l[1],"label",d)})}}field_map(e,t){typeof e=="string"&&(e=="*"?e=Object.keys(this.fields_dict):e=[e]);for(var i=0,s=e.length;i<s;i++){var a=e[i],n=frappe.meta.get_docfield(this.doctype,a,this.docname);n&&(t(n),this.refresh_field(a))}}get_docfield(e,t){if(t){var i=this.get_docfield(e).options;return frappe.meta.get_docfield(i,t,this.docname)}else return frappe.meta.get_docfield(this.doctype,e,this.docname)}set_df_property(e,t,i,s,a,n=null){let o;if(!s||!a)o=this.get_docfield(e);else{let l=this.fields_dict[e].grid,d=frappe.utils.filter_dict(l.docfields,{fieldname:a});d.length&&(o=frappe.meta.get_docfield(d[0].parent,a,n))}o&&o[t]!=i&&(o[t]=i,a&&n?this.fields_dict[e].grid.grid_rows_by_docname[n]&&this.fields_dict[e].grid.grid_rows_by_docname[n].refresh_field(a):this.refresh_field(e))}toggle_enable(e,t){this.field_map(e,function(i){i.read_only=t?0:1})}toggle_reqd(e,t){this.field_map(e,function(i){i.reqd=!!t})}toggle_display(e,t){this.field_map(e,function(i){i.hidden=t?0:1})}get_files(){return this.attachments?frappe.utils.sort(this.attachments.get_attachments(),"file_name","string"):[]}set_query(e,t,i){i?this.fields_dict[t].grid.get_field(e).get_query=i:this.fields_dict[e]&&(this.fields_dict[e].get_query=t)}clear_table(e){frappe.model.clear_table(this.doc,e)}add_child(e,t){var i=frappe.model.add_child(this.doc,frappe.meta.get_docfield(this.doctype,e).options,e);if(t){var s={},a=["idx","name"];Object.keys(t).map(n=>{a.includes(n)||(s[n]=t[n])}),$.extend(i,s)}return i}set_value(e,t,i,s=!1){var a=this,n=function(o,l){var d=a.fields_dict[o];if(d){if(!i||!frappe.model.has_value(a.doctype,a.doc.name,o))if(frappe.model.table_fields.includes(d.df.fieldtype)&&$.isArray(l)){frappe.model.clear_table(a.doc,d.df.fieldname);let _=[...frappe.model.std_fields_list,...frappe.model.child_table_field_list];return l.forEach((c,u)=>{let p=frappe.model.add_child(a.doc,d.df.options,d.df.fieldname,u+1),h=T({},c);_.forEach(f=>{delete h[f]}),$.extend(p,h)}),a.refresh_field(o),Promise.resolve()}else return frappe.model.set_value(a.doctype,a.doc.name,o,l,a.fieldtype,s)}else throw frappe.msgprint(__("Field {0} not found.",[o])),"frm.set_value"};if(typeof e=="string")return n(e,t);if($.isPlainObject(e)){let o=[];for(let l in e){let d=e[l];a.get_field(l)&&o.push(()=>n(l,d))}return frappe.run_serially(o)}}call(e,t,i){var s=this;return typeof e=="string"&&(e={method:e,doc:this.doc,args:t,callback:i}),e.doc?(e.original_callback=e.callback,e.callback=function(a){a.exc||s.refresh_fields(),e.original_callback&&e.original_callback(a)}):(e.method.indexOf(".")===-1&&(e.method=frappe.model.get_server_module_name(s.doctype)+"."+e.method),e.original_callback=e.callback,e.callback=function(a){if($.isPlainObject(a.message))if(e.child){e.child=locals[e.child.doctype][e.child.name];var n=["doctype"].concat(frappe.model.std_fields_list).concat(frappe.model.child_table_field_list);for(var o in a.message)n.indexOf(o)===-1&&(e.child[o]=a.message[o]);s.fields_dict[e.child.parentfield].refresh()}else s.set_value(a.message);e.original_callback&&e.original_callback(a)}),frappe.call(e)}get_field(e){return this.fields_dict[e]}set_read_only(){let e=frappe.perm.get_perm(this.doc.doctype);this.perm=e.map(t=>({read:t.read,cancel:t.cancel,share:t.share,print:t.print,email:t.email}))}trigger(e,t,i){return this.script_manager.trigger(e,t,i)}get_formatted(e){return frappe.format(this.doc[e],frappe.meta.get_docfield(this.doctype,e,this.docname),{no_icon:!0},this.doc)}open_grid_row(){return frappe.ui.form.get_open_grid_form()}get_title(){return this.meta.title_field?this.doc[this.meta.title_field]:String(this.doc.name)}get_selected(){var e={},t=this;return frappe.meta.get_table_fields(this.doctype).forEach(function(i){let s=[];t.fields_dict[i.fieldname].grid&&(s=t.fields_dict[i.fieldname].grid.get_selected()),s.length&&(e[i.fieldname]=s)}),e}set_indicator_formatter(e,t,i){var s;frappe.meta.docfield_map[this.doctype][e]?s=this.doctype:frappe.meta.get_table_fields(this.doctype).every(function(a){return frappe.meta.docfield_map[a.options][e]?(s=a.options,!1):!0}),frappe.meta.docfield_map[s][e].formatter=function(a,n,o,l){if(a){var d;i?d=i(l):frappe.form.link_formatters[n.options]?d=frappe.form.link_formatters[n.options](a,l):d=a;let _=encodeURIComponent(a);return`
						<a class="indicator ${t(l||{})}"
							href="/app/${frappe.router.slug(n.options)}/${_}"
							data-doctype="${n.options}"
							data-name="${frappe.utils.escape_html(a)}">
							${d}
						</a>
					`}else return""}}can_create(e){if(!frappe.model.can_create(e))return!1;if(this.custom_make_buttons&&this.custom_make_buttons[e]){let t=__(this.custom_make_buttons[e]);return!!this.custom_buttons[t]}return this.can_make_methods&&this.can_make_methods[e]?this.can_make_methods[e](this):!(this.meta.is_submittable&&!this.doc.docstatus==1)}make_new(e){let t=this;if(this.make_methods&&this.make_methods[e])return this.make_methods[e](this);this.custom_make_buttons&&this.custom_make_buttons[e]?this.custom_buttons[__(this.custom_make_buttons[e])].trigger("click"):frappe.model.with_doctype(e,function(){let i=frappe.model.get_new_doc(e,null,null,!0);t.set_link_field(e,i),frappe.ui.form.make_quick_entry(e,null,null,i)})}set_link_field(e,t){let i=this;frappe.get_meta(e).fields.forEach(function(s){if(s.fieldtype==="Link"&&s.options===i.doctype)t[s.fieldname]=i.doc.name;else if(["Link","Dynamic Link"].includes(s.fieldtype)&&i.doc[s.fieldname])t[s.fieldname]=i.doc[s.fieldname];else if(s.fieldtype==="Table"&&s.options&&s.reqd){let a=t[s.fieldname][0];i.set_link_field(s.options,a)}})}update_in_all_rows(e,t,i){i!==void 0&&frappe.model.get_children(this.doc,e).filter(s=>!frappe.model.has_value(s.doctype,s.name,t)).forEach(s=>frappe.model.set_value(s.doctype,s.name,t,i))}get_sum(e,t){let i=0;for(let s of this.doc[e]||[])i+=s[t];return i}scroll_to_field(e,t=!0){var n;let i=this.get_field(e);if(!i)return;let s=i.$wrapper;i.tab&&!i.tab.is_active()&&i.tab.set_active(),(n=i.section)!=null&&n.is_collapsed()&&i.section.collapse(!1),frappe.utils.scroll_to(s,!0,15),t&&setTimeout(()=>{s.find("input, select, textarea").focus()},500);let a=s.closest(".frappe-control");return a.addClass("highlight"),setTimeout(()=>{a.removeClass("highlight")},2e3),!0}setup_docinfo_change_listener(){let e=this.doctype,t=this.docname;this.doc&&!this.is_new()&&frappe.realtime.doc_subscribe(e,t),frappe.realtime.off("docinfo_update"),frappe.realtime.on("docinfo_update",({doc:i,key:s,action:a="update"})=>{if(!i.reference_doctype||!i.reference_name||i.reference_doctype!==e||i.reference_name!==t)return;let o=(frappe.model.docinfo[e][t][s]||[]).findIndex(l=>l.name===i.name);a==="add"&&frappe.model.docinfo[e][t][s].push(i),o>-1&&(a==="update"&&frappe.model.docinfo[e][t][s].splice(o,1,i),a==="delete"&&frappe.model.docinfo[e][t][s].splice(o,1)),["add","update"].includes(a)&&i.doctype==="Comment"&&i.owner===frappe.session.user||this.timeline&&this.timeline.refresh()})}set_fields_as_options(e,t,i,s=[],a){if(!t)return Promise.resolve();let n=s||[];return i||(i=o=>o),new Promise(o=>{frappe.model.with_doctype(t,()=>{frappe.get_meta(t).fields.map(l=>{i(l)&&n.push({label:l.label||l.fieldname,value:l.fieldname})}),n&&this.set_df_property(e,"options",n,this.doc.name,a),o(n)})})}set_active_tab(e){this.active_tab_map||(this.active_tab_map={}),this.active_tab_map[this.docname]=e,this.script_manager.trigger("on_tab_change")}get_active_tab(){return this.active_tab_map&&this.active_tab_map[this.docname]}get_involved_users(){let e=this.meta.fields.filter(s=>s.fieldtype==="Link"&&s.options==="User").map(s=>s.fieldname);e=[...e,"owner","modified_by"];let t=e.map(s=>this.doc[s]),i=this.get_docinfo();return t=t.concat(i.communications.map(s=>s.sender&&s.delivery_status==="sent"),i.comments.map(s=>s.owner),i.versions.map(s=>s.owner),i.assignments.map(s=>s.owner)),t.uniqBy(s=>s).filter(s=>!["Administrator",frappe.session.user].includes(s)).filter(Boolean)}show_submission_queue_banner(){let e=this.layout.wrapper.find(".submission-queue-banner");if(!(this.meta.is_submittable&&this.meta.queue_in_background&&!this.doc.__islocal&&this.doc.docstatus===0)){e.length&&e.remove();return}e.length||(e=$('<div class="submission-queue-banner form-message">'),this.layout.wrapper.prepend(e)),frappe.call({method:"frappe.core.doctype.submission_queue.submission_queue.get_latest_submissions",args:{doctype:this.doctype,docname:this.docname}}).then(t=>{var i;if((i=t.message)!=null&&i.latest_submission){let s=__("Previous Submission"),a="",n="col-md-12";t.message.exc?a=`: <span>${t.message.exc}</span>`:(n="col-md-6",a=`
						</div>
						<div class="col-md-6">
							<a href='/app/submission-queue?ref_doctype=${encodeURIComponent(this.doctype)}&ref_docname=${encodeURIComponent(this.docname)}'>${__("All Submissions")}</a>
						`);let o=`
					<div class="row">
						<div class="${n}">
							<a href='/app/submission-queue/${t.message.latest_submission}'>${s} (${t.message.status})</a>${a}
						</div>
					</div>
					`;e.removeClass("red").removeClass("yellow"),e.addClass(t.message.status=="Failed"?"red":"yellow"),e.html(o)}else e.remove()})}};frappe.validated=0;frappe.provide("frappe.model");frappe.provide("frappe.utils");frappe.utils.set_meta_tag=function(r){frappe.db.exists("Website Route Meta",r).then(e=>{if(e)frappe.set_route("Form","Website Route Meta",r);else{let t=frappe.model.get_new_doc("Website Route Meta");t.__newname=r,frappe.set_route("Form",t.doctype,t.name)}})};frappe.provide("frappe.model");frappe.model.DocTypeController=class extends frappe.ui.form.Controller{setup(){frappe.meta.docfield_map[this.frm.doctype==="DocType"?"DocField":"Customize Form Field"].fieldtype.formatter=e=>{let t={"Tab Break":"--red-600","Section Break":"--blue-600","Column Break":"--yellow-600"};return t[e]&&(e=`<span class="bold" style="color: var(${t[e]})">${e}</span>`),e}}refresh(){this.show_db_utilization()}show_db_utilization(){let e=this.frm.doc.doc_type||this.frm.doc.name;frappe.xcall("frappe.core.doctype.doctype.doctype.get_row_size_utilization",{doctype:e}).then(t=>{t<50||this.frm.dashboard.show_progress(__("Database Row Size Utilization"),t,__("Database Table Row Size Utilization: {0}%, this limits number of fields you can add.",[t]))})}max_attachments(){if(!this.frm.doc.max_attachments)return;let e=i=>["Attach","Attach Image"].includes(i.fieldtype),t=this.frm.doc.fields.filter(e).length;if(t>this.frm.doc.max_attachments){this.frm.set_value("max_attachments",t);let i=this.frm.get_docfield("max_attachments").label;frappe.show_alert(__("Number of attachment fields are more than {}, limit updated to {}.",[i,t]))}}naming_rule(){if(this.frm.doc.naming_rule&&!this.frm.__from_autoname){this.frm.__from_naming_rule=!0;let e={Autoincrement:"autoincrement","Set by user":"prompt","By fieldname":"field:",'By "Naming Series" field':"naming_series:",Expression:"format:","Expression (sld style)":"",Random:"hash","By script":""};this.frm.set_value("autoname",e[this.frm.doc.naming_rule]||""),setTimeout(()=>this.frm.__from_naming_rule=!1,500),this.set_naming_rule_description()}}set_naming_rule_description(){let e={"Set by user":"",Autoincrement:"Uses Auto Increment feature of database.<br><b>WARNING: After using this option, any other naming option will not be accessible.</b>","By fieldname":"Format: <code>field:[fieldname]</code>. Valid fieldname must exist",'By "Naming Series" field':"Format: <code>naming_series:[fieldname]</code>. Default fieldname is <code>naming_series</code>",Expression:"Format: <code>format:EXAMPLE-{MM}morewords{fieldname1}-{fieldname2}-{#####}</code> - Replace all braced words (fieldnames, date words (DD, MM, YY), series) with their value. Outside braces, any characters can be used.","Expression (old style)":"Format: <code>EXAMPLE-.#####</code> Series by prefix (separated by a dot)",Random:"","By script":""};this.frm.doc.naming_rule&&this.frm.get_field("autoname").set_description(e[this.frm.doc.naming_rule])}autoname(){if(this.frm.doc.autoname&&!this.frm.doc.naming_rule&&!this.frm.__from_naming_rule){this.frm.__from_autoname=!0;let e=this.frm.doc.autoname.toLowerCase();e==="prompt"?this.frm.set_value("naming_rule","Set by user"):e==="autoincrement"?this.frm.set_value("naming_rule","Autoincrement"):e.startsWith("field:")?this.frm.set_value("naming_rule","By fieldname"):e.startsWith("naming_series:")?this.frm.set_value("naming_rule",'By "Naming Series" field'):e.startsWith("format:")?this.frm.set_value("naming_rule","Expression"):e==="hash"?this.frm.set_value("naming_rule","Random"):this.frm.set_value("naming_rule","Expression (old style)"),setTimeout(()=>this.frm.__from_autoname=!1,500)}}setup_fetch_from_fields(e,t,i){let s=this.frm,a=s.cur_grid.grid_form.fields_dict.fetch_from;$(a.input_area).hide();let n=$('<select class="form-control">'),o=$('<select class="form-control">'),l=$('<div class="fetch-from-select row"><div>');l.append(n,o),a.$input_wrapper.append(l),n.wrap('<div class="col"></div>'),o.wrap('<div class="col"></div>');let d=frappe.get_doc(t,i),_={doctype:null,fieldname:null};if(d.fetch_from){let[p,h]=d.fetch_from.split(".");_.doctype=p,_.fieldname=h}let c=s.doc.fields.filter(p=>p.fieldtype=="Link").filter(p=>p.options&&p.fieldname!=d.fieldname).sort((p,h)=>p.options.localeCompare(h.options)).map(p=>({label:`${p.options} (${p.fieldname})`,value:p.fieldname}));n.add_options([{label:__("Select DocType"),value:"",selected:!0},...c]),n.on("change",()=>{d.fetch_from="",s.dirty(),u()});function u(){o.find("option").remove();let p=n.val();if(!p)return;let f=s.doc.fields.find(m=>m.fieldname===p).options;frappe.model.with_doctype(f,()=>{let m=frappe.meta.get_docfields(f,null,{fieldtype:["not in",frappe.model.no_value_type]}).sort((v,w)=>v.label.localeCompare(w.label)).map(v=>({label:`${v.label} (${v.fieldtype})`,value:v.fieldname}));o.add_options([{label:__("Select Field"),value:"",selected:!0,disabled:!0},...m]),_.fieldname&&o.val(_.fieldname)})}o.on("change",()=>{let p=`${n.val()}.${o.val()}`;d.fetch_from=p,s.dirty()}),_.doctype&&(n.val(_.doctype),u())}};})();
//# sourceMappingURL=form.bundle.RY6DVVKT.js.map

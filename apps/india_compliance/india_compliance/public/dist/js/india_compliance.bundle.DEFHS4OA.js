(()=>{var D=Object.defineProperty,G=Object.defineProperties;var P=Object.getOwnPropertyDescriptors;var g=Object.getOwnPropertySymbols;var Z=Object.prototype.hasOwnProperty,U=Object.prototype.propertyIsEnumerable;var m=(e,t,i)=>t in e?D(e,t,{enumerable:!0,configurable:!0,writable:!0,value:i}):e[t]=i,y=(e,t)=>{for(var i in t||(t={}))Z.call(t,i)&&m(e,i,t[i]);if(g)for(var i of g(t))U.call(t,i)&&m(e,i,t[i]);return e},h=(e,t)=>G(e,P(t));var b="^[0-9]{2}[A-Z]{5}[0-9]{4}[A-Z]{1}[1-9A-Z]{1}[Z1-9ABD-J]{1}[0-9A-Z]{1}$",v="^[0-9]{2}[A-Z]{4}[0-9]{5}[A-Z]{1}[0-9]{1}[Z]{1}[0-9]{1}$",w="^[0-9]{4}[A-Z]{3}[0-9]{5}[N][R][0-9A-Z]{1}$",T="^[9][9][0-9]{2}[A-Z]{3}[0-9]{5}[O][S][0-9A-Z]{1}$",S="^[0-9]{4}[A-Z]{3}[0-9]{5}[UO]{1}[N][A-Z0-9]{1}$",L="^[0-9]{2}[A-Z]{4}[A-Z0-9]{1}[0-9]{4}[A-Z]{1}[1-9A-Z]{1}[D][0-9A-Z]$",k=new RegExp([b,v].join("|")),A=new RegExp([w,T].join("|")),E=new RegExp(S),I=new RegExp(L),R=new RegExp([b,v,w,T,S].join("|")),O=new RegExp("^[^\\W_][A-Za-z\\d\\-/]{0,15}$");frappe.provide("india_compliance");window.gst_settings=frappe.boot.gst_settings;Object.assign(india_compliance,{get_gstin_query(e,t="Company"){if(!e){frappe.show_alert({message:__("Please select {0} to get GSTIN options",[__(t)]),indicator:"yellow"});return}return{query:"india_compliance.gst_india.utils.get_gstin_list",params:{party:e,party_type:t}}},async get_gstin_options(e,t="Company"){let{query:i,params:a}=india_compliance.get_gstin_query(e,t),{message:n}=await frappe.call({method:i,args:a});return n},async get_account_options(e){if(!e)return;let{message:t}=await frappe.call({method:"india_compliance.gst_india.utils.get_all_gst_accounts",args:{company:e}});return t||[]},get_party_type(e){return in_list(frappe.boot.sales_doctypes,e)?"Customer":"Supplier"},async set_gstin_status(e,t,i=0){let a=e.value;if(!a||a.length!==15)return e.set_description("");let{message:n}=await frappe.call({method:"india_compliance.gst_india.doctype.gstin.gstin.get_gstin_status",args:{gstin:a,transaction_date:t,is_request_from_ui:1,force_update:i}});return n?(e.set_description(india_compliance.get_gstin_status_desc(n==null?void 0:n.status,n==null?void 0:n.last_updated_on)),this.set_gstin_refresh_btn(e,t),n):e.set_description("")},get_gstin_status_desc(e,t){if(!e)return;let i=frappe.datetime.str_to_user(t),a=frappe.datetime.prettyDate(t);return`<div class="d-flex indicator ${{Active:"green",Cancelled:"red"}[e]||"orange"}">
                    Status:&nbsp;<strong>${e}</strong>
                    <span class="text-right ml-auto gstin-last-updated">
                        <span title="${i}">
                            ${t?"updated "+a:""}
                        </span>
                    </span>
                </div>`},set_gstin_refresh_btn(e,t){if(!this.is_api_enabled()||gst_settings.sandbox_mode||!gst_settings.validate_gstin_status||e.$wrapper.find(".refresh-gstin").length)return;$(`
            <svg class="icon icon-sm refresh-gstin" style="">
                <use class="" href="#icon-refresh" style="cursor: pointer"></use>
            </svg>
        `).appendTo(e.$wrapper.find(".gstin-last-updated")).on("click",async function(){await india_compliance.set_gstin_status(e,t,1)})},set_state_options(e){let t=e.get_field("state");if(e.get_field("country").value!=="India"){t.set_data([]);return}t.set_data(frappe.boot.india_state_options||[])},can_enable_api(e){return e.api_secret||frappe.boot.ic_api_enabled_from_conf},is_api_enabled(e){return e||(e=gst_settings),e.enable_api&&india_compliance.can_enable_api(e)},is_e_invoice_enabled(){return india_compliance.is_api_enabled()&&gst_settings.enable_e_invoice},validate_gstin(e){if(!(!e||e.length!==15)&&(e=e.trim().toUpperCase(),R.test(e)&&j(e)))return e},get_gstin_otp(e,t){let i="An OTP has been sent to your registered mobile/email for further authentication. Please provide OTP.";return e==="invalid_otp"&&(i="Invalid OTP was provided. Please try again."),new Promise(a=>{let n=new frappe.ui.Dialog({title:__("Enter OTP"),fields:[{fieldtype:"Data",label:__("One Time Password"),fieldname:"otp",reqd:1,description:i}],primary_action_label:__("Submit"),primary_action(s){a(s.otp),n.hide()},secondary_action_label:__("Resend OTP"),secondary_action(){frappe.call({method:"india_compliance.gst_india.doctype.purchase_reconciliation_tool.purchase_reconciliation_tool.resend_otp",args:{company_gstin:t},callback:function(){frappe.show_alert({message:__("OTP has been resent."),indicator:"green"}),n.get_secondary_btn().addClass("disabled")}})}});n.show()})},guess_gst_category(e,t){if(!e)return t&&t!=="India"?"Overseas":"Unregistered";if(I.test(e))return"Tax Deductor";if(k.test(e))return"Registered Regular";if(E.test(e))return"UIN Holders";if(A.test(e))return"Overseas"},set_hsn_code_query(e){!e||!gst_settings.validate_hsn_code||(e.get_query=function(){let t="_".repeat(gst_settings.min_hsn_digits)+"%";return{filters:{name:["like",t]}}})},set_reconciliation_status(e,t){if(!e.doc.docstatus===1||!e.doc.reconciliation_status)return;let a={Reconciled:"green",Unreconciled:"red",Ignored:"grey","Not Applicable":"grey"}[e.doc.reconciliation_status];e.get_field(t).set_description(`<div class="d-flex indicator ${a}">
                2A/2B Status:&nbsp;<strong>${e.doc.reconciliation_status}</strong>
            </div>`)},validate_invoice_number(e){e.length>16&&frappe.throw(__("GST Invoice Number cannot exceed 16 characters"),__("Invalid GST Invoice Number")),O.test(e)||frappe.throw(__("GST Invoice Number should start with an alphanumeric character and can only contain alphanumeric characters, dash (-) and slash (/)"),__("Invalid GST Invoice Number"))},trigger_file_download(e,t){let i="application/json;charset=utf-8";t.endsWith(".json")||(i="application/octet-stream");let a=new Blob([e],{type:i}),n=document.createElement("a");n.style.display="none",n.href=URL.createObjectURL(a),n.download=t,document.body.appendChild(n),n.click(),setTimeout(()=>{URL.revokeObjectURL(n.href),n.parentNode.removeChild(n)},0)},set_last_month_as_default_period(e){e.filters.forEach(t=>{t.fieldname==="from_date"&&(t.default=this.last_month_start()),t.fieldname==="to_date"&&(t.default=this.last_month_end())})},last_month_start(){return frappe.datetime.add_months(frappe.datetime.month_start(),-1)},last_month_end(){return frappe.datetime.add_days(frappe.datetime.month_start(),-1)},primary_to_danger_btn(e){e.$wrapper.find(".btn-primary").removeClass("btn-primary").addClass("btn-danger")},add_divider_to_btn_group(e){$(document).find(`.inner-group-button[data-label=${e}]`).find(".dropdown-menu").append($('<li class="dropdown-divider"></li>'))},make_text_red(e,t){$(document).find(`.inner-group-button[data-label=${e}]`).find(`.dropdown-item[data-label="${encodeURIComponent(t)}"]`).addClass("text-danger")}});function j(e){let t="0123456789ABCDEFGHIJKLMNOPQRSTUVWXYZ",i=t.length,a=2,n=0;for(let o=e.length-2;o>=0;o--){let r=-1;for(let d=0;d<t.length;d++)t[d]===e[o]&&(r=d);let _=a*r;a=a===2?1:2,_=Math.floor(_/i)+_%i,n+=_}let s=(i-n%i)%i;return t[s]===e[14]}window.ic=window.india_compliance;var l=class extends frappe.ui.form.QuickEntryForm{constructor(...t){super(...t),this.skip_redirect_on_error=!0,this.api_enabled=india_compliance.is_api_enabled()&&gst_settings.autofill_party_info}async setup(){await frappe.model.with_doctype("Address"),super.setup()}render_dialog(){super.render_dialog(),india_compliance.set_state_options(this.dialog)}get_address_fields(){return[{label:__("Primary Address Details"),fieldname:"primary_address_section",fieldtype:"Section Break",description:this.api_enabled?__(`When you enter a GSTIN, the permanent address linked to it is
                        autofilled.<br>
                        Change the {0} to autofill other addresses.`,[frappe.meta.get_label("Address","pincode")]):"",collapsible:0},{fieldname:"_pincode",fieldtype:"Autocomplete",ignore_validation:!0},{fieldname:"address_line1",fieldtype:"Data"},{fieldname:"address_line2",fieldtype:"Data"},{fieldtype:"Column Break"},{fieldname:"city",fieldtype:"Data"},{fieldname:"state",fieldtype:"Autocomplete",ignore_validation:!0},{fieldname:"country",fieldtype:"Link",options:"Country",default:frappe.defaults.get_user_default("country"),onchange:()=>{india_compliance.set_state_options(this.dialog)}}]}get_gstin_field(){return[h(y({},frappe.meta.get_docfield(this.doctype,"gstin")),{fieldname:"_gstin",fieldtype:"Autocomplete",description:this.api_enabled?C():"",ignore_validation:!0,onchange:()=>{let t=this.dialog;if(this.api_enabled&&!gst_settings.sandbox_mode)return q(t);t.set_value("gst_category",india_compliance.guess_gst_category(t.doc._gstin,t.doc.country))}})]}update_doc(){let t=super.update_doc();return t.pincode=t._pincode,t.gstin=t._gstin,t}},c=class extends l{get_address_fields(){let t=super.get_address_fields();for(let i of t){let a=i.fieldname==="_pincode"?"pincode":i.fieldname;!i.label&&a&&(i.label=frappe.meta.get_label("Address",a))}return t}render_dialog(){this.mandatory=[...this.get_gstin_field(),...this.mandatory,...this.get_contact_fields(),...this.get_address_fields()],this.doctype==="Customer"&&this.mandatory.push({label:__("Customer POS ID"),fieldname:"customer_pos_id",fieldtype:"Data",hidden:1}),super.render_dialog()}get_contact_fields(){return[{label:__("Primary Contact Details"),fieldname:"primary_contact_section",fieldtype:"Section Break",collapsible:0},{label:__("Email ID"),fieldname:"_email_id",fieldtype:"Data",options:"Email"},{fieldtype:"Column Break"},{label:__("Mobile Number"),fieldname:"_mobile_no",fieldtype:"Data"}]}update_doc(){let t=super.update_doc();return t._address_line1=t.address_line1,delete t.address_line1,t.email_id=t._email_id,t.mobile_no=t._mobile_no,t}};frappe.ui.form.CustomerQuickEntryForm=c;frappe.ui.form.SupplierQuickEntryForm=c;var p=class extends l{get_address_fields(){let t=super.get_address_fields(),i=t.find(a=>a.fieldname==="_pincode");for(let[a,n]of Object.entries(frappe.meta.get_docfield("Address","pincode")))i[a]===void 0&&(i[a]=n);return t}async render_dialog(){let t=this.get_address_fields(),i=t.map(({fieldname:a})=>a);i.push("pincode","address_line1"),this.mandatory=[...this.get_dynamic_link_fields(),...this.get_gstin_field(),...this.mandatory.filter(a=>!i.includes(a.fieldname)),...t],super.render_dialog(),this.set_default_values()}get_dynamic_link_fields(){return[{fieldname:"link_doctype",fieldtype:"Link",label:"Link Document Type",options:"DocType",get_query:()=>({query:"frappe.contacts.address_and_contact.filter_dynamic_link_doctypes",filters:{fieldtype:"HTML",fieldname:"address_html"}}),onchange:async()=>{let{value:t,last_value:i}=this.dialog.get_field("link_doctype");t!==i&&await this.dialog.set_value("link_name","")}},{fieldtype:"Column Break"},{fieldname:"link_name",fieldtype:"Dynamic Link",label:"Link Name",get_options:t=>t.doc.link_doctype,onchange:async()=>{let{link_doctype:t,link_name:i}=this.dialog.doc;if(!i||!in_list(frappe.boot.gst_party_types,t))return;let{message:a}=await frappe.call("india_compliance.gst_india.utils.get_gstin_list",{party_type:t,party:i});!a||!a.length||this.dialog.fields_dict._gstin.set_data(a.join(`
`))}},{fieldtype:"Section Break"}]}update_doc(){let t=super.update_doc();if(t.link_doctype&&t.link_name){let i=frappe.model.add_child(t,"Dynamic Link","links");i.link_doctype=t.link_doctype,i.link_name=t.link_name}return t}async set_default_values(){let t=this.guess_default_party();t&&t.party&&(await this.dialog.set_value("link_doctype",t.party_type),this.dialog.set_value("link_name",t.party))}guess_default_party(){let t=cur_frm&&cur_frm.doc;if(!t||![...frappe.boot.sales_doctypes,...frappe.boot.purchase_doctypes,"Customer","Supplier","Company"].includes(t.doctype))return;let i=t.doctype,a=t.name;return frappe.dynamic_link&&frappe.dynamic_link.doc===t&&(i=frappe.dynamic_link.doctype,a=frappe.dynamic_link.doc[frappe.dynamic_link.fieldname]),{party_type:i,party:a}}};frappe.ui.form.AddressQuickEntryForm=p;var u=class extends frappe.ui.form.QuickEntryForm{render_dialog(){super.render_dialog(),india_compliance.set_hsn_code_query(this.dialog.get_field("gst_hsn_code"))}};frappe.ui.form.ItemQuickEntryForm=u;async function q(e){let t=e.doc._gstin,i=e.get_field("_gstin");if(!t||t.length!==15){let n=e.fields_dict._pincode;n.set_data([]),n.df.onchange=null,i.set_description(C());return}let a=await X(t);B(i,a.status),Q(e.doc,a),e.refresh(),M(e,a)}function B(e,t){if(!t){e.set_description("");return}e.set_description(india_compliance.get_gstin_status_desc(t))}function M(e,t){if(!t.all_addresses)return;let i=e.fields_dict._pincode;i.set_data(t.all_addresses.map(a=>({label:a.pincode,value:a.pincode,description:`${a.address_line1}, ${a.address_line2}, ${a.city}, ${a.state}`}))),i.df.onchange=()=>{V(e.doc,t),e.refresh()}}function X(e,t=!0){return frappe.call({method:"india_compliance.gst_india.utils.gstin_info.get_gstin_info",args:{gstin:e,throw_error:t}}).then(i=>i.message)}function Q(e,t){!t||(F(e,t),t.permanent_address&&x(e,t.permanent_address))}function F(e,t){if(e.gstin=e._gstin,e.gst_category=t.gst_category,!in_list(frappe.boot.gst_party_types,e.doctype))return;let i=`${e.doctype.toLowerCase()}_name`;e[i]=t.business_name}function x(e,t){!t||(Object.assign(e,t),e._pincode=t.pincode)}function V(e,{all_addresses:t}){let{_pincode:i}=e;!i||i.length!==6||!t||x(e,t.find(a=>a.pincode==i))}function C(){return gst_settings.sandbox_mode?__("Autofill is not supported in sandbox mode"):__("Autofill party information by entering their GSTIN")}frappe.provide("india_compliance");var W=["Quotation","Sales Order","Delivery Note","Sales Invoice","Purchase Order","Purchase Receipt","Purchase Invoice"];for(let e of W)Y(e),J(e),te(e);for(let e of["Sales Invoice","Delivery Note"])K(e);function Y(e){let t=["tax_category","company_gstin","place_of_supply","is_reverse_charge"];in_list(frappe.boot.sales_doctypes,e)?t.push("customer_address","is_export_with_gst"):t.push("supplier_address");let i=Object.fromEntries(t.map(a=>[a,n=>H(n,a)]));frappe.ui.form.on(e,i)}async function H(e,t){if(e.updating_party_details||!e.doc.company||t==="place_of_supply"&&e.__updating_gst_details)return;let i=india_compliance.get_party_type(e.doc.doctype).toLowerCase(),a=e.doc.doctype==="Quotation"?"party_name":i,n=e.doc[a];if(!n||(in_list(["company_gstin","customer_address","supplier_address"],t)&&(e.__update_place_of_supply=!0),e.__gst_update_triggered))return;e.__gst_update_triggered=!0;let s={doctype:e.doc.doctype,company:e.doc.company};await frappe.after_ajax(),e.__gst_update_triggered=!1,e.__update_place_of_supply&&(s.update_place_of_supply=1,e.__update_place_of_supply=!1);let o={};(e.doc.doctype!=="Quotation"||e.doc.party_type==="Customer")&&(o[i]=n);let r=["tax_category","gst_category","company_gstin","place_of_supply","is_reverse_charge"];in_list(frappe.boot.sales_doctypes,e.doc.doctype)?r.push("customer_address","billing_address_gstin","is_export_with_gst"):r.push("supplier_address","supplier_gstin");for(let _ of r)o[_]=e.doc[_];s.party_details=JSON.stringify(o),india_compliance.fetch_and_update_gst_details(e,s)}india_compliance.fetch_and_update_gst_details=function(e,t,i){frappe.call({method:i||"india_compliance.gst_india.overrides.transaction.get_gst_details",args:t,async callback(a){!a.message||(e.__updating_gst_details=!0,await e.set_value(a.message),e.__updating_gst_details=!1)}})};function J(e){frappe.ui.form.on(e,{gst_category(t){let{enable_overseas_transactions:i}=gst_settings;!z(t)||i||frappe.throw(__("Please enable SEZ / Overseas transactions in GST Settings first"))}})}function z(e){return e.doc.gst_category==="SEZ"?!0:frappe.boot.sales_doctypes?ee(e):e.doc.gst_category==="Overseas"}function K(e){frappe.ui.form.on(e,{onload(t){t.set_df_property("port_code","ignore_validation",1)}})}function ee(e){return e.doc.gst_category==="Overseas"&&e.doc.place_of_supply==="96-Other Countries"}function te(e){let t=frappe.boot.sales_doctypes.includes(e)?"billing_address_gstin":"supplier_gstin";frappe.ui.form.on(e,{refresh(i){i.doc[t]&&N(i,t)},[t](i){f(i,t)},posting_date(i){i.get_field("posting_date")&&f(i,t)},transaction_date(i){i.get_field("transaction_date")&&f(i,t)}})}async function f(e,t){let i=await N(e,t);!i||ie(i,e,t)}async function N(e,t){var o;let i=e.get_field(t),a=i.value,n=e.get_field("posting_date")||e.get_field("transaction_date"),s=(o=e._gstin_doc)==null?void 0:o[a];return s?i.set_description(india_compliance.get_gstin_status_desc(s==null?void 0:s.status,s==null?void 0:s.last_updated_on)):(s=await india_compliance.set_gstin_status(i,n.value),e._gstin_doc=e._gstin_doc||{},e._gstin_doc[a]=s),s}function ie(e,t,i){if(!gst_settings.validate_gstin_status)return;let a=t.get_field("posting_date")||t.get_field("transaction_date"),n=t.get_field(i),s=frappe.datetime.str_to_obj(a.value),o=frappe.datetime.str_to_obj(e.registration_date),r=frappe.datetime.str_to_obj(e.cancelled_date);(!o||s<o)&&frappe.throw({message:__("{0} is Registered on {1}. Please make sure that the {2} is on or after {1}",[n.df.label,frappe.datetime.str_to_user(e.registration_date),a.df.label]),title:__("Invalid Party GSTIN")}),e.status==="Cancelled"&&s>=r&&frappe.throw({message:__("{0} is Cancelled from {1}. Please make sure that the {2} is before {1}",[n.df.label,frappe.datetime.str_to_user(e.cancelled_date),a.df.label]),title:__("Invalid Party GSTIN")}),["Active","Cancelled"].includes(e.status)||frappe.throw({message:__("Status of {0} is {1}",[n.df.label,e.status]),title:__("Invalid GSTIN Status")})}$(document).on("app_ready",async function(){if(!frappe.boot.needs_audit_trail_notification)return;await new Promise(t=>setTimeout(t,700));let e=frappe.msgprint({title:__("Configure Audit Trail"),indicator:"orange",message:__(`Dear India Compliance User,
            <br><br>

            In accordance with
            <a
              href='https://www.mca.gov.in/Ministry/pdf/AccountsAmendmentRules_24032021.pdf'
              target='_blank'
            >MCA Notification dated 24-03-2021</a>,
            all companies registered in India are required to maintain an Audit Trail
            of each and every transaction and creating an edit log of each change made
            in books of account w.e.f 1st April 2023.
            <br><br>
            To comply with this requirement, we have introduced a new setting called
            <strong>Enable Audit Trail</strong> in Accounts Settings.
            <br><br>
            <strong>Note:</strong>
            <ul>
                <li>Once this setting is enabled, it cannot be disabled.</li>
                <li>
                Enabling this setting will cause the following accounts setting
                to get disabled to ensure Audit Trail integrity:<br>
                <strong>
                Delete Accounting and Stock Ledger Entries on deletion of Transaction
                </strong>
                </li>
            </ul>


            Would you like to enable the same?`)});e.set_primary_action(__("Enable Audit Trail"),()=>{frappe.call({method:"india_compliance.audit_trail.utils.enable_audit_trail",callback(t){t.exc||frappe.show_alert({message:__("Audit Trail Enabled"),indicator:"green"})}}),e.hide()}),e.set_secondary_action_label(__("Review Accounts Settings")),e.set_secondary_action(()=>{frappe.set_route("Form","Accounts Settings"),e.hide()}),e.onhide=()=>{frappe.xcall("india_compliance.audit_trail.utils.disable_audit_trail_notification")}});$(document).on("app_ready",async function(){if(!frappe.boot.needs_item_tax_template_notification)return;await new Promise(t=>setTimeout(t,700));let e=frappe.msgprint({title:__("\u{1F6A8} Important: Changes to Item Tax Template"),indicator:"orange",message:__(`Dear India Compliance User,
            <br><br>

            We are pleased to inform you about a recent update on how Item Tax Templates are
            maintained in India Compliance App.
            <br><br>

            Migration Guide:
            <a
                href='https://docs.indiacompliance.app/docs/developer-guide/migration-guide#item-tax-templates'
                target='_blank'
            >Migrating Item Tax Template</a>
            <br><br>

            <strong>Breaking Change:</strong>
            <ul>
                <li>GST Category for Nil-Rated, Exempted and Non-GST is introduced in Item Tax Template</li>
                <li>Nil-Rated items are differentiated from Exempted for GST (configrable from Item Tax Template)</li>
                <li><strong>Assumption Made:</strong> All transactions that were marked as Nil or Exempt,
                are now marked as Nil-Rated.</li>
            </ul>

            <strong>Note:</strong>
            If the above assumptions are not valid for your organization, please update item tax templates
            accordingly for your items.
            `)});e.onhide=()=>{frappe.xcall("india_compliance.gst_india.utils.disable_item_tax_template_notification")}});frappe.provide("india_compliance");india_compliance.quick_info_popover=class{constructor(t,i){this.frm=t,this.field_dict=i,this.make()}make(){this.create_info_popover()}create_info_popover(){if(!!this.field_dict)for(let[t,i]of Object.entries(this.field_dict)){if(this.create_info_icon(t),!this.info_btn)return;this.info_btn.popover({trigger:"hover",placement:"top",content:()=>this.get_content_html(t,i),html:!0})}}create_info_icon(t){let i=this.frm.get_field(t).$wrapper.find(".clearfix");this.info_btn=$('<i class="fa fa-info-circle"></i>').appendTo(i)}get_content_html(t,i){let a=frappe.meta.get_label(this.frm.doctype,t);return`
			<div class="quick-info-popover">
				<div class="preview-field">
					<div class="preview-label text-muted">${__(a)}</div>
					<hr>
					<div class="preview-value">${i}</div>
				</div>
			`}};})();
//# sourceMappingURL=india_compliance.bundle.DEFHS4OA.js.map
